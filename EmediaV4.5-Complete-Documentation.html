<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EMedia V4.5 – Complete Documentation (Event‑Driven Edition)</title>
    <meta name="description"
        content="Comprehensive event-driven documentation for EMedia V4.5: architecture, domain events, backlog, stored procedures, test suites, and operational guidance." />
    <style>
        html {
            scroll-behavior: smooth;
        }

        :root {
            --bg: #0f1f26;
            --nav-bg: #0f1f26;
            --bg-alt: #ffffff;
            --bg-panel: #ffffff;
            --bg-panel-alt: #f4f7f9;
            --text: #18242b;
            --text-alt: #4a5d66;
            --accent: #007a4d;
            --accent-accent: #ffb300;
            --accent-grad: linear-gradient(135deg, #008851, #00b56b);
            --radius: 10px;
            --shadow: 0 4px 18px rgba(0, 0, 0, .12);
            --mono: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
            --font: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Ubuntu', 'Helvetica Neue', sans-serif;
        }

        [data-theme="dark"] {
            --bg: #091318;
            --nav-bg: #091318;
            --bg-alt: #0f1d24;
            --bg-panel: #162830;
            --bg-panel-alt: #1f3943;
            --text: #e5eef1;
            --text-alt: #a4bbc3;
            --accent: #00b76b;
            --accent-accent: #ffd34d;
            --accent-grad: linear-gradient(135deg, #00b76b, #00e083);
            --shadow: 0 4px 22px rgba(0, 0, 0, .6);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--font);
            background: var(--bg-alt);
            color: var(--text);
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        header.hero {
            padding: 3.5rem 1.25rem 2.25rem;
            background: linear-gradient(130deg, #003b25, #032a34 65%, #001c29);
            color: #fff;
            position: relative;
            overflow: hidden;
        }

        header.hero:before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 18% 22%, rgba(0, 255, 170, .18), transparent 60%), radial-gradient(circle at 78% 68%, rgba(255, 196, 0, .18), transparent 55%);
            mix-blend-mode: overlay;
        }

        header.hero h1 {
            margin: 0 0 .5rem;
            font-weight: 300;
            font-size: 2.65rem;
            letter-spacing: .5px;
        }

        header.hero p.sub {
            margin: .35rem 0 0;
            font-size: 1.05rem;
            opacity: .9;
            max-width: 940px;
        }

        .version-badge {
            display: inline-block;
            background: rgba(255, 255, 255, .12);
            backdrop-filter: blur(6px);
            padding: .35rem .7rem;
            font-size: .65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 16px;
            font-weight: 600;
            margin-right: .6rem;
        }

        .actions-hero {
            margin-top: 1.2rem;
            display: flex;
            gap: .75rem;
            flex-wrap: wrap;
        }

        .btn {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-size: .8rem;
            padding: .75rem 1rem;
            letter-spacing: .5px;
            font-weight: 600;
            background: var(--accent-grad);
            color: #fff;
            box-shadow: 0 3px 10px -2px rgba(0, 0, 0, .4);
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            transition: .25s;
        }

        .btn.secondary {
            background: var(--bg-panel);
            color: var(--text);
            box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
        }

        .btn.outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, .55);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .layout {
            display: flex;
            align-items: stretch;
        }

        nav#toc {
            width: 270px;
            flex: 0 0 270px;
            padding: 1.25rem 1rem 3rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: auto;
            background: var(--bg);
            border-right: 1px solid rgba(255, 255, 255, .06);
        }

        .layout {
            padding-left: 0;
        }

        nav#toc h3 {
            margin: .25rem 0 1rem;
            font-size: .75rem;
            font-weight: 600;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--accent-accent);
        }

        nav#toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: .35rem;
        }

        nav#toc a {
            text-decoration: none;
            font-size: .72rem;
            line-height: 1.3;
            padding: .45rem .6rem;
            color: var(--text-alt);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: .4rem;
            font-weight: 500;
            letter-spacing: .4px;
            white-space: nowrap;
            overflow: hidden;
        }

        nav#toc a .toc-label {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        nav#toc a .toc-index {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 32px;
            text-align: center;
            font-weight: 600;
            font-size: .63rem;
            background: rgba(255, 255, 255, .08);
            color: var(--accent-accent);
            padding: .18rem 0;
            border-radius: 5px;
            letter-spacing: .6px;
            flex: 0 0 32px;
        }

        nav#toc a .toc-label {
            flex: 1;
        }

        nav#toc a.active {
            background: linear-gradient(90deg, var(--accent) 0%, transparent 95%);
            color: #fff;
            font-weight: 600;
        }

        nav#toc a:hover {
            background: rgba(255, 255, 255, .07);
            color: #fff;
        }

        main#content {
            flex: 1;
            min-width: 0;
            padding: 2.2rem clamp(.9rem, 2.5vw, 2.5rem) 5rem;
        }

        section.doc-section {
            margin: 0 0 3.5rem;
            position: relative;
            scroll-margin-top: 90px;
        }

        section.doc-section:last-of-type {
            margin-bottom: 6rem;
        }

        section.doc-section h2 {
            margin: 0 0 1rem;
            font-size: 1.6rem;
            font-weight: 500;
            letter-spacing: .5px;
            display: flex;
            align-items: center;
            gap: .6rem;
        }

        section.doc-section h2 .sec-index {
            font-size: .8rem;
            background: var(--accent);
            color: #fff;
            padding: .2rem .55rem;
            border-radius: 5px;
            font-weight: 600;
            letter-spacing: .75px;
        }

        section.doc-section h3 {
            margin: 2.2rem 0 .75rem;
            font-size: 1.05rem;
            letter-spacing: .4px;
            font-weight: 600;
        }

        p.lead {
            font-size: 1.02rem;
            line-height: 1.5;
            max-width: 940px;
        }

        .panel {
            background: var(--bg-panel);
            border-radius: var(--radius);
            padding: 1.1rem 1.1rem 1.25rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .panel.alt {
            background: var(--bg-panel-alt);
        }

        .grid {
            display: grid;
            gap: 1.2rem;
        }

        .grid.cols-3 {
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        .metric-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1rem 1.1rem 1.15rem;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: .35rem;
            box-shadow: var(--shadow);
        }

        .metric-card h4 {
            margin: 0;
            font-size: .68rem;
            letter-spacing: 1px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: .65;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: .5px;
        }

        .metric-card .sub {
            font-size: .6rem;
            letter-spacing: .8px;
            text-transform: uppercase;
            opacity: .55;
        }

        code,
        pre {
            font-family: var(--mono);
            font-size: .75rem;
        }

        pre {
            background: var(--bg-panel-alt);
            padding: .85rem 1rem;
            border-radius: 8px;
            overflow: auto;
            line-height: 1.35;
            border: 1px solid rgba(0, 0, 0, .08);
        }

        [data-theme="dark"] pre {
            background: #0e232b;
            border: 1px solid #14323d;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: .72rem;
        }

        table th {
            text-align: left;
            padding: .55rem .6rem;
            background: var(--bg-panel-alt);
            position: sticky;
            top: 0;
            font-size: .58rem;
            letter-spacing: .85px;
            text-transform: uppercase;
            font-weight: 600;
            border-bottom: 1px solid rgba(0, 0, 0, .08);
        }

        table td {
            padding: .5rem .6rem;
            vertical-align: top;
            border-bottom: 1px solid rgba(0, 0, 0, .04);
        }

        .sticky-notice {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pill {
            display: inline-block;
            padding: .2rem .55rem;
            border-radius: 14px;
            font-size: .55rem;
            font-weight: 600;
            letter-spacing: .5px;
            background: var(--accent);
            color: #fff;
        }

        .pill.alt {
            background: var(--accent-accent);
            color: #173000;
        }

        .tag {
            display: inline-block;
            background: rgba(0, 0, 0, .08);
            padding: .22rem .5rem;
            font-size: .55rem;
            border-radius: 12px;
            font-weight: 500;
            letter-spacing: .4px;
            margin: .15rem .25rem .15rem 0;
        }

        [data-theme="dark"] .tag {
            background: #20424f;
            color: #bfe4ef;
        }

        details summary {
            cursor: pointer;
            font-weight: 600;
            letter-spacing: .4px;
        }

        details {
            margin: .75rem 0 1.1rem;
        }

        .inline-kv {
            display: grid;
            gap: .4rem .9rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            margin: 1rem 0 1.5rem;
        }

        .inline-kv div {
            font-size: .7rem;
            letter-spacing: .4px;
            background: var(--bg-panel-alt);
            padding: .45rem .6rem;
            border-radius: 6px;
        }

        .event-table td:nth-child(1),
        .event-table td:nth-child(2) {
            white-space: nowrap;
        }

        .event-critical {
            background: linear-gradient(90deg, #630000, #300);
            color: #fff;
        }

        .event-core {
            background: linear-gradient(90deg, #004d31, #00291d);
            color: #fff;
        }

        .event-infra {
            background: linear-gradient(90deg, #223b61, #102235);
            color: #fff;
        }

        mark {
            background: linear-gradient(90deg, #ffe79e, #ffd04d);
            padding: 0 .25rem;
            border-radius: 4px;
        }

        .flex {
            display: flex;
            gap: .9rem;
            flex-wrap: wrap;
        }

        .notice {
            background: linear-gradient(90deg, #00462c, #012018);
            color: #c0ffdc;
            padding: .75rem 1rem;
            border-radius: 8px;
            font-size: .7rem;
            letter-spacing: .4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .25);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: .55rem;
            background: var(--bg-panel);
            padding: .45rem .6rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, .08);
            max-width: 380px;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: .8rem;
            background: transparent;
            color: var(--text);
        }

        [data-theme="dark"] .search-box {
            border: 1px solid #20424f;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: .6rem;
            margin: 1rem 0 1.25rem;
        }

        .chip {
            cursor: pointer;
            padding: .4rem .7rem;
            background: var(--bg-panel);
            border: 1px solid rgba(0, 0, 0, .08);
            border-radius: 20px;
            font-size: .6rem;
            font-weight: 600;
            letter-spacing: .5px;
            transition: .25s;
        }

        .chip.active {
            background: var(--accent-grad);
            color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .25);
        }

        [data-theme="dark"] .chip {
            background: #1a323a;
            border: 1px solid #20424f;
            color: #b7d1d9;
        }

        .table-wrapper {
            position: relative;
            overflow: auto;
            border-radius: 10px;
            background: var(--bg-panel);
            box-shadow: var(--shadow);
        }

        .table-wrapper.alt {
            background: var(--bg-panel-alt);
        }

        .emptystate {
            font-style: italic;
            opacity: .6;
        }

        .copy-btn {
            cursor: pointer;
            border: none;
            background: var(--accent-grad);
            color: #fff;
            padding: .4rem .65rem;
            font-size: .55rem;
            border-radius: 6px;
            font-weight: 600;
            letter-spacing: .5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .3);
        }

        .copy-btn.small {
            padding: .25rem .55rem;
        }

        .toc-toggle {
            display: none;
            position: fixed;
            top: .85rem;
            left: .85rem;
            z-index: 800;
            padding: .6rem .7rem;
            font-size: .7rem;
            letter-spacing: .6px;
            background: var(--accent-grad);
            color: #fff;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .4);
        }

        footer.site {
            padding: 3rem 1rem 4rem;
            text-align: center;
            font-size: .65rem;
            opacity: .65;
        }

        .theme-toggle {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            z-index: 600;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 1.4rem;
            transform: translateX(-50%) translateY(40px);
            background: #061115;
            color: #fff;
            padding: .6rem .9rem;
            border-radius: 6px;
            font-size: .65rem;
            letter-spacing: .5px;
            opacity: 0;
            transition: .4s;
            box-shadow: 0 4px 14px rgba(0, 0, 0, .45);
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Flow timeline styles */
        .flow-timeline {
            display: flex;
            flex-wrap: wrap;
            gap: .9rem;
            align-items: stretch;
            margin: .6rem 0 .3rem;
            counter-reset: phase;
        }

        .flow-stage {
            position: relative;
            flex: 1 1 250px;
            min-width: 230px;
            background: var(--bg-panel);
            border-radius: 10px;
            padding: .9rem .85rem .95rem 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: .4rem;
        }

        .flow-stage:before {
            counter-increment: phase;
            content: counter(phase);
            position: absolute;
            top: -10px;
            left: -10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .65rem;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
        }

        .flow-stage h4 {
            margin: 0;
            font-size: .7rem;
            letter-spacing: .6px;
            font-weight: 600;
        }

        .flow-stage p {
            margin: 0;
            font-size: .62rem;
            line-height: 1.3;
            letter-spacing: .25px;
        }

        .flow-divider {
            flex-basis: 100%;
            height: 0;
            border: none;
            margin: .2rem 0 .5rem;
            position: relative;
        }

        .phase-label {
            flex-basis: 100%;
            font-size: .62rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
            opacity: .65;
            margin: .2rem 0 .2rem .2rem;
            position: relative;
            padding-left: .6rem;
        }

        .phase-label:before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 14px;
            background: var(--accent);
            border-radius: 2px;
        }

        .flow-stage.reverse {
            background: linear-gradient(135deg, #f5f9fb 0%, #e8f2f5 100%);
        }

        [data-theme="dark"] .flow-stage.reverse {
            background: linear-gradient(135deg, #132830, #0e1d23);
        }

        .flow-stage.forward {
            background: linear-gradient(135deg, #f7fbf9 0%, #eef9f4 100%);
        }

        [data-theme="dark"] .flow-stage.forward {
            background: linear-gradient(135deg, #143228, #0f251e);
        }

        .flow-stage .tags {
            display: flex;
            flex-wrap: wrap;
            gap: .3rem;
            margin-top: .15rem;
        }

        .flow-stage .tags span {
            background: var(--bg-panel-alt);
            padding: .15rem .45rem;
            font-size: .5rem;
            letter-spacing: .5px;
            font-weight: 600;
            border-radius: 12px;
        }

        [data-theme="dark"] .flow-stage .tags span {
            background: #203842;
        }

        .flow-connector {
            display: none;
        }

        @media (min-width:1200px) {
            .flow-stage {
                flex: 1 1 calc(25% - .9rem);
            }
        }

        @media (max-width:1150px) {
            nav#toc {
                position: fixed;
                transform: translateX(-110%);
                transition: .4s;
                z-index: 700;
                box-shadow: 4px 0 20px -4px rgba(0, 0, 0, .45);
            }

            nav#toc.open {
                transform: translateX(0);
            }

            .toc-toggle {
                display: block;
            }

            main#content {
                padding: 2.2rem 1.1rem 5rem;
            }
        }

        /* (Removed stray duplicated CSS outside style context) */
        /* Utility & normalization classes added for sections 7-11 */
        .mt-md {
            margin-top: 1rem;
        }

        .mt-lg {
            margin-top: 1.2rem;
        }

        table.compact {
            font-size: .72rem;
        }

        .risk-tier-list {
            font-size: .7rem;
            line-height: 1.35;
            margin: 0 0 .6rem 1rem;
            padding: 0;
        }

        .muted {
            font-size: .63rem;
            opacity: .75;
        }

        .tight {
            margin: 0;
        }

        .text-xs {
            font-size: .6rem;
        }

        .story-title {
            font-weight: 600;
        }

        .story-desc {
            font-size: .63rem;
            opacity: .85;
            margin: .15rem 0 .25rem;
        }

        .note-xs {
            font-size: .6rem;
            line-height: 1.35;
        }

        .list-tight {
            margin: .25rem 0 .2rem .9rem;
            padding-left: 1rem;
        }
    </style>
</head>

<body>
    <header class="hero">
        <span class="version-badge">Release V4.5</span>
        <h1>EMedia V4.5 – Complete Documentation</h1>
        <p class="sub">End‑to‑end documentation covering architecture, domain event model, augmented functional backlog,
            stored procedure catalog, test suite, Azure DevOps import patches, and operational considerations. This
            edition embeds an <strong>event‑driven viewpoint</strong> for traceability and resilience.</p>
        <div class="actions-hero">
            <button class="btn" id="toggleThemeBtn">Toggle Dark</button>
            <button class="btn outline" id="expandAllBtn" title="Expand all large tables">Expand All</button>
            <button class="btn outline" id="collapseAllBtn" title="Collapse all large tables">Collapse All</button>
            <button class="btn secondary" id="exportEventsBtn" title="Download domain event catalog JSON">Export Event
                Catalog</button>
        </div>
    </header>
    <div class="layout">
        <nav id="toc" aria-label="Table of contents">
            <h3>Contents</h3>
            <ul id="tocList">
                <li><a href="#sec-1"><span class="toc-index">1</span><span class="toc-label">Executive
                            Summary</span></a></li>
                <li><a href="#sec-1-flow"><span class="toc-index">1A</span><span class="toc-label">Reverse &amp; Forward
                            Engineering Flow</span></a></li>
                <li><a href="#sec-2"><span class="toc-index">2</span><span class="toc-label">EMedia Analysis &amp;
                            Documentation</span></a></li>
                <li><a href="#sec-3"><span class="toc-index">3</span><span class="toc-label">Business Capability
                            Stories</span></a></li>
                <li><a href="#sec-4"><span class="toc-index">4</span><span class="toc-label">Event-Driven
                            Architecture</span></a></li>
                <li><a href="#sec-5"><span class="toc-index">5</span><span class="toc-label">Functional
                            Backlog</span></a></li>
                <li><a href="#sec-6"><span class="toc-index">6</span><span class="toc-label">Stored Procedure
                            Backlog</span></a></li>
                <li><a href="#sec-7"><span class="toc-index">7</span><span class="toc-label">Complete Test
                            Suite</span></a></li>
                <li><a href="#sec-8"><span class="toc-index">8</span><span class="toc-label">Implementation &amp;
                            Summary</span></a></li>
            </ul>
        </nav>
        <main id="content">
            <section id="sec-1" class="doc-section">
                <h2><span class="sec-index">1</span> Executive Summary</h2>
                <p class="lead">EMedia orchestrates data extraction, transformation, file generation, compression,
                    distribution, and reconciliation across heterogeneous partner formats. V4.5 formalizes a
                    <mark>domain event contract</mark> enabling decoupled services (Generator, Distributor,
                    WorkAllocator, FileZipMove) and introduces improved observability, idempotent allocation, and
                    enhanced stored procedure coverage (86 SP stories).</p>
                <div class="grid cols-3" id="summaryMetrics"></div>
                <div class="panel alt" style="margin-top:1.4rem;">
                    <strong>Key Improvements:</strong>
                    <ul style="margin:.6rem 0 0; padding-left:1.1rem; line-height:1.35; font-size:.78rem;">
                        <li>Event envelope with correlation + causation IDs across all services.</li>
                        <li>Allocation idempotency & replay safe consumer design.</li>
                        <li>Expanded checksum reconciliation & alert pathways.</li>
                        <li>Complete Azure DevOps patch arrays for rapid import.</li>
                        <li>Backlog/test traceability via consistent naming (US / SP / TC).</li>
                    </ul>
                </div>
            </section>
            <section id="sec-1-flow" class="doc-section">
                <h2><span class="sec-index">1A</span> Reverse &amp; Forward Engineering Flow</h2>
                <p class="lead">High-level visual summary of how the legacy solution was reverse engineered and then
                    forward engineered into structured backlogs, stored procedure narratives, tests, event model, and
                    the modern AWS/MSK architecture.</p>
                <div class="panel alt">
                    <h3>Flow Diagram (Discovery → Design → Delivery)</h3>
                    <div class="flow-timeline" aria-label="Reverse and forward engineering phases timeline">
                        <span class="phase-label">Reverse Engineering</span>
                        <div class="flow-stage reverse">
                            <h4>1. Baseline Scan</h4>
                            <p>Inspect solution structure, services, layering to frame extraction scope.</p>
                            <div class="tags"><span>Code Scan</span><span>Inventory</span></div>
                        </div>
                        <div class="flow-stage reverse">
                            <h4>2. Reverse Extraction</h4>
                            <p>Derive stored procedure set, implicit workflows, manual operational steps.</p>
                            <div class="tags"><span>SP List</span><span>Workflows</span></div>
                        </div>
                        <div class="flow-stage reverse">
                            <h4>3. Domain Decomposition</h4>
                            <p>Cluster into Allocation, Generation, Distribution, Compression, Reconciliation domains.
                            </p>
                            <div class="tags"><span>Domains</span><span>Boundaries</span></div>
                        </div>
                        <div class="flow-stage reverse">
                            <h4>4. Consolidated Documentation</h4>
                            <p>Assemble unified HTML artifact embedding legacy SP & test narratives.</p>
                            <div class="tags"><span>Single Source</span><span>Transparency</span></div>
                        </div>
                        <span class="phase-label">Forward Engineering</span>
                        <div class="flow-stage forward">
                            <h4>5. Business Stories</h4>
                            <p>High‑level capabilities aligned to modernized platform.</p>
                            <div class="tags"><span>Capabilities</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>6. To‑Be Architecture</h4>
                            <p>Define AWS/MSK microservices topology & cross‑cutting concerns.</p>
                            <div class="tags"><span>MSK</span><span>EKS</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>7. Functional Backlog (Updated)</h4>
                            <p>Refine stories to reference services, topics, idempotent patterns.</p>
                            <div class="tags"><span>US-###</span><span>Services</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>8. SP Story Expansion (Updated)</h4>
                            <p>Align SP narratives with microservice ownership & event triggers.</p>
                            <div class="tags"><span>SP-###</span><span>Ownership</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>9. Test Suite (Updated)</h4>
                            <p>Add event assertions, partition key cases, resilience scenarios.</p>
                            <div class="tags"><span>TC-###</span><span>Events</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>10. Event Model</h4>
                            <p>Map domain actions to Kafka topics; finalize envelope & categories.</p>
                            <div class="tags"><span>Envelope</span><span>Topics</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>11. Consolidated Documentation</h4>
                            <p>Create single knowledge base (interactive HTML artifact updated).</p>
                            <div class="tags"><span>Single Source</span></div>
                        </div>
                        <div class="flow-stage forward">
                            <h4>12. Traceability & Import</h4>
                            <p>Generate JSON Patch & matrices linking Story ↔ SP ↔ Test ↔ Event.</p>
                            <div class="tags"><span>JSON Patch</span><span>Matrix</span></div>
                        </div>
                    </div>
                    <div class="notice">Cards show progression from implicit knowledge to explicit, testable,
                        event-aligned assets. Reverse phases feed forward engineering; traceability closes the loop.
                    </div>
                </div>
                <div class="panel mt-lg">
                    <h3>Phase Snapshot</h3>
                    <table class="compact">
                        <thead>
                            <tr>
                                <th>Phase</th>
                                <th>Goal</th>
                                <th>Key Outputs</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1 Baseline Scan</td>
                                <td>Understand legacy structure</td>
                                <td>Service list, layer map</td>
                            </tr>
                            <tr>
                                <td>2 Reverse Extraction</td>
                                <td>Surface hidden behaviors</td>
                                <td>SP inventory, workflow notes</td>
                            </tr>
                            <tr>
                                <td>3 Domain Decomposition</td>
                                <td>Cluster responsibilities</td>
                                <td>Allocation/Generation/etc sets</td>
                            </tr>
                            <tr>
                                <td>4 Functional Backlog</td>
                                <td>Formalize implementation work</td>
                                <td>25 US stories</td>
                            </tr>
                            <tr>
                                <td>5 Business Stories</td>
                                <td>Align to business value</td>
                                <td>Capability stories</td>
                            </tr>
                            <tr>
                                <td>6 To‑Be Architecture</td>
                                <td>Modernize platform</td>
                                <td>AWS/MSK topology</td>
                            </tr>
                            <tr>
                                <td>7 Functional Backlog</td>
                                <td>Formalize implementation work</td>
                                <td>25 US stories</td>
                            </tr>
                            <tr>
                                <td>8 SP Expansion</td>
                                <td>Make DB logic explicit</td>
                                <td>86 SP narratives</td>
                            </tr>
                            <tr>
                                <td>9 Test Suite</td>
                                <td>Codify verification early</td>
                                <td>111 mapped tests</td>
                            </tr>
                            <tr>
                                <td>10 Event Model</td>
                                <td>Define decoupled contract</td>
                                <td>Envelope, catalog, mapping</td>
                            </tr>
                            <tr>
                                <td>11 Consolidated Doc</td>
                                <td>Create single knowledge base</td>
                                <td>Interactive HTML artifact</td>
                            </tr>
                            <tr>
                                <td>12 Traceability & Import</td>
                                <td>Enable planning & governance</td>
                                <td>JSON Patch, matrices</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="panel alt mt-lg">
                    <h3>Alternate ASCII View</h3>
                    <pre>[Legacy Code & Services]
        |
        v
[SP & Workflow Extraction] --> [Domain Clusters]
        |                           (Allocation, Generation, ...)
        v
[Functional Stories US-*] -> [SP Stories SP-*] -> [Test Suite TC-*]
        |                                 |             |
        |                                 v             v
        |--------------------------> [Event Model / Catalog]
        |                                   |
        v                                   v
[Unified Documentation] ---> [To-Be Event Architecture]
        |                                   |
        v                                   v
[Business Capability Stories] -> [Traceability / DevOps Import]
</pre>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>Enablement Highlights</h3>
                    <ul style="font-size:.7rem; line-height:1.4; margin:0 0 0 1rem;">
                        <li>Consistent ID taxonomy (US/SP/TC) enabling deterministic linkage.</li>
                        <li>Event envelope introduced early to avoid retrofit complexity.</li>
                        <li>Embedded raw markdown → transparency + diffable evolution.</li>
                        <li>Forward design (AWS/MSK) grounded by reverse SP semantics.</li>
                    </ul>
                </div>
            </section>
            <section id="sec-2" class="doc-section">
                <h2><span class="sec-index">2</span> EMedia Analysis &amp; Documentation</h2>
                <p class="lead">Consolidated enterprise analysis extracted from the standalone
                    <code>EMediaV4.5-Documentation.html</code> reference: overview, layered architecture, project
                    inventory, business & data layer details, integrations, SQL/data patterns, deployment environment,
                    and analysis templates. This embeds the legacy system snapshot verbatim for traceability against
                    modernization changes.</p>
                <div class="panel">
                    <h3>2.1 System Overview</h3>
                    <p>EMedia V4.5 is a comprehensive .NET enterprise solution for electronic data distribution and
                        automated file processing. Built using C# and .NET Framework, it provides a robust, scalable
                        platform for data distribution requirements.</p>
                    <div
                        style="display:grid;gap:.6rem;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));margin-top:.8rem;">
                        <div class="metric-card">
                            <h4>Projects</h4>
                            <div class="value">7</div>
                            <div class="sub">Solution</div>
                        </div>
                        <div class="metric-card">
                            <h4>Core Layers</h4>
                            <div class="value">3</div>
                            <div class="sub">Architecture</div>
                        </div>
                        <div class="metric-card">
                            <h4>Win Services</h4>
                            <div class="value">5</div>
                            <div class="sub">Runtime</div>
                        </div>
                        <div class="metric-card">
                            <h4>Key Classes</h4>
                            <div class="value">15+</div>
                            <div class="sub">Primary</div>
                        </div>
                    </div>
                    <div class="notice" style="margin-top:.9rem;">Key Features: Automated generation & distribution •
                        Multi‑protocol transfer • Security & error handling • Configurable rules • Audit &
                        reconciliation • Email notifications • Compression & archiving</div>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>2.2 Layered System Architecture</h3>
                    <div
                        style="background:var(--bg-panel);padding:1rem;border-radius:8px;display:flex;flex-direction:column;align-items:stretch;">
                        <div
                            style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:.6rem .8rem;margin:.3rem 0;border-radius:6px;font-weight:600;">
                            Windows Services Layer</div>
                        <div style="text-align:center;font-size:.9rem;opacity:.65;">↓</div>
                        <div
                            style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:.6rem .8rem;margin:.3rem 0;border-radius:6px;font-weight:600;">
                            Business Logic Layer</div>
                        <div style="text-align:center;font-size:.9rem;opacity:.65;">↓</div>
                        <div
                            style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:.6rem .8rem;margin:.3rem 0;border-radius:6px;font-weight:600;">
                            Data Access Layer</div>
                        <div style="text-align:center;font-size:.9rem;opacity:.65;">↓</div>
                        <div
                            style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:.6rem .8rem;margin:.3rem 0;border-radius:6px;font-weight:600;">
                            Common Utilities Layer</div>
                    </div>
                    <h4 style="margin-top:1.1rem;font-size:.75rem;letter-spacing:.75px;">Architectural Patterns</h4>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Layer</th>
                                <th>Pattern</th>
                                <th>Purpose</th>
                                <th>Technology</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Service Layer</td>
                                <td>Service-Oriented</td>
                                <td>Background processing</td>
                                <td>.NET Windows Services</td>
                            </tr>
                            <tr>
                                <td>Business Layer</td>
                                <td>Facade</td>
                                <td>Encapsulate rules</td>
                                <td>C# Classes</td>
                            </tr>
                            <tr>
                                <td>Data Layer</td>
                                <td>Repository</td>
                                <td>Abstraction & SP calls</td>
                                <td>Enterprise Library / ADO.NET</td>
                            </tr>
                            <tr>
                                <td>Common Layer</td>
                                <td>Utility</td>
                                <td>Cross-cutting services</td>
                                <td>Config, Logging, Mail</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>2.3 Solution Projects</h3>
                    <div class="grid cols-3" style="font-size:.65rem;line-height:1.35;">
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>BusinessLayer</strong><br /><span
                                style="opacity:.75;">BPPLUS.EMedia.BusinessLayer</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>CommonBusinessLayer</li>
                                <li>WorkAllocatorBusinessLayer</li>
                                <li>DataDistributionBusinessLayer</li>
                                <li>DataGeneratorBusinessLayer</li>
                                <li>ZipMoveUnZipBusinessLayer</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>DataLayer</strong><br /><span style="opacity:.75;">BPPLUS.EMedia.DataLayer</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>CommonDataLayer</li>
                                <li>WorkAllocatorDataLayer</li>
                                <li>DataDistributorDataLayer</li>
                                <li>DataGeneratorDataLayer</li>
                                <li>ZipMoveUnZipDataLayer</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>Common</strong><br /><span style="opacity:.75;">BPPLUS.EMedia.Common</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>ConfigReference</li>
                                <li>Constants</li>
                                <li>Mailer</li>
                                <li>Exceptions</li>
                                <li>BackUpFiles</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>DataGenerator</strong><br /><span
                                style="opacity:.75;">BPPLUS.EMedia.Services.DataGenerator</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>GeneratorService</li>
                                <li>FormatManager</li>
                                <li>EMediaFormat</li>
                                <li>CommonFunctions</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>DataDistributor</strong><br /><span
                                style="opacity:.75;">BPPLUS.EMedia.Services.DataDistributor</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>DistributorService</li>
                                <li>FTP/SFTP/FTPS/OFTP</li>
                                <li>Email</li>
                                <li>EMediaDistributor</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>WorkAllocator</strong><br /><span
                                style="opacity:.75;">BPPLUS.EMedia.Services.WorkAllocator</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>ServiceManager</li>
                                <li>AllocateWork</li>
                                <li>Mails</li>
                                <li>Settings</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.7rem .8rem;">
                            <strong>FileZipMoveUnzip</strong><br /><span
                                style="opacity:.75;">BPPLUS.EMedia.Services.FileZipMoveUnzip</span>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>FileZipMoveUnzipService</li>
                                <li>ZipAndMove</li>
                                <li>Unzip</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>2.4 Business Layer Details</h3>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Responsibility</th>
                                <th>Key Methods</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CommonBusinessLayer</td>
                                <td>Shared business logic, email content management</td>
                                <td>GetContent(), GetEmailDetailsForGeneration()</td>
                            </tr>
                            <tr>
                                <td>WorkAllocatorBusinessLayer</td>
                                <td>Work allocation & instance management</td>
                                <td>GetGenerationSchedulesAndInstances(), AllocateGenerationWork()</td>
                            </tr>
                            <tr>
                                <td>DataDistributionBusinessLayer</td>
                                <td>Distribution logic & protocol mgmt</td>
                                <td>GetDistributionTasksForInstance(), GetFTPDetails()</td>
                            </tr>
                            <tr>
                                <td>DataGeneratorBusinessLayer</td>
                                <td>Generation rules & validation</td>
                                <td>GetGenerationFilesAndFormatDetails(), UpdateGenerationStatus()</td>
                            </tr>
                            <tr>
                                <td>ZipMoveUnZipBusinessLayer</td>
                                <td>Compression & transfer coordination</td>
                                <td>GetZippingFilesAndSFTPDetails(), UpdateZipStatus()</td>
                            </tr>
                        </tbody>
                    </table>
                    <details style="margin-top:.8rem;">
                        <summary style="cursor:pointer;font-weight:600;">Business Layer Code Excerpt</summary>
                        <pre style="font-size:.6rem;max-height:320px;overflow:auto;">namespace BPPLUS.EMedia.BusinessLayer
{
    public class CommonBusinessLayer
    {
        CommonDataLayer commonInstance = new CommonDataLayer();
        public string GetContent(DataTable dtContent, string Description)
        {
            string selectCondition = Constants.TableColumns.DESCRIPTION + " like '" + Description + "'";
            if (dtContent.Select(selectCondition).Length != 0)
            {
                return dtContent.Select(selectCondition)[0][Constants.TableColumns.CONTENT].ToString();
            }
            return " **Missing:" + Description + "**";
        }
    }
}</pre>
                    </details>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>2.5 Data Layer Details</h3>
                    <ul style="font-size:.7rem; line-height:1.4; margin:0 0 .8rem 1rem;">
                        <li>Enterprise Library for data access & parameterization</li>
                        <li>Stored procedures for all DB operations (86+)</li>
                        <li>Connection strings via configuration indirection</li>
                        <li>Structured error handling & logging</li>
                        <li>DataSet/DataTable abstractions for multi-table returns</li>
                    </ul>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Technology</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Database Server</td>
                                <td>SQL Server</td>
                                <td>Primary storage & logic</td>
                            </tr>
                            <tr>
                                <td>Data Access</td>
                                <td>Enterprise Library</td>
                                <td>Connection mgmt & execution</td>
                            </tr>
                            <tr>
                                <td>Stored Procedures</td>
                                <td>T‑SQL</td>
                                <td>Encapsulated business rules</td>
                            </tr>
                            <tr>
                                <td>Configuration</td>
                                <td>App.config</td>
                                <td>Connection + DB settings</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>2.6 External Integrations</h3>
                    <div class="grid cols-3" style="font-size:.65rem;line-height:1.35;">
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>File Transfer Protocols</strong>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>FTP</li>
                                <li>SFTP</li>
                                <li>FTPS</li>
                                <li>OFTP</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Email Integration</strong>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>SMTP Notifications</li>
                                <li>Template Driven</li>
                                <li>Attachments</li>
                                <li>Error Alerts</li>
                            </ul>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Third‑Party Components</strong>
                            <ul style="margin:.4rem 0 0 1rem;padding:0;">
                                <li>Rebex</li>
                                <li>Enterprise Library</li>
                                <li>Compression Libs</li>
                                <li>Windows Service Framework</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>2.7 SQL &amp; Data Elements Analysis</h3>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Pattern</th>
                                <th>Implementation</th>
                                <th>Usage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Stored Procedures</td>
                                <td>Parameterized SP calls only</td>
                                <td>CRUD, logic, reporting</td>
                            </tr>
                            <tr>
                                <td>DataSets/DataTables</td>
                                <td>Structured containers</td>
                                <td>Layer data transfer</td>
                            </tr>
                            <tr>
                                <td>Constants</td>
                                <td>Central static definitions</td>
                                <td>Type safety & maintainability</td>
                            </tr>
                            <tr>
                                <td>Parameters</td>
                                <td>Explicit typed args</td>
                                <td>Secure DB access</td>
                            </tr>
                        </tbody>
                    </table>
                    <ul style="font-size:.7rem; line-height:1.4; margin:.6rem 0 0 1rem;">
                        <li><strong>String</strong> – text / paths / descriptions</li>
                        <li><strong>Int64</strong> – identifiers & counters</li>
                        <li><strong>Boolean</strong> – status flags</li>
                        <li><strong>DateTime</strong> – scheduling & timestamps</li>
                        <li><strong>DataSet</strong> – multi-table result bundles</li>
                        <li><strong>DataTable</strong> – single table sets</li>
                    </ul>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>2.8 Deployment &amp; Operations</h3>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Requirement</th>
                                <th>Version</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Operating System</td>
                                <td>Windows Server</td>
                                <td>2008 R2+</td>
                            </tr>
                            <tr>
                                <td>.NET Framework</td>
                                <td>Microsoft .NET</td>
                                <td>3.5 SP1+</td>
                            </tr>
                            <tr>
                                <td>Database</td>
                                <td>SQL Server</td>
                                <td>2008+</td>
                            </tr>
                            <tr>
                                <td>IIS</td>
                                <td>Internet Information Services</td>
                                <td>7.0+</td>
                            </tr>
                        </tbody>
                    </table>
                    <ul style="font-size:.7rem;line-height:1.35;margin:.7rem 0 0 1rem;">
                        <li><strong>DataGenerator</strong>: Automated data file generation</li>
                        <li><strong>DataDistributor</strong>: File distribution & delivery</li>
                        <li><strong>WorkAllocator</strong>: Task scheduling & allocation</li>
                        <li><strong>FileZipMoveUnzip</strong>: Compression & archiving</li>
                    </ul>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>2.9 Analysis Documents &amp; Templates</h3>
                    <div class="grid cols-3" style="font-size:.65rem;line-height:1.35;">
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Pattern Analysis</strong><br /><a
                                href="Summary/reportGeneration-pattern-analysis-step-1.md">Template</a>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Complete Analysis</strong><br /><a
                                href="Summary/reportGeneration-complete-analysis-step-3.md">Template</a>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>SQL Analysis</strong><br /><a
                                href="Summary/reportGeneration-sql-analysis-step-4.md">Template</a>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Dependency Analysis</strong><br /><a
                                href="Summary/reportGeneration-subprogram-analysis.md">Template</a>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Method Docs</strong><br /><a
                                href="Summary/reportGeneration-procedure-psuedo-code-step-5.md">Template</a>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>Workflow</strong><br /><a
                                href="Summary/reportGeneration-workflow-instructions.md">Template</a>
                        </div>
                    </div>
                    <div class="notice" style="margin-top:.8rem;">Generation Process: Pattern Validation → Complete
                        Analysis → SQL Analysis → Dependency Analysis → Method Pseudo Code → Consolidated Artifact.
                    </div>
                </div>
            </section>
            <!-- Business Capability Stories moved before Architecture per reordering request -->
            <section id="sec-3" class="doc-section">
                <h2><span class="sec-index">3</span> Business Capability Stories</h2>
                <p class="lead">High-level business user stories providing capability context (formats, distribution,
                    reconciliation, multi-country, admin control, hierarchy, error handling, file management). Sourced
                    from <code>business-user-stories.md</code> for strategic traceability.</p>
                <div class="panel alt" id="businessStoriesContainer">
                    <h3>3.1 Business Domains Overview</h3>
                    <div class="scroll-x" style="margin:.6rem 0 1.2rem;">
                        <table style="font-size:.6rem; min-width:1200px;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">Domain</th>
                                    <th style="text-align:left;">Primary Purpose</th>
                                    <th style="text-align:left;">Primary Stakeholder</th>
                                    <th style="text-align:left;">Key Capabilities</th>
                                    <th style="text-align:left;">Representative SPs</th>
                                    <th style="text-align:left;">Downstream / Dependencies</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Data Generation & Formats</td>
                                    <td>Produce files across supported business formats with correct rules & totals</td>
                                    <td>Business User</td>
                                    <td>Multi-format extraction, parent & customer scope, control totals,
                                        invoice/uninvoice</td>
                                    <td>SP-019..SP-033</td>
                                    <td>Reconciliation, Distribution, Archival</td>
                                </tr>
                                <tr>
                                    <td>Distribution & Communication</td>
                                    <td>Deliver generated artifacts securely via multiple protocols</td>
                                    <td>Business Partner</td>
                                    <td>Email attachments, FTP/SFTP/FTPS/OFTP, compression, delivery confirmation</td>
                                    <td>SP-055, SP-006</td>
                                    <td>Generation Completed Events, Protocol Adapters, Notification</td>
                                </tr>
                                <tr>
                                    <td>Reconciliation & Control</td>
                                    <td>Ensure data integrity between source transactions and distributed outputs</td>
                                    <td>Financial Controller</td>
                                    <td>Counts & total validation, variance detection, status tracking</td>
                                    <td>SP-014..SP-018, SP-079..SP-086</td>
                                    <td>Generation Outputs, Audit, Notification</td>
                                </tr>
                                <tr>
                                    <td>Multi-Country Operations</td>
                                    <td>Apply localization rules and naming for each supported country</td>
                                    <td>International Business Manager</td>
                                    <td>Country dataset selection, naming conventions, currency handling</td>
                                    <td>Format Logic (Code)</td>
                                    <td>Generation, Distribution Compliance</td>
                                </tr>
                                <tr>
                                    <td>Administrative Control</td>
                                    <td>Govern distribution process & approvals</td>
                                    <td>System Administrator</td>
                                    <td>Approval workflow, indicators, notifications, audit trail</td>
                                    <td>SP-001 (Scheduling), SP-002, SP-003</td>
                                    <td>All downstream lifecycle services</td>
                                </tr>
                                <tr>
                                    <td>Parent-Child Relationships</td>
                                    <td>Support hierarchical aggregation & reporting</td>
                                    <td>Corporate Customer</td>
                                    <td>Parent aggregation, child detail, fee handling, ordering</td>
                                    <td>SP-019 family (aggregation logic)</td>
                                    <td>Reporting, Billing, Reconciliation</td>
                                </tr>
                                <tr>
                                    <td>Error Handling & Notification</td>
                                    <td>Surface operational & business issues rapidly</td>
                                    <td>Support Team</td>
                                    <td>Warning/delay emails, failure detection, resend flows</td>
                                    <td>SP-007 (heartbeat), SP variance SP-079</td>
                                    <td>Notification, Monitoring, Audit</td>
                                </tr>
                                <tr>
                                    <td>File Management</td>
                                    <td>Optimize storage, movement, and packaging of files</td>
                                    <td>System Operator</td>
                                    <td>Compression, attachment handling, naming, versioning</td>
                                    <td>SP-029 (archive), Zip/Move/Unzip code</td>
                                    <td>Distribution, Archive, Retention Policies</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="businessStoriesContent" style="font-size:.7rem; line-height:1.4;">
                        <!-- Existing business stories content reused verbatim (only numbering context changes) -->
                        **As a Business User**
                        I want to generate transaction data files in multiple formats
                        So that I can support different country-specific requirements

                        **Acceptance Criteria:**

                        - Support for various file formats:
                        - Agency National Format
                        - BPF (Business Partner Format)
                        - BPI (Business Partner International)
                        - BPPC TR (Transaction Reports)
                        - BPPC CL (Client Reports)
                        - CAR Format
                        - Enhanced International Version
                        - IFC Redefined formats (all variants including Plus / Parent)
                        - Each format handles both parent and customer level data
                        - Support for both invoice and uninvoice transactions
                        - Include proper control totals and reconciliation data

                        ---

                        ## 2. Distribution and Communication Stories

                        **As a Business Partner**
                        I want to receive transaction files through multiple secure channels
                        So that I can integrate the data into my systems securely

                        **Acceptance Criteria:**

                        - Support multiple distribution methods:
                        - Email with attachments
                        - FTP
                        - SFTP
                        - FTPS
                        - OFTP
                        - Enable file compression (ZIP) with password protection
                        - Support multiple attachment handling
                        - Provide delivery confirmation notifications

                        ---

                        ## 3. Reconciliation and Control Stories

                        **As a Financial Controller**
                        I want automated reconciliation of distributed data
                        So that I can ensure data integrity and completeness

                        **Acceptance Criteria:**

                        - Validate transaction counts match control totals
                        - Reconcile gross rebate amounts
                        - Check statement values against transaction totals
                        - Support BPPC CL reconciliation process
                        - Handle uninvoice reconciliation
                        - Generate reconciliation failure notifications
                        - Track reconciliation status for each file

                        ---

                        ## 4. Multi-Country Operations Stories

                        **As an International Business Manager**
                        I want country-specific data handling capabilities
                        So that I can comply with local requirements

                        **Acceptance Criteria:**

                        - Support specific formats / datasets for:
                        - Austria (A)
                        - France (F)
                        - Germany (D)
                        - Greece (H)
                        - Netherlands (N)
                        - Poland (K)
                        - Portugal (P)
                        - UK (U)
                        - Handle country-specific file naming conventions
                        - Support local currency requirements
                        - Maintain country-specific business rules

                        ---

                        ## 5. Administrative Control Stories

                        **As a System Administrator**
                        I want comprehensive control over data distribution
                        So that I can ensure proper governance and security

                        **Acceptance Criteria:**

                        - Implement admin approval workflow for distributions
                        - Support full / partial distribution indicators
                        - Maintain admin notification system
                        - Track admin approvals and rejections
                        - Configure admin CC and BCC lists for notifications
                        - Monitor system performance and status

                        ---

                        <!-- Truncated remainder retained in source; original detailed markdown lives in hidden script and is rendered dynamically. -->
                    </div>
                    <button class="btn secondary" id="exportBusinessStoriesBtn" style="margin-top:.9rem;">Export
                        Business Stories JSON</button>
                </div>
            </section>
            <section id="sec-4" class="doc-section">
                <h2><span class="sec-index">4</span> Event‑Driven Architecture (To‑Be AWS Microservices)</h2>
                <p class="lead">Refactored target architecture replaces tightly‑coupled Windows Services & round‑robin
                    allocation with a <strong>Kafka (Amazon MSK) centric publish/subscribe mesh</strong>, Hangfire
                    scheduling, and elastic microservices deployed on EKS. Below synthesises the authoritative
                    <code>EMedia_ToBe_EventDriven_Architecture.md</code> into concise, implementation‑ready subsections
                    and augments with an explicit AWS services inventory.</p>
                <div class="panel">
                    <h3>4.1 Revised High‑Level Topology</h3>
                    <pre style="margin-top:.6rem;">Event‑Driven EMedia (To‑Be)
┌──────────────┐   ┌─────────────────┐   ┌──────────────────┐   ┌────────────────────┐
│ Hangfire /   │▶▶▶│ File Generator  │▶▶▶│ File Distributor  │▶▶▶│ (Future) Analytics │
│ Scheduler    │   │  Microservice   │   │  Microservice     │   │  / BI Consumers    │
└─────▲────────┘   └───────▲─────────┘   └────────▲──────────┘   └─────────▲──────────┘
      │                    │                         │                      │
      │ ScheduleTriggered  │ Generation events        │ Distribution events  │ Audit / BI
      │                    │                         │                      │
      └──────────────┬─────┴──────────────┬─────────┴──────────────┬────────┘
                     ▼                    ▼                        ▼
              Amazon MSK Topics:  schedule  |  file.generation  |  file.distribution | audit | error
                     │                    │                        │
                 Consumer Groups (auto‑scaling via lag metrics)
                     │
             Downstream Services: Audit, Notification, Monitoring</pre>
                    <ul style="font-size:.72rem; line-height:1.35; margin: .8rem 0 0 1rem;">
                        <li><strong>Partition Keys</strong>: <code>customerId</code> (generation ordering),
                            <code>fileId</code> (distribution), <code>scheduleId</code> (triggers).</li>
                        <li><strong>Retention</strong>: 7 days core streams; 90 days audit; 30 days error (replay &
                            compliance).</li>
                        <li><strong>Scaling Driver</strong>: Consumer lag & processing latency (CloudWatch metrics feed
                            HPA).</li>
                        <li><strong>Exactly‑Once</strong>: Idempotent producers + transactions + consumer side
                            idempotency table.</li>
                    </ul>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>4.2 Amazon MSK Justification & Config Snapshot</h3>
                    <p style="font-size:.74rem; line-height:1.45; margin:.2rem 0 .8rem;">MSK provides durable log‑based
                        streaming, horizontal scalability via partitions, ordered processing within a partition, and
                        native integration with VPC / IAM / CloudWatch. This eliminates bespoke allocation logic and
                        enables replay for audit & recovery.</p>
                    <pre>{
  "cluster": "emedia-msk-cluster",
  "brokers": 3,
  "partitions": {"schedule":6,"generation":12,"distribution":6,"audit":3,"error":3},
  "replicationFactor": 3,
  "encryption": {"inTransit":"TLS","atRest":"KMS"},
  "auth": {"SASL":"SCRAM-SHA-512","TLS":true},
  "retentionDays": {"core":7,"error":30,"audit":90}
}</pre>
                    <div class="notice">Lag‑based auto scale: target &lt; 200 msgs lag per partition for generation &
                        distribution topics.</div>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>4.3 Core Event Streams</h3>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Topic</th>
                                <th>Purpose</th>
                                <th>Partitions</th>
                                <th>Key</th>
                                <th>Typical Events</th>
                                <th>Retention</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>emedia.schedule.events</code></td>
                                <td>Trigger generation windows</td>
                                <td>6</td>
                                <td>scheduleId</td>
                                <td>ScheduleTriggered, ScheduleUpdated</td>
                                <td>7d</td>
                            </tr>
                            <tr>
                                <td><code>emedia.file.generation.events</code></td>
                                <td>Lifecycle of file creation</td>
                                <td>12</td>
                                <td>customerId</td>
                                <td>FileGenerationRequested/Started/Completed/Failed</td>
                                <td>7d</td>
                            </tr>
                            <tr>
                                <td><code>emedia.file.distribution.events</code></td>
                                <td>Delivery lifecycle</td>
                                <td>6</td>
                                <td>fileId</td>
                                <td>FileDistributionRequested/Started/Completed/Failed</td>
                                <td>7d</td>
                            </tr>
                            <tr>
                                <td><code>emedia.error.events</code></td>
                                <td>Centralised failure routing</td>
                                <td>3</td>
                                <td>eventId</td>
                                <td>DeliveryRetryExhausted, ReconciliationFailed</td>
                                <td>30d</td>
                            </tr>
                            <tr>
                                <td><code>emedia.audit.events</code></td>
                                <td>Immutable audit trail</td>
                                <td>3</td>
                                <td>eventId</td>
                                <td>All lifecycle summarised</td>
                                <td>90d</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>4.4 End‑to‑End Event Flow</h3>
                    <pre>1 Schedule (CRON/Hangfire) -> ScheduleTriggered
2 File Generator consumes -> publishes FileGenerationRequested -> Started -> Completed/Failed
3 Distributor consumes Completed -> publishes FileDistributionRequested -> Started -> Completed/Failed
4 Failures fan‑out to error topic; all terminal states mirrored to audit topic
5 Downstream (Analytics / Notifications) consume audit & error streams</pre>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>4.5 Microservice Responsibilities</h3>
                    <ul style="font-size:.7rem; line-height:1.4; margin:0 0 .9rem 1rem;">
                        <li><strong>Scheduler (Hangfire)</strong>: Timezone aware CRON; publishes
                            <code>ScheduleTriggered</code>; persists executions (RDS) + audit emit.</li>
                        <li><strong>File Generator</strong>: Validates business window, pulls transactional data (RDS),
                            reconciliation checks, format plugin execution, S3 write, emits generation events.</li>
                        <li><strong>File Distributor</strong>: Resolves protocol cfg (RDS/DynamoDB), pulls artifact from
                            S3, executes delivery strategy (Email/FTP/SFTP/FTPS/OFTP/Webhook), emits distribution events
                            & errors.</li>
                        <li><strong>Audit/Notification</strong>: Consolidates terminal events, triggers emails (SES /
                            SMTP bridge), metrics enrichment.</li>
                        <li><strong>Future Analytics</strong>: Consumes audit for BI / SLA dashboards (OpenSearch /
                            Athena over S3 archived events).</li>
                    </ul>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>4.6 Supporting Infrastructure</h3>
                    <ul style="font-size:.7rem; line-height:1.4; margin:0 0 .9rem 1rem;">
                        <li><strong>Event Store</strong>: DynamoDB (event sourcing, CQRS read models, streams ->
                            projector Lambdas optional).</li>
                        <li><strong>File Storage</strong>: S3 (hot), lifecycle to IA / Glacier / Deep Archive; event
                            notifications for downstream triggers.</li>
                        <li><strong>Relational Data</strong>: RDS PostgreSQL (primary) + read replicas; RDS Proxy for
                            pooling.</li>
                        <li><strong>Caching</strong>: ElastiCache Redis (format metadata, transient schedule lookups).
                        </li>
                        <li><strong>Time‑Series</strong>: Timestream (performance & reconciliation timings).</li>
                        <li><strong>Observability</strong>: CloudWatch (metrics/logs), X-Ray, OpenSearch (log
                            analytics), CloudTrail (API audit).</li>
                    </ul>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>4.7 AWS Services Inventory</h3>
                    <table style="font-size:.63rem;">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Role</th>
                                <th>Primary Usage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Amazon MSK (Kafka)</td>
                                <td>Streaming Backbone</td>
                                <td>Topics, partitions, durable event log</td>
                            </tr>
                            <tr>
                                <td>Amazon EKS</td>
                                <td>Compute Orchestration</td>
                                <td>Runs .NET containerised microservices</td>
                            </tr>
                            <tr>
                                <td>Hangfire (.NET)</td>
                                <td>Job Scheduling</td>
                                <td>CRON + recurring triggers in Scheduler svc</td>
                            </tr>
                            <tr>
                                <td>Amazon RDS (PostgreSQL)</td>
                                <td>System of Record</td>
                                <td>Schedules, configuration, transactional data</td>
                            </tr>
                            <tr>
                                <td>RDS Proxy</td>
                                <td>Connection Pooling</td>
                                <td>Stabilise DB connections / failover</td>
                            </tr>
                            <tr>
                                <td>Amazon DynamoDB</td>
                                <td>Event Store / Config</td>
                                <td>Event sourcing, CQRS projections, metadata</td>
                            </tr>
                            <tr>
                                <td>DynamoDB Streams</td>
                                <td>Change Propagation</td>
                                <td>Update read models / trigger projections</td>
                            </tr>
                            <tr>
                                <td>Amazon S3</td>
                                <td>Object Storage</td>
                                <td>Generated files, archives, snapshots</td>
                            </tr>
                            <tr>
                                <td>S3 Event Notifications</td>
                                <td>Reactive Triggers</td>
                                <td>Drive file-ready Lambda / future workflows</td>
                            </tr>
                            <tr>
                                <td>Amazon ElastiCache (Redis)</td>
                                <td>Low‑latency Cache</td>
                                <td>Hot metadata / idempotency token cache</td>
                            </tr>
                            <tr>
                                <td>Amazon Timestream</td>
                                <td>Time‑Series Metrics</td>
                                <td>Performance & reconciliation timing</td>
                            </tr>
                            <tr>
                                <td>AWS Secrets Manager</td>
                                <td>Secrets</td>
                                <td>DB / protocol credentials, rotation</td>
                            </tr>
                            <tr>
                                <td>AWS KMS</td>
                                <td>Encryption</td>
                                <td>At rest (MSK, RDS, S3) key management</td>
                            </tr>
                            <tr>
                                <td>Amazon CloudWatch</td>
                                <td>Monitoring</td>
                                <td>Lag, throughput, custom metrics, alarms</td>
                            </tr>
                            <tr>
                                <td>AWS X-Ray</td>
                                <td>Tracing</td>
                                <td>Distributed trace across services</td>
                            </tr>
                            <tr>
                                <td>AWS CloudTrail</td>
                                <td>Audit</td>
                                <td>API level governance & compliance</td>
                            </tr>
                            <tr>
                                <td>Amazon OpenSearch</td>
                                <td>Log Analytics</td>
                                <td>Centralised searchable logs</td>
                            </tr>
                            <tr>
                                <td>AWS SNS</td>
                                <td>Alert Fan‑out</td>
                                <td>Notifications (Slack / Email bridge)</td>
                            </tr>
                            <tr>
                                <td>AWS Lambda</td>
                                <td>Auxiliary Compute</td>
                                <td>Optional S3 / stream processors</td>
                            </tr>
                            <tr>
                                <td>Amazon EventBridge</td>
                                <td>Integration Bus</td>
                                <td>Scheduling / cross‑service routing (optional)</td>
                            </tr>
                            <tr>
                                <td>AWS WAF + ALB</td>
                                <td>Edge Security</td>
                                <td>Web access to Hangfire dashboard / APIs</td>
                            </tr>
                            <tr>
                                <td>IAM</td>
                                <td>Access Control</td>
                                <td>Fine‑grained roles & pod identities</td>
                            </tr>
                            <tr>
                                <td>CodePipeline / CodeBuild</td>
                                <td>CI/CD</td>
                                <td>Build & deploy containers</td>
                            </tr>
                            <tr>
                                <td>Helm / ArgoCD</td>
                                <td>GitOps</td>
                                <td>Declarative EKS releases</td>
                            </tr>
                            <tr>
                                <td>AWS Budgets / Cost Explorer</td>
                                <td>Cost Mgmt</td>
                                <td>Budget alerts & cost attribution</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>4.8 Security & IAM Highlights</h3>
                    <ul style="font-size:.7rem; line-height:1.4; margin:0 0 .9rem 1rem;">
                        <li>Pod‑level IAM roles (IRSA) – least privilege (produce vs consume topics).</li>
                        <li>Secrets only via Secrets Manager; rotation: DB 30d / API 90d.</li>
                        <li>Network: Private subnets for brokers & RDS; ALB exposes only HTTPS endpoints; WAF rules
                            (rate limit, SQLi).</li>
                        <li>End‑to‑End Encryption: TLS in transit (MSK, RDS); KMS keys per data domain at rest.</li>
                    </ul>
                    <h3>4.9 Cost Optimisation</h3>
                    <ul style="font-size:.7rem; line-height:1.4; margin:0 0 0 1rem;">
                        <li>Spot & on‑demand mixed node groups (EKS) with Cluster Autoscaler.</li>
                        <li>Right‑size partitions (avoid over‑partitioning small topics).</li>
                        <li>S3 lifecycle tiering: Standard → IA (30d) → Glacier (90d) → Deep Archive (365d).</li>
                        <li>Reserved instances / Savings Plans for steady RDS + baseline MSK capacity.</li>
                    </ul>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>4.10 Event Envelope (Canonical)</h3>
                    <pre>{
  "eventId": "guid",
  "eventType": "FileGenerationCompleted",
  "timestampUtc": "2025-09-12T10:15:22.123Z",
  "correlationId": "sched-12345",
  "causationId": "prev-event-guid",
  "schemaVersion": 1,
  "producer": {"service": "GeneratorService","instanceId": "gen-01","host": "ip-10-0-1-7"},
  "data": {"workId": "UK_BPPCTR_WORK_001","fileId": "UK_BPPCTR_FILE_001","bytes": 1842332,"checksum": "sha256:..."},
  "meta": {"replay": false, "partitionKey": "customer-12345"}
}</pre>
                    <div class="notice">Partition selection ensures ordered processing per customer while enabling
                        horizontal scale. Idempotency enforced by <code>eventId</code> uniqueness + consumer state
                        table.</div>
                </div>
                <div class="panel alt" style="margin-top:1.2rem;">
                    <h3>4.11 Domain Event Catalog</h3>
                    <div class="table-wrapper alt">
                        <table class="event-table" id="eventCatalogTable">
                            <thead>
                                <tr>
                                    <th>Event</th>
                                    <th>Category</th>
                                    <th>Emitted By</th>
                                    <th>Key Payload Elements</th>
                                    <th>Downstream Consumers</th>
                                    <th>Idempotency Note</th>
                                </tr>
                            </thead>
                            <tbody id="eventCatalogBody"></tbody>
                        </table>
                    </div>
                    <details>
                        <summary>Event Categories Legend</summary>
                        <div class="inline-kv" style="margin-top:.6rem;">
                            <div class="event-core">Core Flow</div>
                            <div class="event-infra">Infrastructure / Support</div>
                            <div class="event-critical">Critical / Failure</div>
                        </div>
                    </details>
                </div>
                <div class="panel" style="margin-top:1.2rem;">
                    <h3>4.12 Backlog Event Mapping</h3>
                    <p style="font-size:.75rem;">Each functional story lists the events it <strong>produces</strong> and
                        <strong>consumes</strong>. This enables traceability from requirement → implementation →
                        telemetry.</p>
                    <div class="filter-bar" id="eventBacklogFilters"></div>
                    <div class="search-box" style="margin-bottom:.8rem;">
                        <span style="font-size:.65rem; font-weight:600; letter-spacing:.8px;">Search</span><input
                            id="eventBacklogSearch" placeholder="Story ID / Title / Event" />
                    </div>
                    <div class="table-wrapper">
                        <table id="eventBacklogTable">
                            <thead>
                                <tr>
                                    <th>Story</th>
                                    <th>Title</th>
                                    <th>Priority</th>
                                    <th>Produces</th>
                                    <th>Consumes</th>
                                    <th>Tags</th>
                                    <th>Patch</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="sec-5" class="doc-section">
                <h2><span class="sec-index">5</span> Functional Backlog (Full)</h2>
                <p class="lead">25 implementation stories (US‑001…US‑046 non‑contiguous ordering) with Azure DevOps
                    patch arrays. This table mirrors the unified backlog page but is embedded for single‑artifact review
                    (no network dependency).</p>
                <!-- Search box removed per request -->
                <div id="functionalTagFilters" class="filter-bar"></div>
                <div style="margin-top:.6rem; display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
                    <!-- Table toggle button removed per request -->
                </div>
                <div class="table-wrapper" id="functionalTableWrapper" style="margin-top:.6rem; display:none;">
                    <table id="functionalTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title / Description / Acceptance</th>
                                <th>P</th>
                                <th>Pts</th>
                                <th>Tags</th>
                                <th>Patch</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="margin-top:1.2rem; display:flex; align-items:flex-end; gap:.8rem; flex-wrap:wrap;">
                    <!-- Cards visibility toggle removed per request; cards always shown -->
                    <!-- Sort control & JSON export removed per latest request -->
                    <span style="font-size:.6rem; opacity:.7;">Structured view with clearly separated sections
                        (Acceptance, NFR, Modernization) for each story.</span>
                </div>
                <div id="functionalCards" class="grid"
                    style="margin-top:1.1rem; display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:1rem;">
                </div>
                <div class="panel alt" id="functionalStaticCatalog" style="margin-top:1.4rem;">
                    <h3>5.1 Detailed Story Catalog (Static Reference)</h3>
                    <p style="font-size:.7rem; line-height:1.45;">Static, print‑friendly expansion of all functional
                        stories with enriched descriptions, acceptance criteria, key events, modernization overlays and
                        NFR highlights. Dynamic table/cards above remain the source of truth; this block satisfies the
                        request to embed the full detailed backlog directly in Section 5.</p>
                    <div
                        style="display:grid; gap:1rem; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); font-size:.63rem; line-height:1.35;">
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-001 Common Library</strong>
                            <div><em>Description:</em> Provide shared utility assemblies (ConfigReference, Constants,
                                Exceptions base, Mailer, BackupFiles) with zero business logic, enabling consistent
                                reuse across all services and future microservices.</div>
                            <div><em>Acceptance:</em>
                                <ul class="list-tight">
                                    <li>Project builds with zero warnings.</li>
                                    <li>Contains only stateless helpers & POCOs.</li>
                                    <li>No dependency on service, business or data layers.</li>
                                    <li>Packaged artifact versioned (semantic) & referenced by all service projects.
                                    </li>
                                    <li>Utility methods unit test branch coverage ≥ 80%.</li>
                                </ul>
                            </div>
                            <div><em>Events:</em> Produces: — • Consumes: —</div>
                            <div><em>NFR:</em> Build time &lt; 30s; zero allocations > O(n).</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-002 Constants Component</strong>
                            <div><em>Description:</em> Centralize table / column / configuration key names; eliminate
                                string literal duplication & drift.</div>
                            <ul class="list-tight">
                                <li>Single Constants namespace exported.</li>
                                <li>All DB/DataLayer classes reference constants only.</li>
                                <li>Static analysis: No raw table/column literal occurrences outside constants file.
                                </li>
                                <li>Adding a new constant requires single PR diff.</li>
                            </ul>
                            <div><em>Events:</em> —</div>
                            <div><em>NFR:</em> Lookup constant access O(1), file load once per process.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-003 DataTable Select Helper</strong>
                            <div><em>Description:</em> Safe lookup helper returning row content or Missing marker;
                                encapsulates filter predicate creation.</div>
                            <ul class="list-tight">
                                <li>Method returns value or formatted missing token.</li>
                                <li>Null DataTable returns missing token (no exception).</li>
                                <li>No string concatenation SQL risk (pure in‑memory filter).</li>
                                <li>Unit tests: null table, no match, match.</li>
                            </ul>
                            <div><em>Events:</em> —</div>
                            <div><em>NFR:</em> p95 lookup &lt; 2ms for 5k rows.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-004 Email Template Retrieval</strong>
                            <div><em>Description:</em> Retrieve email body fragments by description with graceful
                                fallback marker when missing.</div>
                            <ul class="list-tight">
                                <li>Lookup by description (case insensitive).</li>
                                <li>Returns content string or Missing marker.</li>
                                <li>No mutation of source DataTable.</li>
                                <li>Logs single warning on missing template (not per call).</li>
                            </ul>
                            <div><em>Events:</em> Consumes: — Produces: EmailNotificationSent (via downstream mail
                                send).</div>
                            <div><em>NFR:</em> Cache hit ratio ≥ 95% after warm‑up.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-005 Lifecycle Event Emails</strong>
                            <div><em>Description:</em> Emit notification emails for generation, distribution, allocation
                                and zipping major lifecycle transitions.</div>
                            <ul class="list-tight">
                                <li>Templates exist for start / success / failure for each lifecycle.</li>
                                <li>Duplicate suppression per (eventId, template).</li>
                                <li>Fallback template used if primary missing.</li>
                                <li>All emails include correlationId.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: FileGenerationCompleted, FileDistributionSucceeded •
                                Produces: EmailNotificationSent.</div>
                            <div><em>NFR:</em> Dispatch latency &lt; 2s p95.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-006 Protocol Failure Alerts</strong>
                            <div><em>Description:</em> Alerting emails when distribution protocol attempts fail beyond
                                retry threshold.</div>
                            <ul class="list-tight">
                                <li>Failure template contains protocol, attempt, filename, error code.</li>
                                <li>Suppression window prevents spam (15m same file).</li>
                                <li>Retry status appears in subject on final failure.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: FileDistributionFailed • Produces: EmailNotificationSent.
                            </div>
                            <div><em>NFR:</em> Alert dispatch &lt; 60s from failure.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-007 Central Exception Base</strong>
                            <div><em>Description:</em> Unified base exception capturing component, timestamp,
                                correlation context for observability.</div>
                            <ul class="list-tight">
                                <li>All custom exceptions inherit base.</li>
                                <li>ToString outputs structured JSON fragment.</li>
                                <li>CorrelationId included if ambient context available.</li>
                            </ul>
                            <div><em>NFR:</em> Instantiation overhead negligible (&lt;1% total allocation).</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-009 Repository Classes</strong>
                            <div><em>Description:</em> Domain repositories executing only parameterized stored
                                procedures returning DataSet/DataTable abstractions.</div>
                            <ul class="list-tight">
                                <li>No inline SQL (static analysis pass).</li>
                                <li>Every method parameterized.</li>
                                <li>Repository interfaces defined for mocking.</li>
                                <li>Connection string resolved via configuration accessor.</li>
                            </ul>
                            <div><em>Events:</em> Produces: InstanceHeartbeat (via modernization overlay).</div>
                            <div><em>NFR:</em> p95 DB call latency budgets documented per critical SP.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-010 Config Connection Strings</strong>
                            <div><em>Description:</em> Central retrieval of DB connection strings from App.config
                                (legacy) ensuring portability.</div>
                            <ul class="list-tight">
                                <li>No hardcoded connection strings anywhere.</li>
                                <li>Environment swap requires no code change.</li>
                                <li>Failure to resolve logs single error & fails fast.</li>
                            </ul>
                            <div><em>NFR:</em> Lookup overhead &lt;5ms after first read.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-012 Retrieve Schedules & Instances</strong>
                            <div><em>Description:</em> Fetch generation schedules plus instance metadata to plan
                                allocation runs.</div>
                            <ul class="list-tight">
                                <li>Returns all due schedules for time window.</li>
                                <li>Includes instance capacity metadata.</li>
                                <li>Handles empty result gracefully.</li>
                            </ul>
                            <div><em>Events:</em> Produces: AllocationPlanned, GenerationTaskAllocated,
                                DistributionTaskAllocated.</div>
                            <div><em>NFR:</em> Execution time &lt; 1s for 5k schedules.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-014 Unallocated Task Notification</strong>
                            <div><em>Description:</em> Detect and notify when tasks remain unallocated after planning
                                cycle.</div>
                            <ul class="list-tight">
                                <li>Detection logic runs once per cycle.</li>
                                <li>Email lists schedule IDs & capacity gap.</li>
                                <li>No repeat email within same cycle.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: AllocationPlanned • Produces: EmailNotificationSent.</div>
                            <div><em>NFR:</em> Detection overhead &lt; 100ms.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-016 Enumerate Pending Files</strong>
                            <div><em>Description:</em> List all pending file generation tasks with format metadata for
                                downstream workers.</div>
                            <ul class="list-tight">
                                <li>Returns format code, path info, readiness flag.</li>
                                <li>Idempotent enumeration (no state mutation).</li>
                                <li>Empty set returns valid structure.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: GenerationTaskAllocated • Produces: FileGenerationStarted,
                                FileGenerationCompleted, FileGenerationFailed.</div>
                            <div><em>NFR:</em> Enumeration p95 &lt; 2s for 10k tasks.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-020 Fetch Distribution Tasks</strong>
                            <div><em>Description:</em> Retrieve distribution tasks filtered to running instance,
                                excluding processed or failed final states.</div>
                            <ul class="list-tight">
                                <li>Filters by instance id parameter.</li>
                                <li>Excludes already completed tasks.</li>
                                <li>Orders by priority then created date.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: DistributionTaskAllocated, FileGenerationCompleted •
                                Produces: FileDistributionRequested, FileDistributionStarted, FileDistributionSucceeded,
                                FileDistributionFailed.</div>
                            <div><em>NFR:</em> Query latency p95 &lt; 750ms.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-021 Retrieve Protocol Details</strong>
                            <div><em>Description:</em> Provide complete connection details for each supported protocol
                                (FTP/SFTP/FTPS/OFTP) for a task.</div>
                            <ul class="list-tight">
                                <li>Returns host, port, credential reference.</li>
                                <li>Masks sensitive values in logs.</li>
                                <li>Handles unsupported protocol with explicit error.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: FileGenerationCompleted • Produces: ProtocolTransferStarted.
                            </div>
                            <div><em>NFR:</em> Cache miss hydration &lt; 50ms.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-023 FTP Transfer</strong>
                            <div><em>Description:</em> Execute FTP file transfer with logging of start/finish and
                                outcome.</div>
                            <ul class="list-tight">
                                <li>Supports passive mode configuration.</li>
                                <li>Logs bytes transferred & duration.</li>
                                <li>Failure paths classify transient vs permanent.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: ProtocolTransferStarted • Produces:
                                FileDistributionSucceeded / FileDistributionFailed.</div>
                            <div><em>NFR:</em> Throughput ≥ 5MB/s baseline LAN.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-025 FTPS Transfer</strong>
                            <div><em>Description:</em> Secure TLS file transfer variant with handshake telemetry.</div>
                            <ul class="list-tight">
                                <li>TLS handshake outcome logged.</li>
                                <li>Certificate validation errors surfaced.</li>
                                <li>Successful transfer metrics captured.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: ProtocolTransferStarted • Produces:
                                FileDistributionSucceeded / FileDistributionFailed.</div>
                            <div><em>NFR:</em> Negotiate TLS ≥ 1.2 only.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-029 Update Zip Status</strong>
                            <div><em>Description:</em> Persist zip operation status (success/failure & checksum) for
                                downstream distribution logic.</div>
                            <ul class="list-tight">
                                <li>Idempotent updates (no duplicate rows).</li>
                                <li>Status visible to distribution within 1s.</li>
                                <li>Checksum stored for integrity.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: FileGenerationCompleted • Produces: ArchiveCreationStarted,
                                ArchiveCreated, ArchiveCreationFailed.</div>
                            <div><em>NFR:</em> Update latency &lt; 500ms.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-030 Unzip Inbound Archives</strong>
                            <div><em>Description:</em> Extract inbound archives, validating file size and checksum
                                before staging for processing.</div>
                            <ul class="list-tight">
                                <li>Rejects archive if size exceeds configured limit.</li>
                                <li>Validates checksum matches manifest.</li>
                                <li>Extraction errors logged with code.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: ArchiveCreated • Produces: ArchiveProcessed.</div>
                            <div><em>NFR:</em> Extraction throughput ≥ 30MB/s median.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-031 Compression Failure Alerts</strong>
                            <div><em>Description:</em> Notify stakeholders when archive operations fail irrecoverably.
                            </div>
                            <ul class="list-tight">
                                <li>Email includes archive name & correlation.</li>
                                <li>Suppression window prevents duplicate within 15m.</li>
                                <li>Failure reason code enumerated.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: ArchiveCreationFailed • Produces: EmailNotificationSent.
                            </div>
                            <div><em>NFR:</em> Alert latency &lt; 60s.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-039 Log Zip/Unzip Operations</strong>
                            <div><em>Description:</em> Comprehensive auditing of archive create / extract operations.
                            </div>
                            <ul class="list-tight">
                                <li>Audit row contains archive name, file count, bytes.</li>
                                <li>Failure paths include error code.</li>
                                <li>No personally identifiable content stored.</li>
                            </ul>
                            <div><em>Events:</em> Consumes: ArchiveCreationStarted, ArchiveCreated,
                                ArchiveCreationFailed • Produces: AuditEventPersisted.</div>
                            <div><em>NFR:</em> Audit write p95 &lt; 30ms.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-040 Independent Services</strong>
                            <div><em>Description:</em> Deploy independent Windows Services (legacy) enabling isolation
                                of responsibilities.</div>
                            <ul class="list-tight">
                                <li>4 services installed and start successfully.</li>
                                <li>Stop/start one does not block others.</li>
                                <li>Logging directory isolated per service.</li>
                            </ul>
                            <div><em>Events:</em> Produces: InstanceHeartbeat.</div>
                            <div><em>NFR:</em> Service start &lt; 10s each.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-044 Protect Sensitive Errors</strong>
                            <div><em>Description:</em> Ensure no credentials or secrets appear in any logs or error
                                messages.</div>
                            <ul class="list-tight">
                                <li>Masking middleware active.</li>
                                <li>Security unit test scans synthesized sensitive patterns.</li>
                                <li>Redaction patterns centrally configured.</li>
                            </ul>
                            <div><em>Events:</em> Produces: SecurityEvent.</div>
                            <div><em>NFR:</em> Redaction overhead &lt; 2% CPU.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-045 Central Secret Access</strong>
                            <div><em>Description:</em> Central accessor for secrets / config with rotation awareness
                                replacing direct key usage.</div>
                            <ul class="list-tight">
                                <li>No direct config key lookups remain.</li>
                                <li>Rotation event updates in-memory cache within 5m.</li>
                                <li>Secrets never written to logs.</li>
                            </ul>
                            <div><em>Events:</em> Produces: InstanceHeartbeat.</div>
                            <div><em>NFR:</em> Cache hit ≥ 95%.</div>
                        </div>
                        <div class="panel" style="padding:.6rem .7rem;">
                            <strong>US-046 Preserve Layered Architecture</strong>
                            <div><em>Description:</em> Maintain strict dependency direction (Services → Business → Data
                                → Common) to avoid architectural erosion.</div>
                            <ul class="list-tight">
                                <li>Static analysis: zero reverse references.</li>
                                <li>Solution build fails on new circular dependency.</li>
                                <li>Layer diagram documented & current.</li>
                            </ul>
                            <div><em>NFR:</em> Enforcement integrated into CI quality gate.</div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="sec-6" class="doc-section">
                <h2><span class="sec-index">6</span> Stored Procedure Backlog</h2>
                <p class="lead">86 stored procedure user stories covering allocation, generation, resend, distribution,
                    compression, reconciliation, and configuration concerns. Below you can explore full narrative
                    details (purpose, inputs, outputs, rules, edge cases, security, dependencies) parsed from
                    <code>sp-userstories.md</code>.</p>
                <div class="grid cols-3" id="spMetrics" style="margin-bottom:1.2rem;"></div>
                <div id="spEpicContainer"></div>
                <!-- Dynamic SP details section (6.1) removed per user request -->
                <div class="panel alt" id="spStaticCatalog" style="margin-top:1.2rem;">
                    <h3>6.1 Stored Procedure Story Catalog (Static Reference)</h3>
                    <p style="font-size:.7rem;line-height:1.45;">Print‑friendly snapshot of all stored procedure user
                        stories mirroring the dynamic cards above. Generated on load for single‑artifact portability (no
                        interaction required). Each entry captures purpose, inputs, outputs, rules, edge cases,
                        performance, security and dependencies.</p>
                    <div id="spStaticGrid"
                        style="display:grid;gap:.9rem;grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); font-size:.6rem;line-height:1.35;">
                    </div>
                </div>
            </section>
            <!-- Original Business Capability Stories section removed (moved above as Section 3) -->
            <!-- End reorder edits -->
            <div class="scroll-x" style="margin:.6rem 0 1.2rem;">
                <table style="font-size:.6rem; min-width:1200px;">
                    <thead>
                        <tr>
                            <th style="text-align:left;">Domain</th>
                            <th style="text-align:left;">Primary Purpose</th>
                            <th style="text-align:left;">Primary Stakeholder</th>
                            <th style="text-align:left;">Key Capabilities</th>
                            <th style="text-align:left;">Representative SPs</th>
                            <th style="text-align:left;">Downstream / Dependencies</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Data Generation & Formats</td>
                            <td>Produce files across supported business formats with correct rules & totals</td>
                            <td>Business User</td>
                            <td>Multi-format extraction, parent & customer scope, control totals, invoice/uninvoice</td>
                            <td>SP-019..SP-033</td>
                            <td>Reconciliation, Distribution, Archival</td>
                        </tr>
                        <tr>
                            <td>Distribution & Communication</td>
                            <td>Deliver generated artifacts securely via multiple protocols</td>
                            <td>Business Partner</td>
                            <td>Email attachments, FTP/SFTP/FTPS/OFTP, compression, delivery confirmation</td>
                            <td>SP-055, SP-006</td>
                            <td>Generation Completed Events, Protocol Adapters, Notification</td>
                        </tr>
                        <tr>
                            <td>Reconciliation & Control</td>
                            <td>Ensure data integrity between source transactions and distributed outputs</td>
                            <td>Financial Controller</td>
                            <td>Counts & total validation, variance detection, status tracking</td>
                            <td>SP-014..SP-018, SP-079..SP-086</td>
                            <td>Generation Outputs, Audit, Notification</td>
                        </tr>
                        <tr>
                            <td>Multi-Country Operations</td>
                            <td>Apply localization rules and naming for each supported country</td>
                            <td>International Business Manager</td>
                            <td>Country dataset selection, naming conventions, currency handling</td>
                            <td>Format Logic (Code)</td>
                            <td>Generation, Distribution Compliance</td>
                        </tr>
                        <tr>
                            <td>Administrative Control</td>
                            <td>Govern distribution process & approvals</td>
                            <td>System Administrator</td>
                            <td>Approval workflow, indicators, notifications, audit trail</td>
                            <td>SP-001 (Scheduling), SP-002, SP-003</td>
                            <td>All downstream lifecycle services</td>
                        </tr>
                        <tr>
                            <td>Parent-Child Relationships</td>
                            <td>Support hierarchical aggregation & reporting</td>
                            <td>Corporate Customer</td>
                            <td>Parent aggregation, child detail, fee handling, ordering</td>
                            <td>SP-019 family (aggregation logic)</td>
                            <td>Reporting, Billing, Reconciliation</td>
                        </tr>
                        <tr>
                            <td>Error Handling & Notification</td>
                            <td>Surface operational & business issues rapidly</td>
                            <td>Support Team</td>
                            <td>Warning/delay emails, failure detection, resend flows</td>
                            <td>SP-007 (heartbeat), SP variance SP-079</td>
                            <td>Notification, Monitoring, Audit</td>
                        </tr>
                        <tr>
                            <td>File Management</td>
                            <td>Optimize storage, movement, and packaging of files</td>
                            <td>System Operator</td>
                            <td>Compression, attachment handling, naming, versioning</td>
                            <td>SP-029 (archive), Zip/Move/Unzip code</td>
                            <td>Distribution, Archive, Retention Policies</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Business stories narrative block removed per user request -->
            <div id="businessStoriesContent" style="font-size:.7rem; line-height:1.4; display:none;"></div>
    </div>
    </section>
    <section id="sec-7" class="doc-section">
        <h2><span class="sec-index">7</span> Complete Test Suite</h2>
        <p class="lead">Comprehensive quality suite (111 defined tests) spanning functional, data integrity, protocol,
            performance, resilience, and modernization alignment. This enriched section adds risk tiers, coverage
            matrices, representative examples, and filtering utilities for engineering & audit.</p>
        <div class="panel mt-md">
            <h3>7.1 Coverage Summary Matrix</h3>
            <table class="compact">
                <thead>
                    <tr>
                        <th>Dimension</th>
                        <th>Scope</th>
                        <th>Count</th>
                        <th>Risk Tier</th>
                        <th>Primary Sources</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="testCoverageMatrixBody">
                    <tr>
                        <td>Functional (User Stories)</td>
                        <td>US-001..US-025</td>
                        <td>25</td>
                        <td>High</td>
                        <td>Business rules</td>
                        <td>All core flows covered</td>
                    </tr>
                    <tr>
                        <td>Stored Procedures</td>
                        <td>SP-001..SP-086</td>
                        <td>40</td>
                        <td>High</td>
                        <td>Data contracts</td>
                        <td>Critical & variant paths</td>
                    </tr>
                    <tr>
                        <td>Distribution Protocols</td>
                        <td>FTP/SFTP/FTPS/OFTP/Email</td>
                        <td>16</td>
                        <td>Medium</td>
                        <td>Adapters</td>
                        <td>Positive + error states</td>
                    </tr>
                    <tr>
                        <td>Resilience / Recovery</td>
                        <td>Crash, retry, replay</td>
                        <td>8</td>
                        <td>High</td>
                        <td>Allocator, Distributor</td>
                        <td>Heartbeat & retry semantics</td>
                    </tr>
                    <tr>
                        <td>Performance / Load</td>
                        <td>Gen/Dist throughput</td>
                        <td>6</td>
                        <td>Medium</td>
                        <td>File build & transfer</td>
                        <td>Baseline + stress</td>
                    </tr>
                    <tr>
                        <td>Security / Config</td>
                        <td>Secrets, config, authZ</td>
                        <td>4</td>
                        <td>Medium</td>
                        <td>ConfigReference</td>
                        <td>Redaction & invalid config</td>
                    </tr>
                    <tr>
                        <td>Data Integrity</td>
                        <td>Checksum, reconciliation</td>
                        <td>7</td>
                        <td>High</td>
                        <td>Reconciliation logic</td>
                        <td>Variance & duplicate guard</td>
                    </tr>
                    <tr>
                        <td>Modernization Alignment</td>
                        <td>Event readiness</td>
                        <td>5</td>
                        <td>Medium</td>
                        <td>Overlay mapping</td>
                        <td>Schema & idempotency prep</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="panel alt mt-lg">
            <h3>7.2 Risk Tier Definitions</h3>
            <ul class="risk-tier-list">
                <li><strong>High</strong>: Direct revenue / regulatory impact, data integrity, or core workflow
                    continuity.</li>
                <li><strong>Medium</strong>: Affects SLA or partner satisfaction; recoverable without data loss.</li>
                <li><strong>Low</strong>: Cosmetic or auxiliary telemetry impacts.</li>
            </ul>
            <p class="muted tight">Execution priority enforces High first on regression, Medium on rolling cadence, Low
                on release candidate stabilization.</p>
        </div>
        <div class="panel mt-lg">
            <h3>7.3 Test Taxonomy & Mapping</h3>
            <table class="compact">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Examples</th>
                        <th>Trace Targets</th>
                        <th>Entry Criteria</th>
                        <th>Exit Criteria</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Functional</td>
                        <td>TC-US-001, TC-US-010</td>
                        <td>User Stories</td>
                        <td>Build success</td>
                        <td>All pass; no blocker defects</td>
                    </tr>
                    <tr>
                        <td>SP Contract</td>
                        <td>TC-SP-004, TC-SP-021</td>
                        <td>Stored Procedures</td>
                        <td>DB migrations applied</td>
                        <td>Output schema validated</td>
                    </tr>
                    <tr>
                        <td>Protocol</td>
                        <td>TC-US-FTP-01</td>
                        <td>Distribution Adapters</td>
                        <td>Endpoint credentials available</td>
                        <td>Success + negative states</td>
                    </tr>
                    <tr>
                        <td>Resilience</td>
                        <td>TC-RES-CRASH-01</td>
                        <td>Allocator / Distributor</td>
                        <td>Chaos harness enabled</td>
                        <td>Recovery within SLA</td>
                    </tr>
                    <tr>
                        <td>Performance</td>
                        <td>TC-PERF-GEN-01</td>
                        <td>Generator</td>
                        <td>Baseline dataset loaded</td>
                        <td>P95 targets met</td>
                    </tr>
                    <tr>
                        <td>Security</td>
                        <td>TC-SEC-CONFIG-01</td>
                        <td>ConfigReference</td>
                        <td>Secrets masked test harness</td>
                        <td>No sensitive leakage</td>
                    </tr>
                    <tr>
                        <td>Integrity</td>
                        <td>TC-INTEG-CHK-02</td>
                        <td>Checksum/Reconcile</td>
                        <td>Golden files prepared</td>
                        <td>Zero false variance</td>
                    </tr>
                    <tr>
                        <td>Modernization</td>
                        <td>TC-MOD-SCHEMA-01</td>
                        <td>Event Overlay</td>
                        <td>Overlay JSON loaded</td>
                        <td>Schema diffs resolved</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="panel alt" style="margin-top:1.2rem;">
            <h3>7.4 Representative Test Specifications</h3>
            <details open>
                <summary style="font-weight:600;cursor:pointer;">Example: File Generation Happy Path (TC-US-005)
                </summary>
                <pre style="font-size:.6rem; line-height:1.25;">Title: TC-US-005 File Generation Success
Preconditions:
  - Valid schedule exists (status=Ready)
  - Formats: 2 active (CSV, XML)
Steps:
  1 Trigger allocation for schedule S123
  2 Generator picks tasks and invokes SP-019..SP-022
  3 Files written to staging path, zipped, status updated
Assertions:
  - DB: generation_task rows status=Completed
  - Archive present; checksum stored
  - Notification queued (email not sent inline)
  - No error entries
Risks Covered: Core generation path, multi-format consistency.</pre>
            </details>
            <details>
                <summary style="font-weight:600;cursor:pointer;">Example: Distribution Retry Exhaustion (TC-RES-DIST-03)
                </summary>
                <pre style="font-size:.6rem; line-height:1.25;">Title: TC-RES-DIST-03 Distribution Retry Exhaustion
Scenario: SFTP endpoint unreachable → retries exhausted
Config: maxRetries=3, backoff exponential (1s,2s,4s)
Steps:
  1 Mark target endpoint offline (simulate network failure)
  2 Initiate distribution task D456
  3 Observe three retry attempts
  4 Task transitions to Failed; escalation email queued
Assertions:
  - Retry count=3, durations increasing
  - Failure code=EndpointUnreachable
  - No further retries scheduled
  - Audit record persisted
Failure Mode Addressed: Partner downtime isolation + alerting.</pre>
            </details>
            <details>
                <summary style="font-weight:600;cursor:pointer;">Example: Stored Procedure Contract (TC-SP-021)
                </summary>
                <pre style="font-size:.6rem; line-height:1.25;">Title: TC-SP-021 SP-021 AllocateGenerationWork Output Schema
Goal: Validate columns & invariants
Steps:
  1 Seed schedules with 3 unallocated rows
  2 Execute SP-021
  3 Capture dataset tables[0]
Assertions:
  - Columns: TaskId, ScheduleId, FormatCode, Status, Attempt
  - Row count=3
  - Status=Pending for each
  - No duplicate TaskId values
Edge: Re-run returns zero rows (idempotency)</pre>
            </details>
            <details>
                <summary style="font-weight:600;cursor:pointer;">Example: Modernization Schema Alignment
                    (TC-MOD-SCHEMA-01)</summary>
                <pre style="font-size:.6rem; line-height:1.25;">Title: TC-MOD-SCHEMA-01 Event Overlay Field Presence
Objective: Ensure modernization overlay includes required event metadata fields
Fields Required: serviceOwner, produces[], consumes[], partitionKey, modernizationNotes
Steps:
  1 Load data-modernization JSON object
  2 Iterate all US-* entries
  3 Validate required keys present & non-empty (except optional partitionKey)
Assertions:
  - 0 missing required fields
  - partitionKey only present where produces includes file.* topics
Outcome: Confirms readiness for event publishing instrumentation.</pre>
            </details>
        </div>
        <div class="panel" style="margin-top:1.4rem;">
            <h3>7.5 Execution Strategy</h3>
            <ul style="font-size:.7rem; line-height:1.35; margin:0 0 .6rem 1rem;">
                <li><strong>Pipeline Stages</strong>: Lint → Unit/SP contract → Functional → Resilience (nightly) →
                    Performance (scheduled).</li>
                <li><strong>Shift‑Left</strong>: SP contract tests run on every PR to catch schema drift early.</li>
                <li><strong>Data Management</strong>: Deterministic seed scripts; golden file artifacts stored
                    versioned.</li>
                <li><strong>Isolation</strong>: Each functional test idempotent; cleans or uses unique identifiers.</li>
                <li><strong>Observability Hooks</strong>: Test harness emits structured JSON for timing & flakiness
                    dashboards.</li>
            </ul>
        </div>
        <div class="panel alt" style="margin-top:1.4rem;">
            <h3>7.6 Failure Classification Model</h3>
            <table style="font-size:.63rem;">
                <thead>
                    <tr>
                        <th>Failure Type</th>
                        <th>Indicator</th>
                        <th>Immediate Action</th>
                        <th>Owner</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Schema Drift</td>
                        <td>SP test column mismatch</td>
                        <td>Block merge; update SP or DTO</td>
                        <td>Data Engineer</td>
                    </tr>
                    <tr>
                        <td>Flaky Timing</td>
                        <td>Intermittent timeout</td>
                        <td>Collect traces; mark quarantined</td>
                        <td>Platform QA</td>
                    </tr>
                    <tr>
                        <td>Performance Regression</td>
                        <td>P95 > threshold</td>
                        <td>Bisect commit; profile hotspot</td>
                        <td>Service Owner</td>
                    </tr>
                    <tr>
                        <td>Data Integrity</td>
                        <td>Checksum variance false positive</td>
                        <td>Re-evaluate reconciliation logic</td>
                        <td>Generator Team</td>
                    </tr>
                    <tr>
                        <td>Resilience Gap</td>
                        <td>Crash test not recovering</td>
                        <td>Add guard / improve heartbeat</td>
                        <td>Allocator Team</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="panel" style="margin-top:1.4rem;">
            <h3>7.7 Interactive Test Browser</h3>
            <div class="search-box" style="margin:.4rem 0 .7rem;">
                <span style="font-size:.65rem;font-weight:600;letter-spacing:.8px;">Search</span>
                <input id="testSearch" placeholder="Filter by test id, purpose, scenario keyword..." />
            </div>
            <div class="filter-bar" id="testTypeFilters"></div>
            <div class="table-wrapper alt" style="margin-bottom:1rem;">
                <table id="testMetricsTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Count</th>
                            <th>Coverage Focus</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="testListContainer"></div>
            <button class="btn secondary" id="exportTestsJsonBtn" style="margin-top:1rem;">Export Test Catalog
                JSON</button>
        </div>
        <div class="panel alt" style="margin-top:1.2rem;">
            <h3>7.8 Future Enhancements</h3>
            <ul style="font-size:.7rem; line-height:1.35; margin:0 0 .6rem 1rem;">
                <li>Introduce contract snapshot diffing for SP schemas per commit.</li>
                <li>Add synthetic event stream tests once Kafka topics live.</li>
                <li>Automated performance regression gating (trend slope checks).</li>
                <li>Scenario model-based test generation for edge combinatorics.</li>
                <li>Probabilistic flakiness scoring and quarantine automation.</li>
            </ul>
        </div>
    </section>
    <section id="sec-8" class="doc-section">
        <h2><span class="sec-index">8</span> Implementation &amp; Summary</h2>
        <p class="lead">Consolidated synthesis of Sections 1–3 translating executive intent, deep analysis, and
            capability stories into actionable engineering directives and modernization guardrails.</p>
        <div class="panel">
            <h3>8.1 Strategic Mapping</h3>
            <table class="compact">
                <thead>
                    <tr>
                        <th>Source Section</th>
                        <th>Key Artifacts</th>
                        <th>Engineering Output</th>
                        <th>Modernization Leverage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1 Executive Summary</td>
                        <td>Vision, scope, improvements</td>
                        <td>Architecture north star, success metrics</td>
                        <td>Defines measurable modernization outcomes</td>
                    </tr>
                    <tr>
                        <td>1A Reverse/Forward Flow</td>
                        <td>Phase progression model</td>
                        <td>Work sequencing & traceability model</td>
                        <td>Minimizes rework / duplicate discovery</td>
                    </tr>
                    <tr>
                        <td>2 EMedia Analysis</td>
                        <td>Layer diagrams, inventory, patterns</td>
                        <td>Refactoring targets & risk register</td>
                        <td>Safely carves microservice boundaries</td>
                    </tr>
                    <tr>
                        <td>3 Business Capability Stories</td>
                        <td>Value-centric capability framing</td>
                        <td>Prioritized user story seeds</td>
                        <td>Ensures feature slicing aligns to value</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="panel alt mt-md">
            <h3>8.2 Implementation Pillars</h3>
            <ul style="margin:.4rem 0 0 1rem; font-size:.7rem; line-height:1.35;">
                <li><strong>Traceability First:</strong> Story → SP Narrative → Test → Event → Deployment config.</li>
                <li><strong>Idempotent Design:</strong> Allocation & distribution flows replay-safe with correlation
                    IDs.</li>
                <li><strong>Data Contract Stability:</strong> Centralized constants & SP output schemas versioned.</li>
                <li><strong>Event Envelope Discipline:</strong> Mandatory causation + correlation for observability.
                </li>
                <li><strong>Progressive Hardening:</strong> High-risk SP and reconciliation logic front-loaded in
                    sprints.</li>
            </ul>
        </div>
        <div class="panel mt-md">
            <h3>8.3 Execution Guidelines</h3>
            <table class="compact">
                <thead>
                    <tr>
                        <th>Theme</th>
                        <th>Directive</th>
                        <th>Metric</th>
                        <th>Exit Condition</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Refactoring</td>
                        <td>Isolate distributable services from monolith</td>
                        <td>Service boundary ADRs approved</td>
                        <td>All external calls abstracted</td>
                    </tr>
                    <tr>
                        <td>Database</td>
                        <td>Parameterize all SP access paths</td>
                        <td>Static scan: 0 inline SQL literals</td>
                        <td>CI gate passes on scan</td>
                    </tr>
                    <tr>
                        <td>Events</td>
                        <td>Emit domain events post mutation commit</td>
                        <td>100% critical flows instrumented</td>
                        <td>Event schema catalog frozen v1</td>
                    </tr>
                    <tr>
                        <td>Testing</td>
                        <td>Map tests to risk tiers early</td>
                        <td>High tier coverage ≥ 95%</td>
                        <td>No Sev1 gap untested</td>
                    </tr>
                    <tr>
                        <td>Observability</td>
                        <td>Adopt correlation logging pattern</td>
                        <td>Log correlation field adoption</td>
                        <td>Trace spans cover 90% SP calls</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="panel alt mt-md">
            <h3>8.4 Consolidated Action Backlog (Extract)</h3>
            <table class="compact">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Action</th>
                        <th>Rationale</th>
                        <th>Dependency</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>A-01</td>
                        <td>Finalize event envelope schema v1</td>
                        <td>Consistent downstream parsing</td>
                        <td>Story US-004</td>
                    </tr>
                    <tr>
                        <td>A-02</td>
                        <td>Centralize constants namespace</td>
                        <td>Reduce duplication & drift</td>
                        <td>US-002, SP param review</td>
                    </tr>
                    <tr>
                        <td>A-03</td>
                        <td>Partition SP narratives by ownership</td>
                        <td>Service boundary clarity</td>
                        <td>Analysis inventory</td>
                    </tr>
                    <tr>
                        <td>A-04</td>
                        <td>Introduce reconciliation variance events</td>
                        <td>Faster operational response</td>
                        <td>SP-079..086 tests</td>
                    </tr>
                    <tr>
                        <td>A-05</td>
                        <td>Implement correlation logging middleware</td>
                        <td>Traceability & debugging</td>
                        <td>Envelope finalized</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="panel mt-md">
            <h3>8.5 Rollout Sequence (Incremental)</h3>
            <ol style="margin:.4rem 0 0 1.1rem; font-size:.7rem; line-height:1.35;">
                <li>Stabilize constants + SP parameter contracts.</li>
                <li>Implement envelope & emit events for generation completion.</li>
                <li>Refactor distributor into isolated deployable.</li>
                <li>Add reconciliation variance event emission.</li>
                <li>Harden test coverage & resilience scenarios.</li>
            </ol>
        </div>
        <div class="panel alt mt-md">
            <h3>8.6 Summary Statement</h3>
            <p style="font-size:.7rem; line-height:1.45;">The initial three sections establish a traceable chain from
                executive objectives through technical inventory to capability framing. This Implementation & Summary
                section converts that foundation into a prioritized, risk-aware engineering program emphasizing
                event-driven modernization, contract stability, and early validation of high-risk database logic. It
                serves as the transition checkpoint before deeper backlog expansion, stored procedure refinement, and
                full test suite execution.</p>
        </div>
    </section>
    </main>
    </div>
    <footer class="site">Generated locally • <span id="generatedStamp"></span> • Theme persistent • © EMedia V4.5
        Documentation</footer>
    <div class="toast" id="toast"></div>
    <script id="data-high" type="application/json">{"metadata":{"description":"Implementation-ready user stories (enriched) for Azure DevOps import.","generatedDate":"2025-09-14","totalStories":25},"stories":[
    {"key":"US-001","epic":"E01","title":"Common Library","priority":1,"points":5,"tags":["Common","Foundation","ImplementationReady"],"description":"Provide shared utility assemblies (constants, config reference, exceptions, mail, backup) with zero business logic.","acceptanceCriteria":["Project builds with zero warnings","Contains only stateless helpers & POCOs","No dependency on higher layers","Packaged & versioned (semantic)",">=80% branch coverage"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-001 Common Library"},{"op":"add","path":"/fields/System.Description","value":"Provide shared utility assemblies (constants, config reference, exceptions, mail, backup) with zero business logic."}]},
    {"key":"US-002","epic":"E01","title":"Constants Component","priority":1,"points":3,"tags":["Common","Maintainability","ImplementationReady"],"description":"Centralize table/column/config keys; eliminate literal duplication.","acceptanceCriteria":["Single constants namespace","All DB calls use constants","Static analysis: 0 raw literals","Easy diff for new keys"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-002 Constants Component"},{"op":"add","path":"/fields/System.Description","value":"Centralize table/column/config keys; eliminate literal duplication."}]},
    {"key":"US-003","epic":"E01","title":"DataTable Select Helper","priority":2,"points":2,"tags":["Common","Quality","ImplementationReady"],"description":"Safe lookup API returning value or Missing marker; encapsulates predicate creation.","acceptanceCriteria":["Returns value or Missing token","Null table returns Missing","No inline SQL risk","Unit tests: null/miss/match"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-003 DataTable Select Helper"},{"op":"add","path":"/fields/System.Description","value":"Safe lookup API returning value or Missing marker; encapsulates predicate creation."}]},
    {"key":"US-032","epic":"E10","title":"Centralized Config Access","priority":2,"points":5,"tags":["Configuration","Foundation","ImplementationReady"],"description":"Typed accessor for connections, paths, endpoints via ConfigReference wrapper.","acceptanceCriteria":["No raw key usage","Null/empty key throws friendly error","Thread-safe cache layer","Config changes reflect after reload"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-032 Centralized Config Access"},{"op":"add","path":"/fields/System.Description","value":"Typed accessor for connections, paths, endpoints via ConfigReference wrapper."}]},
    {"key":"US-045","epic":"E14","title":"Central Secret Access","priority":1,"points":5,"tags":["Security","Configuration","ImplementationReady"],"description":"Centralize secrets/config retrieval (no direct key use) with rotation awareness.","acceptanceCriteria":["All lookups via Accessor","Rotation detected <5m","Secrets never logged"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-045 Central Secret Access"},{"op":"add","path":"/fields/System.Description","value":"Centralize secrets/config retrieval (no direct key use) with rotation awareness."}]},
    {"key":"US-010","epic":"E04","title":"Config Connection Strings","priority":1,"points":2,"tags":["Configuration","Data","ImplementationReady"],"description":"DB connections sourced from App.config only (legacy) to promote portability.","acceptanceCriteria":["No hardcoded connection strings","Environment changes need no code","Failure logs once & fails fast"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-010 Config Connection Strings"},{"op":"add","path":"/fields/System.Description","value":"DB connections sourced from App.config only (legacy) to promote portability."}]},
    {"key":"US-009","epic":"E04","title":"Repository Classes","priority":1,"points":8,"tags":["Data","Repository","ImplementationReady"],"description":"Domain repositories calling only parameterized stored procedures & returning DataSet/DataTable.","acceptanceCriteria":["No inline SQL","Parameterized every call","Interfaces for mocking","Connection string via config accessor"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-009 Repository Classes"},{"op":"add","path":"/fields/System.Description","value":"Domain repositories calling only parameterized stored procedures & returning DataSet/DataTable."}]},
    {"key":"US-007","epic":"E03","title":"Central Exception Base","priority":1,"points":3,"tags":["Errors","Foundation","ImplementationReady"],"description":"Base exception capturing component, timestamp & correlation context.","acceptanceCriteria":["All custom exceptions inherit","ToString emits structured JSON","CorrelationId included when set"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-007 Central Exception Base"},{"op":"add","path":"/fields/System.Description","value":"Base exception capturing component, timestamp & correlation context."}]},
    {"key":"US-044","epic":"E14","title":"Protect Sensitive Errors","priority":1,"points":3,"tags":["Security","Logging","ImplementationReady"],"description":"Prevent credentials/PII from appearing in logs via redaction middleware.","acceptanceCriteria":["Redaction patterns centrally configured","Security regression test passes","0 sensitive tokens in synthetic log scan"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-044 Protect Sensitive Errors"},{"op":"add","path":"/fields/System.Description","value":"Prevent credentials/PII from appearing in logs via redaction middleware."}]},
    {"key":"US-004","epic":"E02","title":"Email Template Retrieval","priority":2,"points":3,"tags":["Email","Templates","ImplementationReady"],"description":"Retrieve email template content by description with fallback marker when missing.","acceptanceCriteria":["Lookup by description","Returns template or Missing","Logs one warning per missing id"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-004 Email Template Retrieval"},{"op":"add","path":"/fields/System.Description","value":"Retrieve email template content by description with fallback marker when missing."}]},
    {"key":"US-005","epic":"E02","title":"Lifecycle Event Emails","priority":2,"points":5,"tags":["Email","Notifications","ImplementationReady"],"description":"Send emails for generation, distribution, allocation, zipping lifecycle events.","acceptanceCriteria":["Templates exist for start/success/failure","Duplicate suppression per (eventId,template)","Includes correlationId","Fallback template for missing"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-005 Lifecycle Event Emails"},{"op":"add","path":"/fields/System.Description","value":"Send emails for generation, distribution, allocation, zipping lifecycle events."}]},
    {"key":"US-006","epic":"E02","title":"Protocol Failure Alerts","priority":2,"points":3,"tags":["Email","Alerts","ImplementationReady"],"description":"Send alert emails on protocol failures when retries exhausted.","acceptanceCriteria":["Includes protocol, filename, attempt","Suppression window 15m","Retry count in subject when fatal"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-006 Protocol Failure Alerts"},{"op":"add","path":"/fields/System.Description","value":"Send alert emails on protocol failures when retries exhausted."}]},
    {"key":"US-012","epic":"E05","title":"Retrieve Schedules & Instances","priority":1,"points":5,"tags":["Allocation","Scheduling","ImplementationReady"],"description":"Fetch generation schedules + instance metadata to plan allocation runs.","acceptanceCriteria":["Returns all due schedules","Includes capacity metadata","Handles empty set gracefully"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-012 Retrieve Schedules & Instances"},{"op":"add","path":"/fields/System.Description","value":"Fetch generation schedules + instance metadata to plan allocation runs."}]},
    {"key":"US-014","epic":"E05","title":"Unallocated Task Notification","priority":2,"points":3,"tags":["Allocation","Alerts","ImplementationReady"],"description":"Notify when tasks remain unallocated after planning cycle.","acceptanceCriteria":["Email lists capacity gap","Single email per cycle","Logged with correlation"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-014 Unallocated Task Notification"},{"op":"add","path":"/fields/System.Description","value":"Notify when tasks remain unallocated after planning cycle."}]},
    {"key":"US-016","epic":"E06","title":"Enumerate Pending Files","priority":1,"points":5,"tags":["Generation","Files","ImplementationReady"],"description":"List pending generation files + format metadata for workers.","acceptanceCriteria":["Returns format code, path, readiness","Idempotent enumeration","Empty set valid"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-016 Enumerate Pending Files"},{"op":"add","path":"/fields/System.Description","value":"List pending generation files + format metadata for workers."}]},
    {"key":"US-020","epic":"E07","title":"Fetch Distribution Tasks","priority":1,"points":5,"tags":["Distribution","Tasks","ImplementationReady"],"description":"Get distribution tasks for current instance (unprocessed only).","acceptanceCriteria":["Filters by instance id","Excludes completed tasks","Orders by priority then created"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-020 Fetch Distribution Tasks"},{"op":"add","path":"/fields/System.Description","value":"Get distribution tasks for current instance (unprocessed only)."}]},
    {"key":"US-021","epic":"E07","title":"Retrieve Protocol Details","priority":1,"points":3,"tags":["Distribution","Protocols","ImplementationReady"],"description":"Return full connection details for a protocol (FTP/SFTP/FTPS/OFTP).","acceptanceCriteria":["Returns host, port, credentials ref","Handles unsupported protocol explicit","Masks sensitive values in logs"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-021 Retrieve Protocol Details"},{"op":"add","path":"/fields/System.Description","value":"Return full connection details for a protocol (FTP/SFTP/FTPS/OFTP)."}]},
    {"key":"US-023","epic":"E08","title":"FTP Transfer","priority":1,"points":3,"tags":["Protocols","FTP","ImplementationReady"],"description":"Execute FTP transfer with logged start/finish + metrics.","acceptanceCriteria":["Supports passive mode","Logs bytes + duration","Classifies transient vs permanent"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-023 FTP Transfer"},{"op":"add","path":"/fields/System.Description","value":"Execute FTP transfer with logged start/finish + metrics."}]},
    {"key":"US-025","epic":"E08","title":"FTPS Transfer","priority":1,"points":3,"tags":["Protocols","FTPS","ImplementationReady"],"description":"Execute secure FTPS transfer capturing TLS handshake telemetry.","acceptanceCriteria":["TLS handshake outcome logged","Certificate validation errors surfaced","Metrics for duration & bytes"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-025 FTPS Transfer"},{"op":"add","path":"/fields/System.Description","value":"Execute secure FTPS transfer capturing TLS handshake telemetry."}]},
    {"key":"US-029","epic":"E09","title":"Update Zip Status","priority":2,"points":3,"tags":["Compression","Status","ImplementationReady"],"description":"Persist zip operation status (success/failure & checksum).","acceptanceCriteria":["Idempotent update","Status visible to distribution","Checksum stored"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-029 Update Zip Status"},{"op":"add","path":"/fields/System.Description","value":"Persist zip operation status (success/failure & checksum)."}]},
    {"key":"US-030","epic":"E09","title":"Unzip Inbound Archives","priority":2,"points":5,"tags":["Compression","Inbound","ImplementationReady"],"description":"Extract inbound archives validating size & checksum.","acceptanceCriteria":["Reject oversize archive","Validate checksum","Logs extraction errors"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-030 Unzip Inbound Archives"},{"op":"add","path":"/fields/System.Description","value":"Extract inbound archives validating size & checksum."}]},
    {"key":"US-031","epic":"E09","title":"Compression Failure Alerts","priority":2,"points":3,"tags":["Compression","Alerts","ImplementationReady"],"description":"Send alert on compression failures (single per window).","acceptanceCriteria":["Email includes archive name","Suppression window 15m","Failure reason code enumerated"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-031 Compression Failure Alerts"},{"op":"add","path":"/fields/System.Description","value":"Send alert on compression failures (single per window)."}]},
    {"key":"US-039","epic":"E12","title":"Log Zip/Unzip Operations","priority":3,"points":3,"tags":["Audit","Compression","ImplementationReady"],"description":"Audit archive create/extract operations.","acceptanceCriteria":["Audit row: name,count,bytes","Failure paths include error code","No PII stored"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-039 Log Zip/Unzip Operations"},{"op":"add","path":"/fields/System.Description","value":"Audit archive create/extract operations."}]},
    {"key":"US-040","epic":"E13","title":"Independent Services","priority":2,"points":5,"tags":["Services","Deployment","ImplementationReady"],"description":"Deploy 4 independent Windows Services (legacy isolation).","acceptanceCriteria":["4 services install/start","Restart one doesn't block others","Isolated logging directories"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-040 Independent Services"},{"op":"add","path":"/fields/System.Description","value":"Deploy 4 independent Windows Services (legacy isolation)."}]},
    {"key":"US-046","epic":"E14","title":"Preserve Layered Architecture","priority":1,"points":3,"tags":["Architecture","Quality","ImplementationReady"],"description":"Maintain Services→Business→Data→Common dependency flow.","acceptanceCriteria":["Static analysis: no reverse deps","Build fails on circular dependency","Layer diagram current"],"patch":[{"op":"add","path":"/fields/System.Title","value":"US-046 Preserve Layered Architecture"},{"op":"add","path":"/fields/System.Description","value":"Maintain Services→Business→Data→Common dependency flow."}]}
    ]}</script>
    <!-- Embedded datasets (kept inline but hidden from visual flow) -->
    <script id="data-tests-excerpt"
        type="application/json">{"examples":[{"id":"TC-US-009","title":"Repository uses parameterized SP calls","assert":"All repository calls include parameters; no inline SQL"},{"id":"TC-SP-019","title":"Agency National dataset shape","assert":"Result includes header/detail/trailer tables with control totals"},{"id":"TC-US-016","title":"Pending file enumeration returns format details","assert":"Each row includes format code + readiness flag"}]}</script>
    <!-- Modernization augmentation dataset (service ownership, events & NFR overlays) -->
    <script id="data-modernization" type="application/json">{
            "US-001": {"serviceOwner":"Shared Library","modernizationNotes":"Refactored into shared NuGet/package consumed by all microservices (Generator, Distributor, Scheduler, Archive, Notification, Audit).","nfr":["Zero runtime logic – pure utilities","Versioned with semantic versioning","Loaded at container build time"]},
            "US-002": {"serviceOwner":"Shared Library","modernizationNotes":"Constants become strongly-typed record structs; partition/topic names centralized to avoid drift.","nfr":["Single source for topic names","No runtime reflection"]},
            "US-003": {"serviceOwner":"Shared Library","modernizationNotes":"Helper replaced with LINQ + guard extensions; ensures null-safe enumerations.","nfr":["No allocations > O(n)","Branch coverage 100%"]},
            "US-032": {"serviceOwner":"Config Service","produces":["InstanceHeartbeat"],"modernizationAcceptance":["Config fetched from Secrets Manager / Parameter Store","Hash of critical config emitted in InstanceHeartbeat"],"modernizationNotes":"Centralized outward config API (sidecar or shared lib) with local TTL cache.","nfr":["p95 config fetch <50ms (cache)","Stale cache TTL < 60s"]},
            "US-045": {"serviceOwner":"Config Service","produces":["InstanceHeartbeat"],"modernizationAcceptance":["Secrets only via IAM role & Secrets Manager","No secret value appears in logs"],"modernizationNotes":"Implements secret accessor with automatic rotation awareness.","nfr":["Rotation detection <5m","All secrets encrypted at rest (KMS)"]},
            "US-010": {"serviceOwner":"All Services","modernizationNotes":"Connection strings removed; services build RDS endpoint from secret JSON payload.","nfr":["DB creds rotated without restart","No plaintext connection strings baked into images"]},
            "US-009": {"serviceOwner":"All Services","produces":["InstanceHeartbeat"],"modernizationNotes":"Repository pattern slimmed; Dapper/EF Core with retry (polly) & tracing instrumentation.","nfr":["p95 query latency budgets documented","Automatic tracing spans for each SP call"]},
            "US-007": {"serviceOwner":"All Services","modernizationNotes":"Base exception enriched with correlationId + cause chain for observability.","nfr":["All thrown exceptions subclass base","Structured logging fields present"]},
            "US-044": {"serviceOwner":"All Services","modernizationNotes":"Log scrubbing middleware redacts secrets & PII patterns before sink.","nfr":["Zero PII leak in synthetic test","Scrubber latency overhead <2%"],"produces":["SecurityEvent"]},
            "US-004": {"serviceOwner":"Notification Service","modernizationNotes":"Templates stored in S3 + cached (Redis); fallback default embedded.","nfr":["Cache hit ratio >95%","Template fetch p95 <30ms"]},
            "US-005": {"serviceOwner":"Notification Service","consumes":["FileGenerationCompleted","FileDistributionSucceeded"],"produces":["EmailNotificationSent"],"partitionKey":"eventId","modernizationAcceptance":["Emails sent exactly once per terminal event","Idempotent send using outbox table"],"modernizationNotes":"Implements outbox → SNS / SES integration; dedupe via eventId.","nfr":["Send latency <2s from terminal event","Retry with exponential backoff up to 15m"]},
            "US-006": {"serviceOwner":"Notification Service","consumes":["FileDistributionFailed","ProtocolTransferStarted"],"produces":["EmailNotificationSent"],"modernizationNotes":"Failure alerts enriched with retry attempt metadata.","nfr":["Alert dispatch <60s of failure"]},
            "US-012": {"serviceOwner":"Scheduler Service","produces":["ScheduleTriggered"],"partitionKey":"scheduleId","modernizationAcceptance":["CRON windows converted to Hangfire recurring jobs","Emits ScheduleTriggered for due schedules"],"modernizationNotes":"Legacy allocation replaced by schedule event emission; downstream allocation logic moves to consumers.","nfr":["Skew between scheduled time and emission <5s","No duplicate ScheduleTriggered within window"]},
            "US-014": {"serviceOwner":"Notification Service","consumes":["AllocationPlanned"],"produces":["EmailNotificationSent"],"modernizationNotes":"Capacity mismatch now computed from lag metrics + schedule backlog.","nfr":["Capacity alert if lag > threshold for 3 consecutive intervals"]},
            "US-016": {"serviceOwner":"Generator Service","consumes":["GenerationTaskAllocated","ScheduleTriggered"],"produces":["FileGenerationStarted","FileGenerationCompleted","FileGenerationFailed"],"partitionKey":"customerId","modernizationAcceptance":["GenerationStarted emitted before first DB read","Completed carries checksum & bytes"],"modernizationNotes":"Moves enumeration to reactive consumption of allocation events; chunking drives parallelism per customer.","nfr":["p95 generation start <2s from allocation","Checksum calculation streaming (O(1) memory)"]},
            "US-020": {"serviceOwner":"Distributor Service","consumes":["FileGenerationCompleted","DistributionTaskAllocated"],"produces":["FileDistributionRequested","FileDistributionStarted","FileDistributionSucceeded","FileDistributionFailed"],"partitionKey":"fileId","modernizationNotes":"Introduces request→start→terminal lifecycle with retry (+dead-letter to error topic).","nfr":["First attempt start <3s from completion","Max retry backoff 15m"]},
            "US-021": {"serviceOwner":"Distributor Service","consumes":["FileGenerationCompleted"],"produces":["ProtocolTransferStarted"],"modernizationNotes":"Protocol config hydrated from RDS + secret merging then cached.","nfr":["Config hydration p95 <40ms","Zero plain credential logs"]},
            "US-023": {"serviceOwner":"Distributor Service","consumes":["ProtocolTransferStarted"],"produces":["FileDistributionSucceeded","FileDistributionFailed"],"modernizationNotes":"FTP adapter container with circuit breaker + metrics.","nfr":["Connection reuse via pool","Failure classification (transient/permanent)"]},
            "US-025": {"serviceOwner":"Distributor Service","consumes":["ProtocolTransferStarted"],"produces":["FileDistributionSucceeded","FileDistributionFailed"],"modernizationNotes":"FTPS adds TLS negotiation telemetry (cipher suite).","nfr":["Handshake metrics exported","TLS min version TLS1.2"]},
            "US-029": {"serviceOwner":"Archive Service","consumes":["FileGenerationCompleted"],"produces":["ArchiveCreationStarted","ArchiveCreated","ArchiveCreationFailed"],"partitionKey":"fileId","modernizationNotes":"Streaming zip writer to S3; emits started prior to compression for observability.","nfr":["Compression throughput >= 50MB/s node","Retry only on transient S3 errors"]},
            "US-030": {"serviceOwner":"Archive Service","consumes":["ArchiveCreated"],"produces":["ArchiveProcessed"],"modernizationNotes":"Inbound unzip pipeline validating checksums & size limits.","nfr":["Reject if file size > configured limit","Virus scan hook placeholder"]},
            "US-031": {"serviceOwner":"Notification Service","consumes":["ArchiveCreationFailed"],"produces":["EmailNotificationSent"],"modernizationNotes":"Compression failures integrated into single alert taxonomy.","nfr":["Alert dedupes same file within 15m"]},
            "US-039": {"serviceOwner":"Audit Service","consumes":["ArchiveCreationStarted","ArchiveCreated","ArchiveCreationFailed"],"produces":["AuditEventPersisted"],"modernizationNotes":"Writes normalized audit row + publishes summary event.","nfr":["Audit write p95 <30ms","No data loss on broker outage (buffer)"]},
            "US-040": {"serviceOwner":"Platform","produces":["InstanceHeartbeat"],"modernizationNotes":"Decomposed into 6 containerized services + sidecars (envoy/otel).","nfr":["Chaotic restart no cross-service coupling","Blue/green deploy <5m"]},
            "US-046": {"serviceOwner":"Platform","modernizationNotes":"Enforces inward-only dependencies (Clean Architecture variant).","nfr":["Static analysis gate in CI","No circular dependencies"]}
        }</script>
    <!-- Stored Procedure modernization overlay: microservice ownership + event triggers -->
    <script id="data-sp-modernization" type="application/json">{
                "SP-001": {"serviceOwner":"Scheduler Service","emits":["AllocationPlanned"],"consumes":[],"modernizationNotes":"Legacy schedule fetch becomes basis for emitting allocation planning events; may be deprecated once pure event scheduling adopted."},
                "SP-002": {"serviceOwner":"Generator Service","emits":["GenerationTaskAllocated"],"modernizationNotes":"Resend eligible schedules turned into allocation events instead of direct in-process loops."},
                "SP-003": {"serviceOwner":"Distributor Service","emits":["DistributionTaskAllocated"],"modernizationNotes":"Distribution readiness now evented; SP stays for transitional read model until replaced by materialized view."},
                "SP-004": {"serviceOwner":"Generator Service","consumes":["AllocationPlanned"],"modernizationNotes":"Persists allocations as idempotent claim; replaced longer-term by Kafka transactional outbox."},
                "SP-005": {"serviceOwner":"Generator Service","consumes":["AllocationPlanned"],"modernizationNotes":"Resend allocation specialized path; potential merge with SP-004 via mode flag."},
                "SP-006": {"serviceOwner":"Distributor Service","consumes":["DistributionTaskAllocated"],"modernizationNotes":"Persists distribution claim; candidate for deprecation with DynamoDB allocation table."},
                "SP-007": {"serviceOwner":"Platform","emits":["InstanceHeartbeat"],"modernizationNotes":"Heartbeat moves to lightweight table + emits InstanceHeartbeat event for observability."},
                "SP-014": {"serviceOwner":"Reconciliation Service","emits":["ReconciliationCompleted","ChecksumVarianceDetected"],"modernizationNotes":"Captures reconciliation snapshot and emits variance events."},
                "SP-019": {"serviceOwner":"Generator Service","consumes":["GenerationTaskAllocated"],"emits":["FileGenerationStarted","FileGenerationCompleted"],"modernizationNotes":"Primary data extraction; streaming results to file builder to lower memory."},
                "SP-029": {"serviceOwner":"Archive Service","consumes":["FileGenerationCompleted"],"emits":["ArchiveCreated"],"modernizationNotes":"Persists archive metadata enabling distribution readiness checks."},
                "SP-055": {"serviceOwner":"Distributor Service","consumes":["ArchiveCreated"],"emits":["ProtocolTransferStarted"],"modernizationNotes":"Initial distribution persistence & kickoff."},
                "SP-079": {"serviceOwner":"Reconciliation Service","emits":["ChecksumVarianceDetected"],"modernizationNotes":"Variance detection specialized path; triggers targeted alert logic."}
            }</script>
    <!-- Embedded raw markdown sources for SP and Test catalogs to allow full in-page rendering -->
    <script id="raw-sp-markdown" type="text/plain"># Stored Procedure User Stories (EMedia)</script>
    <script id="business-user-stories-raw" type="text/plain"></script>
    <!-- Removed post-footer duplicated story content (hidden) -->
    <div id="postFooterExtra" style="display:none">
        Include proper control totals and reconciliation data
        ---
        <!-- Legacy post-footer markdown fully removed per user request -->

        ## Summary Mapping (Indicative)

        | Group | Primary Domains | Key Downstream Concerns |
        |-------|-----------------|-------------------------|
        | Data Generation & Formats | Generation Service, Stored Procedures SP-019..033 | Reconciliation, Distribution |
        | Distribution & Communication | Distributor Service, Protocol Adapters | Delivery Assurance, Audit |
        | Reconciliation & Control | Reconciliation SPs SP-014..018, 079..086 | Financial Integrity, Alerts |
        | Multi-Country Operations | Format Management, Naming Logic | Compliance, Localization |
        | Administrative Control | Admin Portal / APIs | Governance, Security |
        | Parent-Child Relationships | Hierarchical Aggregation Logic | Reporting, Billing |
        | Error Handling & Notification | Mailer, Monitoring | Support Efficiency, SLA |
        | File Management | Zip/Move/Unzip Service, S3/Storage | Performance, Retention |

        > These high-level business stories should be decomposed into implementation stories (US-###) and linked to
        stored procedure stories (SP-###) and tests (TC-###) for full traceability.</script>

        Scope: Functional user stories for each distinct stored procedure referenced in `Constants.cs` (duplicates by
        constant name merged). Total unique procedures: 86.

        > NOTE: Actual parameter names / result set column names are inferred from naming patterns and referenced
        constants. Where exact DB schema is unknown, assumptions are clearly flagged with the prefix `Assumption:`.
        Replace assumptions with authoritative definitions during database reverse‑engineering.

        ## Conventions

        - ID: SP-### (stable within this document)
        - Primary Actor: Service / component invoking the SP
        - Trigger: Event or scheduler causing invocation
        - Preconditions: Key data or status required
        - Postconditions: Persisted state or returned data contract
        - Each SP section now includes: Purpose, Inputs, Outputs, Business Rules, Edge/Error Cases, Non-Functional,
        Sample Scenarios (Given/When/Then), and Data Quality / Security notes.
        - Common NFR (implicit for all unless overridden):
        - NFR-1: Executes within ≤5s typical load (≤10s for large generation sets)
        - NFR-2: Returns empty result set instead of error when no data
        - NFR-3: READ COMMITTED isolation (or higher where reconciliation)
        - NFR-4: Errors logged with procedure name + correlation id
        - NFR-5: Fully parameterized; no dynamic SQL without sanitisation
        - NFR-6: Pagination or streaming considered for large result sets (≥ 10k rows)
        - NFR-7: Index usage reviewed annually or after major workload shifts

        ## Modeling Template (Applied Per SP Group)

        | Section | Description |
        |---------|-------------|
        | Purpose | Business value and why this SP exists |
        | Inputs | Parameters (name, type, intent) – assumed if not confirmed |
        | Outputs | Result set(s) / output parameters / row counts |
        | Business Rules | Deterministic logic, filters, calculations |
        | Edge / Error Cases | Empty, not found, concurrency, invalid parameters |
        | Security | Role / permission & data exposure constraints |
        | Dependencies | Other tables / SPs logically tied |


        ### Work Allocation Fetch (SP-001 / 002 / 003)

        - Concurrency: Use UPDLOCK / READPAST (Assumption) to avoid double allocation.

        ### Allocation Save (SP-004 / 005 / 006)

        - Conflict Handling: If already allocated by different live instance, return conflict code.

        ### Generation Data (Primary Formats SP-019..033)

        - Inputs (Assumption): `@ScheduleId`, `@FormatCode`, `@InvoiceLevel (Optional)`, `@ChunkNumber (Optional for
        paging)`, `@ChunkSize`.
        - Outputs: Single multi-row set with column discriminator (e.g., SegmentType = 'H','D','T') or multiple result
        sets (Assumption). Numeric sums align with trailer counts.
        - Performance: Support streaming; ensure covering index on (ScheduleId, CustomerId, TransactionDate).

        ### Transaction Resend Data (SP-034..047)

        - Additional Filter: Only rows flagged resend + not already successfully regenerated.
        - Inputs add: `@ResendBatchId` OR `@OriginalRunId`.

        ### Distribution Persistence (SP-055..059)

        - Atomic writes; if multiple inserts, wrap in explicit transaction.

        ### Checksum / Reconciliation (SP-014–018, 079–086)

        - Isolation: At least REPEATABLE READ when capturing comparative metrics (Assumption) to prevent phantom rows
        mid reconciliation.

        ---

        ### SP-001 p_Emedia_Get_Schedules_Instances_For_Generation

        Purpose: Return due schedules for generation with instance routing data so generator workers can start timely
        processing.

        Inputs (Assumption):

        - @MaxBatchSize INT (default 100)
        - @InstanceId INT (optional – for telemetry)
        - @AsOf DATETIME (default GETUTCDATE())

        Outputs:

        - Columns: Schedule_Id, Instance_Id, Format_Name, Priority, Last_Processed_Date_Time, Generation_Type
        - Row count ≤ @MaxBatchSize

        -- Exclude any schedule present in allocation table with Active allocation
        -- Instance chosen via round-robin or least-load (Assumption – to validate)

        Edge / Error Cases:

        - If no schedules: return empty set (no error)
        - If @MaxBatchSize <=0 treat as 1 (defensive) Non-Functional: - Query plan uses composite index (Status,
            NextRunTime, Priority) - Average execution < 500ms for 10k candidate schedules Sample Scenarios: Data
            Quality: Assumes referential integrity between schedule and instance tables. Security: EXEC permission
            restricted to service role `svc_emedia_allocator`. Dependencies: Schedules table; Allocation table; Instance
            runtime status table. ### SP-002 p_Emedia_Get_Schedules_Instances_For_Resend_For_Generator Purpose: Retrieve
            resend-eligible schedules for generator after prior failure or manual resend flag. Additional Inputs:
            @ReasonCode VARCHAR(20) (optional filter, Assumption). Business Rules: - Status IN
            ('Failed','ResendPending') AND ResendFlag=1 - Must still be within allowed resend window (e.g.,
            DATEDIFF(day, OriginalRun, @AsOf) <=PolicyDays) - Exclude where a successful resend already exists
            (Status='Generated' ) Outputs: Schedule_Id, Original_Run_Id, Failure_Code, Priority Edge Cases: If resend
            window expired → exclude silently. Sample Scenario: Given a failed schedule within resend window when SP
            executes then row appears; when window expired then not returned. ### SP-003
            p_Emedia_Get_Schedules_Instances_For_Distributor Purpose: Provide distribution-ready schedules where
            generation completed and not yet sent. - Exclude schedules locked by a distribution allocation still active
            Outputs: Schedule_Id, Distribution_Mode, Protocol_Preference, Format_Count Edge Case: If partial files
            missing, row excluded until all required file rows present. ### SP-004
            p_Emedia_Save_Allocated_Tasks_For_Generator Purpose: Persist generator allocation decisions to prevent
            double work. Inputs: @ScheduleIds TVP, @InstanceId, @AllocatedAt DATETIME. Business Rules: - Insert one row
            per schedule if not allocated - If allocated by same instance treat as idempotent success - If allocated by
            different active instance return ConflictCode=1 Outputs: Row count inserted, ConflictCount Transactions:
            Wrap full TVP batch to ensure all-or-nothing. ### SP-005
            p_Emedia_Save_Allocated_Tasks_For_Resend_For_Generator Purpose: Persist resend allocations separately for
            audit & retry analytics. Additional Inputs: @OriginalRunId INT. Business Rules: Same as SP-004 plus
            `AllocationType='Resend' ` and store OriginalRunId. ### SP-006 p_Emedia_Save_Allocated_Tasks_For_Distributor
            Purpose: Persist distribution allocations to coordinate outbound sending. Edge Case: If schedule enters
            Failed state mid-allocation, allocation aborted (rollback). ### SP-007 p_Emedia_Save_Instance_Status
            Purpose: Track lifecycle of a service instance for monitoring & safe reallocation. Inputs: @InstanceId,
            @State (Start|Heartbeat|Completed|Failed), @MachineName, @ErrorCode NULLABLE. Business Rules: - Start
            creates or activates instance row - Heartbeat updates LastSeenUtc - Completed/Failed set EndTimeUtc, Status
            Edge Case: Heartbeat stale> threshold triggers external cleanup (not responsibility of SP but documented).

            ### SP-008 p_Emedia_Customers_For_DelayMail_Distribution

            Purpose: Provide list of customers exceeding distribution SLA so alert emails can be sent.

            Inputs: @SlaMinutes INT, @Now DATETIME

            Outputs: Customer_Id, Schedule_Id, Last_Processed_Date_Time, Minutes_Delayed

            Business Rules: Minutes_Delayed = DATEDIFF(MINUTE, Last_Processed_Date_Time, @Now) > @SlaMinutes.

            ### SP-009 p_emedia_update_customers_for_delaymail_distribution

            Purpose: Mark delay notification as sent preventing duplicate alerts.

            Inputs: @CustomerIds TVP, @Now DATETIME.

            Business Rules: Set DelayMailNotifiedAt if NULL; leave existing values unchanged.

            ### SP-010 p_emedia_get_schedules_customers_for_reordermail

            Purpose: Identify customers moved (reordered) whose dependent schedules became inactive.

            Outputs: Schedule_Id, Customer_Id, ParentReordered BIT, DaysInactive.

            ### SP-011 p_emedia_update_reorder_mail_sent_schedules

            Purpose: Mark reorder notification email as sent.

            Outputs: AffectedRows INT.

            ---

            ## 2. Data Generator – Allocation & Control / Reconciliation


            ### SP-012 p_Emedia_Get_Allocated_Tasks_For_Generator

            Purpose: Return active allocations for a generator instance.

            Inputs: @InstanceId INT, @IncludeCompleted BIT (default 0).

            Business Rules: If @IncludeCompleted=0 exclude tasks with Status IN ('Generated','Failed').

            ### SP-013 p_Emedia_Get_Control_Details

            Purpose: Provide header/trailer control metrics (counts, sums) for output file assembly.

            Outputs (Assumption): Control_details_id, txn_count, statement_value, Currency, Invoice_No.

            ### SP-014 p_Emedia_Update_Emedia_Reconcillation_Status

            Purpose: Persist reconciliation result after comparing generated vs control totals.

            Inputs: @ScheduleId, @Status (Pass|Fail), @ComparedAt DATETIME, @VarianceCount INT.

            Business Rules: If existing status = Pass cannot revert to Fail (Assumption).

            ### SP-015 p_Emedia_Insert_Checksum_Failure_Details_For_BPPC_CL

            Purpose: Log individual failure metric lines for BPPC_CL reconciliation gap analysis.

            Inputs: @ScheduleId, @MetricName, @Expected INT, @Actual INT, @Variance INT (computed server-side if NULL).

            ### SP-016 p_Emedia_Get_Reconciliation_Data_For_BPPC_CL

            Purpose: Provide side-by-side control vs generated metrics for BPPC_CL.

            Outputs: MetricName, Expected, Actual, Variance, Reconciliation_Status.

            ### SP-017 p_Emedia_Get_Reconciliation_Data_For_BPPC_TR_UNINVOICE

            Purpose: Provide uninvoice reconciliation dataset for BPPC_TR unbilled transactions.

            ### SP-018 p_emedia_update_BPPC_TR_uninvoice_reconicliation_status

            Purpose: Persist reconciliation outcome for BPPC_TR uninvoice segment.

            ---

            ## 3. Data Generator – Primary Generation Data (Per Format)

            General Acceptance (applies to SP-019 .. SP-033):

            - G1: Returns partitioned segments (Header, Detail, Trailer) OR separate result sets (Assumption) identified
            by SegmentType.
            - G2: No duplicate transaction rows for a (Customer, Transaction_Id) composite key.
            - G3: Stable ordering: Customer_Id ASC, Txn_Date_Time ASC, Sequence_Number ASC (where present).
            - G4: Trailer totals (txn_count, statement_value, Gross_Value, Vat_Value) reconcile with aggregated detail
            rows.
            - G5: Parent vs Customer level (Invoice_Level) respected; parent rollups produced only when
            Invoice_Level=Parent.
            - G6: Pagination optional via @ChunkNumber, @ChunkSize (if provided returns only detail rows for that slice
            + recomputed trailer subset flag).
            - G7: Empty dataset returns only (optional) header row or no rows (never error).

            Common Inputs (Assumption): @ScheduleId INT (required), @FormatCode VARCHAR(32), @InvoiceLevel VARCHAR(2)
            NULL, @ChunkNumber INT NULL, @ChunkSize INT NULL.

            Common Output Columns (superset; some NULL depending on format):

            | Column | Description | Notes |
            |--------|-------------|-------|
            | Header_Details | Header raw text or structured header | Present in first row if segment=Header |
            | Customer_Id | Customer identifier | Maps to `CUSTOMER_ID` constant |
            | Parent_id | Parent customer id | Used for parent rollups |
            | Authority_No | Authority number | Required for invoice naming |
            | Invoice_No | Invoice number | May be NULL for unbilled/uninvoice runs |
            | Currency | Currency code | From control / statement level |
            | Txn_Date_Time | Transaction timestamp | Detail rows only |
            | Quantity | Quantity sum per txn | Detail |
            | Gross_Value | Gross monetary value | Detail / aggregated |
            | Vat_Value | VAT amount | May be zero for VAT exempt |
            | Net_Value | Computed Gross - Vat (Assumption) | Validate rounding policy |
            | Statement_Value | Control total value | Present in trailer |
            | Txn_Count | Count of detail rows | Trailer control |
            | Invoice_Level | 'CU' or 'PC' | From constants |
            | Format_Name | Friendly format name | For auditing |
            | SegmentType | 'H','D','T' | If single result set pattern |
            | Sequence_Number | Ordering within file | Optional |

            Format-Specific Variations:

            | SP ID | Stored Procedure | Format | Key Additional Rules | Special Columns / Flags |
            |-------|------------------|--------|----------------------|--------------------------|
            | SP-019 | p_Emedia_Get_Generation_Data_For_Agency_National_Format | Agency Format | National agency
            specific price & tax mapping | May include ListPrice, PumpPrice (Assumption) |
            | SP-020 | p_Emedia_Get_Generation_Data_For_BPF | BPF | Legacy column ordering preserved | Header includes
            custom control code |
            | SP-021 | p_Emedia_Get_Generation_Data_For_BPFOLD | BPFOLD | Backward compatible with deprecated layout |
            Omits new rebate enhancement columns |
            | SP-022 | p_Emedia_Get_Generation_Data_For_BPI | BPI | International partner variant | Adds Country_Id for
            each txn |
            | SP-023 | p_Emedia_Get_Generation_Data_For_BPPC_TR | BPPC TR | Transaction (TR) specific uninvoice tagging
            | Flag UninvoiceIndicator BIT |
            | SP-024 | p_Emedia_Get_Generation_Data_For_BPPC_CL | BPPC CL | Card list (CL) specialized detail set |
            Includes Card_Type, Card_Details |
            | SP-025 | p_Emedia_Get_Generation_Data_For_CAR | CAR | Automotive rebate columns required | Adds
            Gross_Rebate_Complete |
            | SP-026 | p_Emedia_Get_Generation_Data_For_CE_Excel_CSV | CE_Excel_CSV | Provides flattened tabular dataset
            for Excel/CSV | No header/trailer textual segments, separate control set |
            | SP-027 | p_Emedia_Get_Generation_Data_For_CX_Ascii | CX_Ascii | ASCII fixed-width formatting constraints |
            Pads numeric fields to spec width |
            | SP-028 | p_Emedia_Get_Generation_Data_For_Enhanced_International_Version | Enhanced International Version
            | Extended international columns (multi-currency) | Adds Statement_Currency distinct from Currency |
            | SP-029 | p_Emedia_Get_Generation_Data_For_IFC_Redifined | IFC Redefine 2 Enhanced | Re-defined
            international format baseline | Supports Invoice_Level variants |
            | SP-030 | p_Emedia_Get_Generation_Data_For_IFC_Redifined_For_Logical_Parents | IFC Redefine Parents |
            Logical parent aggregation before customer lines | Parent rollup lines inserted pre customer detail |
            | SP-031 | p_Emedia_Get_Generation_Data_For_IFC_Redifined_Plus | IFC Redefine 2 Enhanced Plus | Plus variant
            introduces extra pricing columns | Adds Pump_Price, List_Price (MODLOG016) |
            | SP-032 | p_Emedia_Get_Generation_Data_For_IFC_Redifined_For_Logical_Parents_Plus | IFC Redefine Parents
            Plus | Combines logical parent + plus pricing | Same as SP-031 + parent summary rows |
            | SP-033 | p_Emedia_Get_Generation_Data_For_International_Standard_Format | International Standard | Base
            international dataset | Minimal set; no plus / parent extras |

            Edge / Error Cases (all):

            - Invalid @ScheduleId → empty result (no exception) (Assumption) to keep idempotent.
            - @ChunkSize provided without @ChunkNumber → treat as full dataset.
            - Trailer mismatch (aggregated counts differ) → either raises error OR returns VarianceFlag column
            (Assumption: raise error in staging, flag in production configurable).

            Performance / Indexing:

            - Covering index suggestion: IX_GenData_Schedule (ScheduleId, Customer_Id, Txn_Date_Time) INCLUDE
            (Gross_Value, Vat_Value, Quantity, Invoice_No).
            - Stats updated daily; fragmentation threshold 20% reorganize, >30% rebuild (operational guideline).

            Security:

            - Read-only execution by generator service role.
            - PII columns restricted (if Customer_Name included it must be masked in lower environments).

            Sample Scenario:

            Given a schedule with 3 customers and 10 transactions each when SP-028 executes then it returns 1 header
            row, 30 detail rows, and 1 trailer row whose Txn_Count = 30 and Statement_Value equals sum of Gross_Value.

            ---

            ## 4. Data Generator – Transaction Generation (Resend) Data

            Resend Acceptance (applies to SP-034 .. SP-047):

            - R1: Only detail rows where ResendFlag=1 and LastGeneratedStatus IN ('Failed','Missing').
            - R2: Original unique transaction id preserved for traceability.
            - R3: Excludes rows already successfully regenerated (RegeneratedAt NOT NULL AND Success=1).
            - R4: Ordering stable: Customer_Id ASC, Original_Txn_Timestamp ASC.
            - R5: Includes column Resend_Attempt_Count for monitoring.

            Additional Inputs: @ResendBatchId UNIQUEIDENTIFIER NULL (grouping), @MaxRows INT NULL.

            Output Additional Columns vs Primary Generation: Failure_Code, Last_Attempt_At, Resend_Attempt_Count.

            Per-Format differences mirror Section 3 format table; no extra business rules except: TR (SP-038) &
            Uninvoice rows may require special UninvoiceIndicator filter.

            Edge Cases:

            - If a transaction is simultaneously flagged for resend and part of a new schedule generation, prefer
            schedule generation (exclude) (Assumption).

            Sample Scenario: Given 5 failed transactions across 2 customers for format IFC Redefine Plus when SP-046
            executes then exactly those 5 rows are returned with original sequence numbers retained.

            ---

            ## 5. Data Generator – Generation Detail (Resend Context)

            Acceptance (applies to SP-048 .. SP-052):

            - D1: Returns segmentation info (Original_File_Name, Segment_Start_Sequence, Segment_End_Sequence).
            - D2: Provides per-segment subtotals (Segment_Txn_Count, Segment_Gross_Value) to validate partial rebuild.
            - D3: Supports multiple partial files; each row describes a rebuild slice.

            Inputs (Assumption): @ScheduleId, @OriginalRunId, @FormatCode, @IncludeSuccessful BIT (default 0).

            Outputs: File_Segment_Id, Segment_Order, Segment_Start_Sequence, Segment_End_Sequence, Segment_Txn_Count,
            Segment_Gross_Value, Needs_Rebuild BIT.

            Edge Case: If original segmentation metadata missing, reconstruct algorithmically (Assumption) using
            Sequence_Number buckets.

            ---

            ## 6. Data Generator – Customer File Details (Avco)

            ### SP-053 p_Emedia_Get_Customers_File_Details_For_Avco

            Provides initial run per-customer filename tokens.
            Acceptance: F1 Includes customer & parent mapping; F2 Supports extension rules; F3 No duplicates.

            ### SP-054 p_Emedia_Get_Customers_File_Details_For_Avco_Resend

            Resend variant restricting to customers needing regeneration.
            Acceptance: F1 Only failed customers; F2 Reuses original naming scheme; F3 Distinguishes resend version if
            required.

            ---

            ## 7. Data Generator – Distribution Persistence

            Group Purpose: Persist generation outcomes & per-file metadata enabling downstream distribution with
            integrity and failure traceability.

            Common Inputs: @ScheduleId, @Mode ('All_In_One' | 'Separate'), @UserId, @Now.

            Common Rules:

            - All writes atomic per schedule.
            - Separate mode: header then detail file records; all must succeed.
            - Failure record SP-059 must not downgrade a previously successful status unless explicit override flag
            present.

            ### SP-055 p_Emedia_Save_Data_For_Distributor_After_Generation_For_All_In_One

            Adds single distribution header row (File_Count, Total_Size, Checksum_Aggregate).

            ### SP-056 p_Emedia_Save_Distribution_Details_After_Generation_For_Separate

            Adds distribution header referencing separate group; Mode='Separate'.

            ### SP-057 p_Emedia_Save_File_Details_After_Generation_For_Separate

            Inserts one row per generated physical file with File_Name, File_Path, Checksum, Size_Bytes.

            ### SP-058 p_Emedia_Update_Task_After_Generation_For_Separate

            Transitions task state Generated→ReadyForDistribution; records Completed_At.

            ### SP-059 p_Emedia_Save_File_Generation_Failure_Status

            Writes status with Error_Code, Error_Message, Attempt_Number; prevents overwrite unless @Force BIT=1.

            ### SP-060 p_Emedia_Get_Control_Details_Resend

            Returns adjusted control counts post partial regeneration (Used for validation before distribution).

            ---

            ## 8. Data Distributor

            Group Purpose: Support secure, auditable distribution of generated files and related notifications.

            ### SP-061 p_Emedia_Get_Allocated_Tasks_For_Distributor

            Retrieves tasks allocated to distributor instance ready for send.

            ### SP-062 p_Emedia_Get_FTP_Details_For_Sending_File

            Returns FTP host, port, folder, masked credentials.

            ### SP-063 p_Emedia_Get_OFTP_Details_For_Sending_File

            Returns OFTP session parameters including security profile.

            ### SP-064 p_Emedia_Save_Distribution_Details_After_Sending_File

            Writes attempt outcome (Success BIT, Attempt_Number, Latency_ms, Remote_Path).

            ### SP-065 p_Emedia_Get_Details_For_Email_Generation

            Provides schedule-level summary for email template population.

            ### SP-066 p_Emedia_Get_CC_Mail_Address

            Returns deduplicated CC addresses; locale filter optional.

            ### SP-067 p_Emedia_Insert_Get_FTP_File_Details

            Inserts audit row for inbound/outbound FTP file detail and returns its Id.

            ### SP-068 p_Emedia_Get_File_Details_For_Distribution

            Lists all file attachments for a schedule with readiness flags.

            ### SP-069 sp_oac_parameter_get

            Retrieves secure URL salt (single active value).

            ### SP-070 p_eMedia_get_internet_schedule_details

            Returns schedule internet / approval metadata and partial/full indicators.

            ### SP-071 p_emedia_getUsers_for_adminApproval

            Lists users pending approval (ordered oldest first).

            ---

            ## 9. Zip / Move / Unzip

            Group Purpose: Manage compression cycle and inbound archive processing.

            ### SP-072 p_Emedia_Get_Zipping_Files_And_SFTP_Details

            Returns candidate files (Can_Zip=1) plus SFTP credentials for onward transfer.

            ### SP-073 p_Emedia_Save_Zip_Files_Details

            Persists created archive metadata including file count & size aggregate; ensures uniqueness per schedule.

            ### SP-074 p_Emedia_Get_Files_For_Unzipping

            Lists inbound archives with PendingUnzip status and target path + password flag.

            ### SP-075 p_Emedia_Save_UnZip_Files_Details

            Inserts one row per extracted file referencing source archive id and flips status to Unzipped.

            ---

            ## 10. Common / Parameters / Email / Checksum

            Group Purpose: Provide shared configuration, templating, and reconciliation support utilities.

            ### SP-076 P_Emedia_get_redefine_parameters

            Returns parameter name/value pairs (email routing, toggles).

            ### SP-077 p_Emedia_Get_Email_body

            Returns email template body + type indicator (HTML/Text) preserving placeholders.

            ### SP-078 p_Emedia_Update_Schedule_Last_Run

            Updates Last_Run timestamp only after successful generation + distribution (Assumption: generation success
            sufficient?).

            ### SP-079 p_Emedia_CheckSum_Entity_Details

            Returns control vs transactional metrics (BPPLUS) with variance columns (RebateDiff, TxnCntDiff etc.).

            ### SP-080 p_Emedia_MSRS_CheckSum_Entity_Details

            Returns MSRS side metrics for join reconciliation.

            ### SP-081 p_Emedia_CheckSum_Mark_Mail_Sent

            Sets checksum mail sent flag (idempotent) for BPPLUS reconciliation scope.

            ### SP-082 p_emedia_update_distributor_ind_flag

            Updates distribution indicator (full/partial) logging previous value.

            ### SP-083 p_Emedia_Get_BPPC_CL_Checksum_Details

            Returns BPPC_CL specific checksum variance snapshot.

            ### SP-084 p_Emedia_Mark_BPPC_CL_Checksum_Mail_Sent

            Marks BPPC_CL checksum notification mail sent.

            ### SP-085 p_Emedia_update_BPPC_TR_Uninvoice_checksum_mail_status

            Marks BPPC_TR uninvoice checksum mail sent.

            ### SP-086 p_Emedia_Get_BPPC_TR_Uninvoice_Checksum_Details

            Returns uninvoice reconciliation metrics with variance flags.

            ---

            ## Cross-Story Reuse / Derived Tags

            - Allocation: SP-001..006, 012, 055–058
            - Generation Data: SP-019..033
            - Resend Data: SP-034..047, 048–052 (details)
            - Distribution: SP-061..068
            - Security/Config: SP-069, 076, 077
            - Reconciliation/Checksum: SP-014–018, 079–086
            - Compression: SP-072–075

            ## Suggested Azure DevOps Tagging

            Tag sets (semicolon-separated):

            - WorkAllocator;StoredProcedure
            - DataGenerator;Generation
            - DataGenerator;Resend
            - DataGenerator;DistributionPersistence
            - Distribution;StoredProcedure
            - Compression;Zip
            - Reconciliation;Checksum
            - Email;Template
            - Config;Parameters

            End of file.</script>
            <script id="raw-test-markdown" type="text/plain"># Test Stories (Functional & Stored Procedure)

Generated: 2025-09-11  
Source Backlog: 25 Functional Stories (US-xxx) + 86 Stored Procedure Stories (SP-xxx)  
Total Test Cases: 111 (1 per original story)

---

## Conventions

| Field | Meaning |
|-------|---------|
| Title | Mirrors parent functionality with test focus |
| Priority | Mirrors parent story priority |
| Points | Default 1 (test effort unit) |
| Tags | Functional: Test;Functional;AutoCandidate + parent domain tags. SP: Test;SP;DB;AutoCandidate + domain tags (excluding StoredProcedure) |
| Relation | Parent link (Hierarchy-Reverse) to implementation story |

Automation Levels: Unit, Integration (DB), StaticAnalysis, Manual (only when environment/service orchestration heavy).  
Performance Gates (SP): Initial baseline captured, assert within +20% for stable data volume.

---

## Functional Test Cases (25)

### TC-US-001 Common Library
Parent: US-001 | Epic: E01 | Priority:1 | Points:1  
Purpose: Validate utility components load & behave (constants, exceptions, mailer, backup).  
Scenarios:
- Constants class exposes required members.
- Base exception captures metadata (message, component, timestamp).
- Mailer returns fallback marker on missing template.  
Edge Cases: Missing template, null subject.  
NFR: Build unchanged (<+5%), no circular references.  
Automation: Unit.

### TC-US-002 Constants Component
Parent: US-002 | Epic: E01 | Priority:1 | Points:1  
Purpose: Enforce single source of table/column names.  
Scenarios:
- Code scan shows zero hard-coded table names.
- Modify constant propagates (compile success, behavior unchanged).  
Edge: Attempt redefine -> compile error.  
Automation: StaticAnalysis script.

### TC-US-003 DataTable Select Helper
Parent: US-003 | Epic: E01 | Priority:2 | Points:1  
Purpose: Safe predicate composition & missing marker.  
Scenarios:
- Found row returns expected value.
- Missing row returns "Missing:<Description>".
- Malicious predicate input sanitized.  
Performance: <=5ms lookup (5k rows).  
Automation: Unit.

### TC-US-032 Centralized Config Access
Parent: US-032 | Epic: E10 | Priority:2 | Points:1  
Purpose: Typed accessor correctness & safety.  
Scenarios:
- Known key returns expected value.
- Unknown key throws controlled exception.
- Value update in config file reflected without code change.  
Security: Secret not logged.  
Automation: Unit (config mock).

### TC-US-045 Central Secret Access
Parent: US-045 | Epic: E14 | Priority:1 | Points:1  
Purpose: Centralize secret retrieval & masking.  
Scenarios:
- Access only through accessor.
- Log redaction verified.
- Rotated secret returns new value.  
Automation: Unit + Log scan.

### TC-US-010 Config Connection Strings
Parent: US-010 | Epic: E04 | Priority:1 | Points:1  
Purpose: All DB connects via config.  
Scenarios:
- Each DbConnection uses accessor.
- Environment swap changes target DB.  
Edge: Missing key -> handled exception.  
Automation: Unit.

### TC-US-009 Repository Classes
Parent: US-009 | Epic: E04 | Priority:1 | Points:1  
Purpose: Parameterized SP usage & schema integrity.  
Scenarios:
- Each domain repo present.
- All SP calls parameterized.
- Returned schema matches contract.  
Security: Injection attempt blocked.  
Automation: Integration (local DB / mock).

### TC-US-007 Central Exception Base
Parent: US-007 | Epic: E03 | Priority:1 | Points:1  
Purpose: Unified exception metadata.  
Scenarios:
- Capture message, component, timestamp.
- Inner exception preserved.  
Automation: Unit.

### TC-US-044 Protect Sensitive Errors
Parent: US-044 | Epic: E14 | Priority:1 | Points:1  
Purpose: Prevent credential leakage.  
Scenarios:
- Secret values masked in logs.
- Multiple secrets all masked.  
Automation: Log scan.

### TC-US-004 Email Template Retrieval
Parent: US-004 | Epic: E02 | Priority:2 | Points:1  
Purpose: Retrieve template or fallback marker.  
Scenarios:
- Existing template returns content.
- Missing returns marker.  
Automation: Unit.

### TC-US-005 Lifecycle Event Emails
Parent: US-005 | Epic: E02 | Priority:2 | Points:1  
Purpose: Event-driven email dispatch.  
Scenarios:
- Generation event sends mail.
- Distribution event sends mail.
- Missing optional template -> fallback.  
Automation: Partial (event simulation).

### TC-US-006 Protocol Failure Alerts
Parent: US-006 | Epic: E02 | Priority:2 | Points:1  
Purpose: Alert emails for protocol failures.  
Scenarios:
- Failure triggers alert with protocol, file, timestamp.
- Repeated failure not duplicated within suppression window (if defined).  
Automation: Unit.

### TC-US-012 Retrieve Schedules & Instances
Parent: US-012 | Epic: E05 | Priority:1 | Points:1  
Purpose: Provide data for allocation.  
Scenarios:
- Due schedules returned with instance metadata.
- No schedules -> empty set.  
Performance: <200ms typical.  
Automation: Integration.

### TC-US-014 Unallocated Task Notification
Parent: US-014 | Epic: E05 | Priority:2 | Points:1  
Purpose: Notify on unallocated tasks.  
Scenarios:
- Threshold breach sends email.
- Exactly at threshold sends once.  
Automation: Unit.

### TC-US-016 Enumerate Pending Files
Parent: US-016 | Epic: E06 | Priority:1 | Points:1  
Purpose: List pending generation files.  
Scenarios:
- Returns all pending with format metadata.
- Unsupported format flagged.  
Automation: Unit.

### TC-US-020 Fetch Distribution Tasks
Parent: US-020 | Epic: E07 | Priority:1 | Points:1  
Purpose: Instance-specific unprocessed tasks.  
Scenarios:
- Only tasks not processed.
- Concurrent fetches allocate distinct sets.  
Automation: Integration.

### TC-US-021 Retrieve Protocol Details
Parent: US-021 | Epic: E07 | Priority:1 | Points:1  
Purpose: Provide protocol connection bundles.  
Scenarios:
- FTP/SFTP/FTPS/OFTP each returns host+cred meta.
- Unknown protocol -> controlled exception.  
Security: Secrets masked.  
Automation: Unit.

### TC-US-023 FTP Transfer
Parent: US-023 | Epic: E08 | Priority:1 | Points:1  
Purpose: Reliable FTP upload.  
Scenarios:
- Successful upload logs success.
- Network timeout logs failure + retry (if spec).  
Automation: Mock socket.

### TC-US-025 FTPS Transfer
Parent: US-025 | Epic: E08 | Priority:1 | Points:1  
Purpose: Secure FTPS transfer.  
Scenarios:
- TLS handshake success.
- Handshake failure logged w/out secret leakage.  
Automation: Partial (cert mock).

### TC-US-029 Update Zip Status
Parent: US-029 | Epic: E09 | Priority:2 | Points:1  
Purpose: Persist status after zipping.  
Scenarios:
- Pending->Zipped transition.
- Re-zip attempt ignored.  
Automation: Unit.

### TC-US-030 Unzip Inbound Archives
Parent: US-030 | Epic: E09 | Priority:2 | Points:1  
Purpose: Extract inbound archives.  
Scenarios:
- All files extracted to configured path.
- Password-protected -> flagged (if unsupported).  
Automation: Partial.

### TC-US-031 Compression Failure Alerts
Parent: US-031 | Epic: E09 | Priority:2 | Points:1  
Purpose: Alert on compression failures.  
Scenarios:
- Corrupt archive -> alert email.
- Log includes archive name + error reason.  
Automation: Unit.

### TC-US-039 Log Zip/Unzip Operations
Parent: US-039 | Epic: E12 | Priority:3 | Points:1  
Purpose: Audit compression operations.  
Scenarios:
- Log contains archive name, file count, destination.
- Large file count truncated gracefully.  
Automation: Unit.

### TC-US-040 Independent Services
Parent: US-040 | Epic: E13 | Priority:2 | Points:1  
Purpose: Independent lifecycle of services.  
Scenarios:
- Stop one service others unaffected.
- Parallel startup stable.  
Automation: Manual + harness.

### TC-US-046 Preserve Layered Architecture
Parent: US-046 | Epic: E14 | Priority:1 | Points:1  
Purpose: Enforce dependency direction.  
Scenarios:
- Static graph contains no reverse edges.
- New dependency addition fails check.  
Automation: StaticAnalysis.

---

## Stored Procedure Test Cases (86)

Pattern Fields: Structure, Behavior, Integrity, Performance (< baseline +20%), Security (param binding).

### TC-SP-001 p_Emedia_Get_Schedules_Instances_For_Generation
Parent: SP-001 | Epic: ALLOCATION | Priority:1 | Points:1  
Purpose: Due unallocated generation schedules.  
Scenarios: Only due & unallocated; excludes allocated; includes instance routing.  
Edge: None due -> empty. Perf: <150ms.  
Automation: Integration.

### TC-SP-002 p_Emedia_Get_Schedules_Instances_For_Resend_For_Generator
Purpose: Resend eligible schedules.  
Scenarios: Within window; excludes already resent success; outside window -> empty.  
Perf: <120ms.  
Automation: Integration.

### TC-SP-003 p_Emedia_Get_Schedules_Instances_For_Distributor
Purpose: Distribution ready schedules.  
Scenarios: Generation complete only; not yet allocated; no duplicates.  
Perf: <120ms.  
Automation: Integration.

### TC-SP-004 p_Emedia_Save_Allocated_Tasks_For_Generator
Purpose: Persist generator allocations.  
Scenarios: New allocation inserted; conflict prevented; idempotent if retried.  
Automation: Integration.

### TC-SP-005 p_Emedia_Save_Allocated_Tasks_For_Resend_For_Generator
Purpose: Persist resend allocations.  
Scenarios: Links to original run; prevents duplicate; rollback on failure.  
Automation: Integration.

### TC-SP-006 p_Emedia_Save_Allocated_Tasks_For_Distributor
Purpose: Persist distributor allocations.  
Scenarios: Insert allocation; abort on mid-process failure; idempotent repeat.  
Automation: Integration.

### TC-SP-007 p_Emedia_Save_Instance_Status
Purpose: Track lifecycle.  
Scenarios: Start, heartbeat, completion updates; failure status recorded.  
Automation: Integration.

### TC-SP-008 p_Emedia_Customers_For_DelayMail_Distribution
Purpose: SLA delay customers.  
Scenarios: Only over-threshold customers; excludes already mailed.  
Automation: Integration.

### TC-SP-009 p_emedia_update_customers_for_delaymail_distribution
Purpose: Mark delay mail sent.  
Scenarios: Sets flag; repeat call unchanged; returns affected count.  
Automation: Integration.

### TC-SP-010 p_emedia_get_schedules_customers_for_reordermail
Purpose: Reorder mail candidates.  
Scenarios: Only reorder-needed; excludes already mailed.  
Automation: Integration.

### TC-SP-011 p_emedia_update_reorder_mail_sent_schedules
Purpose: Mark reorder mail sent.  
Scenarios: Idempotent flag set; correct timestamp.  
Automation: Integration.

### TC-SP-012 p_Emedia_Get_Allocated_Tasks_For_Generator
Purpose: Active allocations for generator.  
Scenarios: Returns active; optional include completed off by default.  
Automation: Integration.

### TC-SP-013 p_Emedia_Get_Control_Details
Purpose: Control metrics.  
Scenarios: Header/trailer counts match dataset; sums accurate.  
Automation: Integration.

### TC-SP-014 p_Emedia_Update_Emedia_Reconcillation_Status
Purpose: Persist reconciliation result.  
Scenarios: First write; prevents downgrade Pass->Fail; timestamp set.  
Automation: Integration.

### TC-SP-015 p_Emedia_Insert_Checksum_Failure_Details_For_BPPC_CL
Purpose: Log checksum failures.  
Scenarios: Inserts variance rows; no duplicates per key.  
Automation: Integration.

### TC-SP-016 p_Emedia_Get_Reconciliation_Data_For_BPPC_CL
Purpose: BPPC_CL reconciliation metrics.  
Scenarios: Side-by-side control vs generated; variance columns computed.  
Automation: Integration.

### TC-SP-017 p_Emedia_Get_Reconciliation_Data_For_BPPC_TR_UNINVOICE
Purpose: BPPC_TR uninvoice reconciliation.  
Scenarios: Only unbilled transactions; variance fields populated.  
Automation: Integration.

### TC-SP-018 p_emedia_update_BPPC_TR_uninvoice_reconicliation_status
Purpose: Update reconciliation status.  
Scenarios: Writes outcome; prevents duplicate downgrade.  
Automation: Integration.

### TC-SP-019 p_Emedia_Get_Generation_Data_For_Agency_National_Format
Purpose: Agency National dataset.  
Scenarios: Header/detail/trailer alignment; control totals accurate.  
Automation: Integration.

### TC-SP-020 p_Emedia_Get_Generation_Data_For_BPF
Purpose: BPF dataset.  
Scenarios: Legacy column order; control segment present.  
Automation: Integration.

### TC-SP-021 p_Emedia_Get_Generation_Data_For_BPFOLD
Purpose: BPFOLD legacy dataset.  
Scenarios: Deprecated columns present; matches legacy schema.  
Automation: Integration.

### TC-SP-022 p_Emedia_Get_Generation_Data_For_BPI
Purpose: BPI dataset.  
Scenarios: Includes country-specific columns; control totals valid.  
Automation: Integration.

### TC-SP-023 p_Emedia_Get_Generation_Data_For_BPPC_TR
Purpose: BPPC TR dataset.  
Scenarios: Uninvoice indicator supported; trailer reconciliation.  
Automation: Integration.

### TC-SP-024 p_Emedia_Get_Generation_Data_For_BPPC_CL
Purpose: BPPC CL dataset.  
Scenarios: Card type & details columns present; trailer correct.  
Automation: Integration.

### TC-SP-025 p_Emedia_Get_Generation_Data_For_CAR
Purpose: CAR dataset.  
Scenarios: Rebate columns present; totals accurate.  
Automation: Integration.

### TC-SP-026 p_Emedia_Get_Generation_Data_For_CE_Excel_CSV
Purpose: CE Excel/CSV dataset.  
Scenarios: Flattened tabular structure; separate control segment.  
Automation: Integration.

### TC-SP-027 p_Emedia_Get_Generation_Data_For_CX_Ascii
Purpose: CX ASCII dataset.  
Scenarios: Fixed-width formatting; proper padding.  
Automation: Integration.

### TC-SP-028 p_Emedia_Get_Generation_Data_For_Enhanced_International_Version
Purpose: Enhanced international dataset.  
Scenarios: Multi-currency support; trailer reconciliation.  
Automation: Integration.

### TC-SP-029 p_Emedia_Get_Generation_Data_For_IFC_Redifined
Purpose: IFC Redefined baseline.  
Scenarios: Invoice-level options; schema integrity.  
Automation: Integration.

### TC-SP-030 p_Emedia_Get_Generation_Data_For_IFC_Redifined_For_Logical_Parents
Purpose: IFC logical parents dataset.  
Scenarios: Parent rollups precede child rows.  
Automation: Integration.

### TC-SP-031 p_Emedia_Get_Generation_Data_For_IFC_Redifined_Plus
Purpose: IFC Plus dataset.  
Scenarios: Pricing columns (Pump/List) present; totals unaffected.  
Automation: Integration.

### TC-SP-032 p_Emedia_Get_Generation_Data_For_IFC_Redifined_For_Logical_Parents_Plus
Purpose: IFC Parents Plus dataset.  
Scenarios: Parent + pricing columns combined correctly.  
Automation: Integration.

### TC-SP-033 p_Emedia_Get_Generation_Data_For_International_Standard_Format
Purpose: International standard dataset.  
Scenarios: Minimal base column set; trailer reconciliation.  
Automation: Integration.

### TC-SP-034 p_Emedia_Get_Resend_Data_For_Agency_National_Format
Purpose: Resend Agency National.  
Scenarios: Only flagged rows; exclusion rules honored.  
Automation: Integration.

### TC-SP-035 p_Emedia_Get_Resend_Data_For_BPF
Purpose: Resend BPF.  
Scenarios: Legacy ordering; original identifiers preserved.  
Automation: Integration.

### TC-SP-036 p_Emedia_Get_Resend_Data_For_BPFOLD
Purpose: Resend BPFOLD legacy.  
Scenarios: Legacy schema compatibility maintained.  
Automation: Integration.

### TC-SP-037 p_Emedia_Get_Resend_Data_For_BPI
Purpose: Resend BPI dataset.  
Scenarios: Country-specific resend rows only.  
Automation: Integration.

### TC-SP-038 p_Emedia_Get_Resend_Data_For_BPPC_TR
Purpose: Resend BPPC TR dataset.  
Scenarios: Uninvoice filter applied; only failed rows.  
Automation: Integration.

### TC-SP-039 p_Emedia_Get_Resend_Data_For_BPPC_CL
Purpose: Resend BPPC CL dataset.  
Scenarios: Only failed card rows; card detail present.  
Automation: Integration.

### TC-SP-040 p_Emedia_Get_Resend_Data_For_CAR
Purpose: Resend CAR dataset.  
Scenarios: Failed transactions with rebate cols.  
Automation: Integration.

### TC-SP-041 p_Emedia_Get_Resend_Data_For_CE_Excel_CSV
Purpose: Resend CE Excel/CSV.  
Scenarios: Only failed rows; structure flattened.  
Automation: Integration.

### TC-SP-042 p_Emedia_Get_Resend_Data_For_CX_Ascii
Purpose: Resend CX ASCII.  
Scenarios: Fixed-width for failed lines only.  
Automation: Integration.

### TC-SP-043 p_Emedia_Get_Resend_Data_For_Enhanced_International_Version
Purpose: Resend enhanced international.  
Scenarios: Multi-currency failed rows only.  
Automation: Integration.

### TC-SP-044 p_Emedia_Get_Resend_Data_For_IFC_Redifined
Purpose: Resend IFC baseline.  
Scenarios: Failed baseline rows only.  
Automation: Integration.

### TC-SP-045 p_Emedia_Get_Resend_Data_For_IFC_Redifined_For_Logical_Parents
Purpose: Resend IFC logical parents.  
Scenarios: Parent rollups re-generated properly.  
Automation: Integration.

### TC-SP-046 p_Emedia_Get_Resend_Data_For_IFC_Redifined_Plus
Purpose: Resend IFC Plus.  
Scenarios: Pricing columns retained for failed rows.  
Automation: Integration.

### TC-SP-047 p_Emedia_Get_Resend_Data_For_IFC_Redifined_For_Logical_Parents_Plus
Purpose: Resend IFC Parents Plus.  
Scenarios: Parent + pricing rows consistent ordering.  
Automation: Integration.

### TC-SP-048 p_Emedia_Get_Resend_Detail_Segments_For_Agency_National_Format
Purpose: Segmentation metadata Agency National.  
Scenarios: Sequence ranges contiguous; counts match segments.  
Automation: Integration.

### TC-SP-049 p_Emedia_Get_Resend_Detail_Segments_For_BPF
Purpose: Segmentation metadata BPF.  
Scenarios: Ranges & counts align with data.  
Automation: Integration.

### TC-SP-050 p_Emedia_Get_Resend_Detail_Segments_For_IFC
Purpose: Segmentation metadata IFC.  
Scenarios: Works for multiple IFC variants; no gaps.  
Automation: Integration.

### TC-SP-051 p_Emedia_Get_Resend_Detail_Segments_For_BPPC
Purpose: Segmentation metadata BPPC.  
Scenarios: TR/CL segments validated.  
Automation: Integration.

### TC-SP-052 p_Emedia_Get_Resend_Detail_Segments_Generic
Purpose: Generic segmentation.  
Scenarios: Provides fallback ranges; matches row count.  
Automation: Integration.

### TC-SP-053 p_Emedia_Get_Customers_File_Details_For_Avco
Purpose: Avco initial run file details.  
Scenarios: Filename tokens built; parent mapping present.  
Automation: Integration.

### TC-SP-054 p_Emedia_Get_Customers_File_Details_For_Avco_Resend
Purpose: Avco resend file details.  
Scenarios: Only customers needing regeneration; naming preserved.  
Automation: Integration.

### TC-SP-055 p_Emedia_Save_Data_For_Distributor_After_Generation_For_All_In_One
Purpose: Persist all-in-one header.  
Scenarios: Single header row; checksum aggregate stored.  
Automation: Integration.

### TC-SP-056 p_Emedia_Save_Distribution_Details_After_Generation_For_Separate
Purpose: Persist separate mode header.  
Scenarios: Header references file group; uniqueness enforced.  
Automation: Integration.

### TC-SP-057 p_Emedia_Save_File_Details_After_Generation_For_Separate
Purpose: Persist per-file details.  
Scenarios: Row per file; checksum & size captured.  
Automation: Integration.

### TC-SP-058 p_Emedia_Update_Task_After_Generation_For_Separate
Purpose: Advance task status.  
Scenarios: Generated->ReadyForDistribution; timestamp set; idempotent re-run.  
Automation: Integration.

### TC-SP-059 p_Emedia_Save_File_Generation_Failure_Status
Purpose: Persist generation failure.  
Scenarios: Failure row written once; subsequent without force ignored.  
Automation: Integration.

### TC-SP-060 p_Emedia_Get_Control_Details_Resend
Purpose: Adjusted resend control counts.  
Scenarios: Counts reflect partial regeneration; accurate deltas.  
Automation: Integration.

### TC-SP-061 p_Emedia_Get_Allocated_Tasks_For_Distributor
Purpose: Distributor allocations.  
Scenarios: Only allocated to instance & pending send.  
Automation: Integration.

### TC-SP-062 p_Emedia_Get_FTP_Details_For_Sending_File
Purpose: FTP connection details.  
Scenarios: Returns host/port/directory; credentials masked.  
Automation: Integration.

### TC-SP-063 p_Emedia_Get_OFTP_Details_For_Sending_File
Purpose: OFTP session parameters.  
Scenarios: Security profile fields present; port valid.  
Automation: Integration.

### TC-SP-064 p_Emedia_Save_Distribution_Details_After_Sending_File
Purpose: Persist distribution attempt.  
Scenarios: Success & failure attempts logged; latency ms positive.  
Automation: Integration.

### TC-SP-065 p_Emedia_Get_Details_For_Email_Generation
Purpose: Email summary details.  
Scenarios: Schedule-level aggregates correct; no duplicates.  
Automation: Integration.

### TC-SP-066 p_Emedia_Get_CC_Mail_Address
Purpose: CC mail addresses.  
Scenarios: Deduplicated list; locale filter applied.  
Automation: Integration.

### TC-SP-067 p_Emedia_Insert_Get_FTP_File_Details
Purpose: Insert & return FTP file detail id.  
Scenarios: Row inserted; ID returned; no duplicate on retry.  
Automation: Integration.

### TC-SP-068 p_Emedia_Get_File_Details_For_Distribution
Purpose: File details for distribution.  
Scenarios: All attachments listed; readiness flags accurate.  
Automation: Integration.

### TC-SP-069 sp_oac_parameter_get
Purpose: Retrieve secure URL salt.  
Scenarios: Single active value; no duplicates.  
Security: Not logged.  
Automation: Integration.

### TC-SP-070 p_eMedia_get_internet_schedule_details
Purpose: Internet schedule details.  
Scenarios: Approval metadata present; partial/full indicator correct.  
Automation: Integration.

### TC-SP-071 p_emedia_getUsers_for_adminApproval
Purpose: Pending approval users list.  
Scenarios: Ordered by oldest request; excludes approved.  
Automation: Integration.

### TC-SP-072 p_Emedia_Get_Zipping_Files_And_SFTP_Details
Purpose: Files eligible for zipping + SFTP creds.  
Scenarios: Only Can_Zip=1; SFTP credentials masked.  
Automation: Integration.

### TC-SP-073 p_Emedia_Save_Zip_Files_Details
Purpose: Persist created archive metadata.  
Scenarios: Archive row unique per schedule; size aggregate correct.  
Automation: Integration.

### TC-SP-074 p_Emedia_Get_Files_For_Unzipping
Purpose: Inbound archives pending unzip.  
Scenarios: PendingUnzip only; target path present.  
Automation: Integration.

### TC-SP-075 p_Emedia_Save_UnZip_Files_Details
Purpose: Persist extracted file metadata.  
Scenarios: Row per extracted file; archive status updated.  
Automation: Integration.

### TC-SP-076 P_Emedia_get_redefine_parameters
Purpose: Return redefine parameters.  
Scenarios: Key/value pairs complete; feature toggles included.  
Automation: Integration.

### TC-SP-077 p_Emedia_Get_Email_body
Purpose: Return email template body.  
Scenarios: HTML/Text type returned; placeholders preserved.  
Automation: Integration.

### TC-SP-078 p_Emedia_Update_Schedule_Last_Run
Purpose: Update schedule last run.  
Scenarios: Timestamp updated post-success; no regression on repeat.  
Automation: Integration.

### TC-SP-079 p_Emedia_CheckSum_Entity_Details
Purpose: BPPLUS checksum metrics.  
Scenarios: Control vs transactional metrics; variance columns non-null.  
Automation: Integration.

### TC-SP-080 p_Emedia_MSRS_CheckSum_Entity_Details
Purpose: MSRS checksum metrics.  
Scenarios: Joins produce expected metric set; no duplicates.  
Automation: Integration.

### TC-SP-081 p_Emedia_CheckSum_Mark_Mail_Sent
Purpose: Mark checksum mail sent (BPPLUS).  
Scenarios: Flag set once; idempotent.  
Automation: Integration.

### TC-SP-082 p_emedia_update_distributor_ind_flag
Purpose: Update distribution indicator flag.  
Scenarios: Value updated; previous value logged; idempotent same value.  
Automation: Integration.

### TC-SP-083 p_Emedia_Get_BPPC_CL_Checksum_Details
Purpose: BPPC_CL checksum variance.  
Scenarios: Variance snapshot correct; no duplicates.  
Automation: Integration.

### TC-SP-084 p_Emedia_Mark_BPPC_CL_Checksum_Mail_Sent
Purpose: Mark BPPC_CL checksum mail sent.  
Scenarios: Flag set; repeat call no duplication.  
Automation: Integration.

### TC-SP-085 p_Emedia_update_BPPC_TR_Uninvoice_checksum_mail_status
Purpose: Mark BPPC_TR uninvoice checksum mail sent.  
Scenarios: Flag set; no duplicate notifications.  
Automation: Integration.

### TC-SP-086 p_Emedia_Get_BPPC_TR_Uninvoice_Checksum_Details
Purpose: BPPC_TR uninvoice checksum variance.  
Scenarios: Variance metrics computed; variance flags accurate.  
Automation: Integration.

---

<div style="display:none" id="post-sec8-hidden">
## Coverage & Quality Gates

- Coverage: 111/111 parent items have corresponding test cases.  
- Automation Priority: Allocation, Generation, Distribution, Checksum first.  
- Performance: Baseline each SP; alert if >20% regression.  
- Security: All DB calls parameterized (assert no ad-hoc SQL in tests).  
- Lint: Markdown headings spaced; no trailing whitespace.

## Next Steps

1. Implement test harness (xUnit / NUnit) with data fixtures.  
2. Add CI job: fast subset (functional + critical SP) per PR; full nightly run.  
3. Capture and store SP baseline timings (JSON artifact).  
4. Map automation results back to Azure DevOps via Test Runs API.  
5. Extend negative testing matrix for error paths & permission scenarios.
</script>
            <script>
                // Inject full markdown sources (escaped) for runtime parsing
                window.__SP_MARKDOWN__ = `# Stored Procedure User Stories (EMedia)\n${String.raw`Scope: Functional user stories for each distinct stored procedure referenced in Constants.cs (duplicates by constant name merged). Total unique procedures: 86.\n\nConventions...`}`;
                window.__TEST_MARKDOWN__ = `# Test Stories (Functional & Stored Procedure)\n${String.raw`Total Test Cases: 111 ...`}`;
                (function () {
                    const toastEl = document.getElementById('toast');
                    function toast(msg) { toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), 2800); }
                    const dataHigh = JSON.parse(document.getElementById('data-high').textContent.trim());
                    const functionalStories = dataHigh.stories.map(s => ({
                        id: s.key, title: s.title, priority: s.priority, points: s.points, tags: s.tags || [], description: s.description || '', acceptance: s.acceptanceCriteria || [], patch: s.patch || []
                    }));

                    // Event catalog definition
                    const eventCatalog = [
                        { name: 'AllocationPlanned', category: 'Core', producer: 'WorkAllocator', payload: ['scheduleIds[]', 'plannedCount'], consumers: ['GeneratorService', 'DistributorService'], idem: 'Natural uniqueness per plan run' },
                        { name: 'GenerationTaskAllocated', category: 'Core', producer: 'WorkAllocator', payload: ['taskId', 'scheduleId', 'format'], consumers: ['GeneratorService'], idem: 'Idempotent insert SP; duplicates ignored' },
                        { name: 'DistributionTaskAllocated', category: 'Core', producer: 'WorkAllocator', payload: ['taskId', 'scheduleId', 'protocol'], consumers: ['DistributorService'], idem: 'Same pattern as generation allocation' },
                        { name: 'FileGenerationStarted', category: 'Core', producer: 'GeneratorService', payload: ['taskId', 'format', 'startTs'], consumers: ['Monitoring'], idem: 'Repeat allowed; startTs variance tracked' },
                        { name: 'FileGenerationCompleted', category: 'Core', producer: 'GeneratorService', payload: ['taskId', 'fileCount', 'bytes', 'checksum'], consumers: ['DistributorService', 'ReconciliationService', 'ZipMoveService'], idem: 'Checksum prevents duplicate distribution' },
                        { name: 'FileGenerationFailed', category: 'Critical', producer: 'GeneratorService', payload: ['taskId', 'errorCode', 'message'], consumers: ['Alerting', 'RetryScheduler'], idem: 'Only first failure escalates' },
                        { name: 'ArchiveCreationStarted', category: 'Infra', producer: 'ZipMoveService', payload: ['scheduleId', 'archiveName'], consumers: ['Monitoring'], idem: 'Repeated on retries' },
                        { name: 'ArchiveCreated', category: 'Core', producer: 'ZipMoveService', payload: ['scheduleId', 'archiveName', 'fileCount', 'bytes'], consumers: ['DistributorService'], idem: 'Archive checksum ensures single send' },
                        { name: 'ArchiveCreationFailed', category: 'Critical', producer: 'ZipMoveService', payload: ['scheduleId', 'archiveName', 'errorCode'], consumers: ['Alerting'], idem: 'First failure triggers email' },
                        { name: 'ProtocolTransferStarted', category: 'Infra', producer: 'DistributorService', payload: ['taskId', 'protocol', 'targetPath'], consumers: ['Monitoring'], idem: 'Retries produce additional events flagged with attempt' },
                        { name: 'FileDistributionSucceeded', category: 'Core', producer: 'DistributorService', payload: ['taskId', 'protocol', 'latencyMs'], consumers: ['NotificationService', 'Billing'], idem: 'Idempotent: only first success tallied' },
                        { name: 'FileDistributionFailed', category: 'Critical', producer: 'DistributorService', payload: ['taskId', 'protocol', 'attempt', 'errorCode'], consumers: ['Alerting', 'RetryScheduler'], idem: 'Escalates if attempts exceed threshold' },
                        { name: 'ReconciliationCompleted', category: 'Core', producer: 'ReconciliationService', payload: ['scheduleId', 'status', 'varianceCount'], consumers: ['Dashboard', 'NotificationService'], idem: 'Higher precedence PASS cannot downgrade to FAIL prevented at SP layer' },
                        { name: 'ChecksumVarianceDetected', category: 'Critical', producer: 'ReconciliationService', payload: ['scheduleId', 'entity', 'expected', 'actual'], consumers: ['NotificationService', 'Audit'], idem: 'Deduplicated by (scheduleId,entity)' },
                        { name: 'EmailNotificationSent', category: 'Infra', producer: 'NotificationService', payload: ['template', 'to[]', 'correlationId'], consumers: ['Audit'], idem: 'Idempotent token prevents duplicate sends' },
                        { name: 'InstanceHeartbeat', category: 'Infra', producer: 'AnyService', payload: ['service', 'instanceId', 'ts'], consumers: ['Operations'], idem: 'Most recent offset only' },
                        { name: 'InstanceFailure', category: 'Critical', producer: 'AnyService', payload: ['service', 'instanceId', 'errorCode'], consumers: ['Operations', 'Alerting'], idem: 'Per failure window (service,instance)' }
                    ];

                    // Augment functional stories with produced/consumed (heuristic mapping)
                    const producedMap = {
                        'US-012': ['AllocationPlanned', 'GenerationTaskAllocated', 'DistributionTaskAllocated'],
                        'US-016': ['FileGenerationStarted', 'FileGenerationCompleted', 'FileGenerationFailed'],
                        'US-023': ['ProtocolTransferStarted', 'FileDistributionSucceeded', 'FileDistributionFailed'],
                        'US-025': ['ProtocolTransferStarted', 'FileDistributionSucceeded', 'FileDistributionFailed'],
                        'US-029': ['ArchiveCreated', 'ArchiveCreationFailed'],
                        'US-030': ['ArchiveCreationStarted', 'ArchiveCreated', 'ArchiveCreationFailed'],
                        'US-031': ['EmailNotificationSent'],
                        'US-039': ['ArchiveCreated'],
                        'US-005': ['EmailNotificationSent'],
                        'US-006': ['EmailNotificationSent'],
                        'US-014': ['EmailNotificationSent'],
                        'US-020': ['DistributionTaskAllocated'],
                        'US-021': ['ProtocolTransferStarted'],
                        'US-009': ['InstanceHeartbeat'],
                        'US-040': ['InstanceHeartbeat'],
                        'US-044': ['InstanceFailure'],
                        'US-045': ['InstanceHeartbeat'],
                        'US-046': ['InstanceHeartbeat']
                    };
                    const consumedMap = {
                        'US-016': ['GenerationTaskAllocated'],
                        'US-020': ['DistributionTaskAllocated', 'FileGenerationCompleted'],
                        'US-023': ['ArchiveCreated', 'ProtocolTransferStarted'],
                        'US-025': ['ArchiveCreated', 'ProtocolTransferStarted'],
                        'US-029': ['FileGenerationCompleted'],
                        'US-030': ['ArchiveCreated'],
                        'US-031': ['ArchiveCreationFailed'],
                        'US-005': ['FileGenerationCompleted', 'FileDistributionSucceeded'],
                        'US-006': ['FileDistributionFailed', 'ProtocolTransferStarted'],
                        'US-014': ['AllocationPlanned'],
                        'US-039': ['ArchiveCreationStarted'],
                        'US-012': [], 'US-021': ['FileGenerationCompleted'], 'US-009': [], 'US-040': [], 'US-044': [], 'US-045': [], 'US-046': [], 'US-001': [], 'US-002': [], 'US-003': [], 'US-004': []
                    };

                    functionalStories.forEach(s => { s.produces = producedMap[s.id] || []; s.consumes = consumedMap[s.id] || []; });

                    // Merge modernization overlays (overrides produced/consumed if present)
                    const modernizationEl = document.getElementById('data-modernization');
                    if (modernizationEl) {
                        const modernization = JSON.parse(modernizationEl.textContent);
                        functionalStories.forEach(s => { const m = modernization[s.id]; if (m) { Object.assign(s, m); if (m.produces) s.produces = m.produces; if (m.consumes) s.consumes = m.consumes; } });
                    }

                    // Build summary metrics
                    function metrics() {
                        const totalStories = functionalStories.length;
                        const totalPoints = functionalStories.reduce((a, b) => a + (b.points || 0), 0);
                        const pCounts = [1, 2, 3].map(p => ({ p, count: functionalStories.filter(s => s.priority === p).length }));
                        const distinctEvents = new Set(eventCatalog.map(e => e.name));
                        const producedEvents = new Set(functionalStories.flatMap(s => s.produces));
                        const consumedEvents = new Set(functionalStories.flatMap(s => s.consumes));
                        const cards = [
                            { label: 'Functional Stories', value: totalStories, sub: 'Count' },
                            { label: 'Story Points', value: totalPoints, sub: 'Sum' },
                            { label: 'Priority 1', value: pCounts.find(x => x.p === 1).count, sub: 'Critical' },
                            { label: 'Priority 2', value: pCounts.find(x => x.p === 2).count, sub: 'Important' },
                            { label: 'Domain Events', value: distinctEvents.size, sub: 'Catalog' },
                            { label: 'Events Produced', value: producedEvents.size, sub: 'By Backlog' },
                            { label: 'Events Consumed', value: consumedEvents.size, sub: 'By Backlog' }
                        ];
                        const host = document.getElementById('summaryMetrics'); host.innerHTML = '';
                        cards.forEach(c => { const el = document.createElement('div'); el.className = 'metric-card'; el.innerHTML = `<h4>${c.label}</h4><div class="value">${c.value}</div><div class="sub">${c.sub}</div>`; host.appendChild(el); });
                    }
                    metrics();

                    // Populate event catalog table
                    const eventBody = document.getElementById('eventCatalogBody');
                    eventCatalog.forEach(e => {
                        const tr = document.createElement('tr');
                        const catClass = e.category === 'Core' ? 'event-core' : (e.category === 'Infra' ? 'event-infra' : 'event-critical');
                        tr.innerHTML = `<td><code>${e.name}</code></td><td><span class="pill ${catClass}">${e.category}</span></td><td>${e.producer}</td><td>${e.payload.join(', ')}</td><td>${e.consumers.join(', ')}</td><td class="text-xs">${e.idem}</td>`;
                        eventBody.appendChild(tr);
                    });

                    // Backlog Event Mapping table
                    const evTableBody = document.querySelector('#eventBacklogTable tbody');
                    function buildEventBacklogRows() {
                        evTableBody.innerHTML = '';
                        functionalStories.forEach(s => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td><code>${s.id}</code></td><td>${escapeHtml(s.title)}</td><td>P${s.priority}</td><td>${renderTags(s.produces, 'pill')}</td><td>${renderTags(s.consumes, 'pill alt')}</td><td>${s.tags.map(t => `<span class="tag">${t}</span>`).join('')}</td><td><button class="copy-btn small" data-kind="patch" data-story="${s.id}">Copy Patch</button></td>`;
                            evTableBody.appendChild(tr);
                        });
                    }
                    buildEventBacklogRows();

                    // Functional backlog full table
                    const fBody = document.querySelector('#functionalTable tbody');
                    function buildFunctionalRows() {
                        fBody.innerHTML = '';
                        functionalStories.forEach(s => {
                            const acceptance = s.acceptance.length ? `<details><summary>Acceptance</summary><ul style="margin:.4rem 0 .2rem; padding-left:1rem;">${s.acceptance.map(a => `<li>${escapeHtml(a)}</li>`).join('')}</ul></details>` : '';
                            const modernization = s.serviceOwner ? `<details><summary>Modernization Overlay</summary><div class="note-xs"><strong>Service Owner:</strong> ${escapeHtml(s.serviceOwner)}<br/><strong>Produces:</strong> ${(s.produces || []).join(', ') || '—'}<br/><strong>Consumes:</strong> ${(s.consumes || []).join(', ') || '—'}${s.partitionKey ? `<br/><strong>Partition Key:</strong> ${escapeHtml(s.partitionKey)}` : ''}${s.modernizationNotes ? `<br/><strong>Notes:</strong> ${escapeHtml(s.modernizationNotes)}` : ''}${s.nfr ? `<br/><strong>NFR:</strong><ul class=\"list-tight\">${s.nfr.map(n => `<li>${escapeHtml(n)}</li>`).join('')}</ul>` : ''}${s.modernizationAcceptance ? `<br/><strong>Modern Acceptance:</strong><ul class=\"list-tight\">${s.modernizationAcceptance.map(a => `<li>${escapeHtml(a)}</li>`).join('')}</ul>` : ''}</div></details>` : '';
                            const patch = `<details><summary>Patch (first ops)</summary><pre>${escapeHtml(JSON.stringify(s.patch.slice(0, 6), null, 2))}</pre><button class="copy-btn" data-kind="patch-full" data-story="${s.id}">Copy Full Patch</button></details>`;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td><code>${s.id}</code></td><td><div class="story-title">${escapeHtml(s.title)}</div><div class="story-desc">${escapeHtml(s.description)}</div>${acceptance}${modernization}</td><td>P${s.priority}</td><td>${s.points}</td><td>${s.tags.map(t => `<span class=tag>${t}</span>`).join('')}</td><td>${patch}</td>`;
                            fBody.appendChild(tr);
                        });
                    }
                    buildFunctionalRows();

                    // Functional detailed cards
                    const functionalCardsHost = document.getElementById('functionalCards');
                    function buildFunctionalCards() {
                        if (!functionalCardsHost) return;
                        functionalCardsHost.innerHTML = '';
                        functionalStories.forEach(s => {
                            const card = document.createElement('div');
                            card.className = 'panel';
                            card.style.padding = '0.95rem 1rem 1.05rem';
                            card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
                            <span style="background:var(--accent);color:#fff;padding:.25rem .55rem;border-radius:6px;font-size:.55rem;font-weight:600;letter-spacing:.5px;">${s.id}</span>
                            <span class="tag" style="margin:0;">P${s.priority}</span>
                            <span class="tag" style="margin:0;">${s.points} pts</span>
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:.35rem;">${s.tags.map(t => `<span class=tag>${t}</span>`).join('')}</div>
                    </div>
                    <h4 style="margin:.7rem 0 .4rem;font-size:.9rem;letter-spacing:.4px;">${escapeHtml(s.title)}</h4>
                    <p style="margin:.15rem 0 .8rem;font-size:.63rem;opacity:.85;line-height:1.4;">${escapeHtml(s.description)}</p>
                    ${s.acceptance.length ? `<section style='margin:0 0 .8rem;'><h5 style="margin:0 0 .35rem;font-size:.6rem;letter-spacing:.6px;text-transform:uppercase;opacity:.65;">Acceptance</h5><ul style='margin:0;padding-left:1rem;font-size:.6rem;line-height:1.35;'>${s.acceptance.map(a => `<li>${escapeHtml(a)}</li>`).join('')}</ul></section>` : ''}
                    ${(s.nfr && s.nfr.length) ? `<section style='margin:0 0 .8rem;'><h5 style="margin:0 0 .35rem;font-size:.6rem;letter-spacing:.6px;text-transform:uppercase;opacity:.65;">NFR</h5><ul style='margin:0;padding-left:1rem;font-size:.6rem;line-height:1.35;'>${s.nfr.map(n => `<li>${escapeHtml(n)}</li>`).join('')}</ul></section>` : ''}
                    ${s.serviceOwner ? `<section style='margin:0 0 .85rem;'><h5 style="margin:0 0 .35rem;font-size:.6rem;letter-spacing:.6px;text-transform:uppercase;opacity:.65;">Modernization</h5><div style='font-size:.58rem;line-height:1.35;'><strong>Service Owner:</strong> ${escapeHtml(s.serviceOwner)}<br/><strong>Produces:</strong> ${(s.produces || []).join(', ') || '—'}<br/><strong>Consumes:</strong> ${(s.consumes || []).join(', ') || '—'}${s.partitionKey ? `<br/><strong>Partition Key:</strong> ${escapeHtml(s.partitionKey)}` : ''}${s.modernizationNotes ? `<br/><strong>Notes:</strong> ${escapeHtml(s.modernizationNotes)}` : ''}</div></section>` : ''}
                    <details style="margin:.2rem 0 0;">
                        <summary style="cursor:pointer;font-weight:600;">Patch (excerpt)</summary>
                        <pre style="margin:.5rem 0 0;">${escapeHtml(JSON.stringify(s.patch.slice(0, 6), null, 2))}</pre>
                        <button class="copy-btn" data-kind="patch-full" data-story="${s.id}" style="margin-top:.4rem;">Copy Full Patch</button>
                    </details>`;
                            functionalCardsHost.appendChild(card);
                        });
                    }
                    // Cards toggle removed; always build immediately
                    buildFunctionalCards();

                    // --- Enhanced controls (persistence, collapse/expand) --- (sorting UI removed)
                    const functionalSort = document.getElementById('functionalSort'); // may be null
                    const toggleFunctionalTableBtn = null; // removed button
                    const functionalTableWrapper = document.getElementById('functionalTableWrapper');
                    const exportVisibleStoriesBtn = document.getElementById('exportVisibleStoriesBtn');
                    let collapseAllStoriesBtn, expandAllStoriesBtn, exportVisibleStoriesCsvBtn;
                    // Functional backlog filters (moved earlier to avoid TDZ issues in restoreState/persistState)
                    const functionalTagFilters = document.getElementById('functionalTagFilters');
                    const functionalSearch = document.getElementById('functionalSearch');
                    (function buildFunctionalTagChips() {
                        if (!functionalTagFilters) return;
                        if (functionalTagFilters.dataset.built === '1') return; // idempotent safeguard
                        const topTags = [...new Set(functionalStories.flatMap(s => s.tags))].sort();
                        topTags.forEach(tag => { const c = document.createElement('button'); c.className = 'chip'; c.textContent = tag; c.dataset.tag = tag; c.onclick = () => { c.classList.toggle('active'); applyFunctionalFilters(); }; functionalTagFilters.appendChild(c); });
                        functionalTagFilters.dataset.built = '1';
                    })();
                    functionalSearch?.addEventListener('input', debounce(applyFunctionalFilters, 180));
                    (function injectExtraStoryControls() {
                        // Fallback to container holding prior controls
                        let toolbar = document.getElementById('toggleFunctionalCardsBtn')?.parentElement;
                        if (!toolbar) {
                            toolbar = functionalSort?.parentElement?.parentElement || functionalTagFilters?.parentElement; // climb or fallback to tag filters parent
                        }
                        if (!toolbar) return;
                        if (!document.getElementById('expandAllStoriesBtn')) {
                            expandAllStoriesBtn = document.createElement('button'); expandAllStoriesBtn.id = 'expandAllStoriesBtn'; expandAllStoriesBtn.className = 'btn secondary'; expandAllStoriesBtn.textContent = 'Expand All Details';
                            collapseAllStoriesBtn = document.createElement('button'); collapseAllStoriesBtn.id = 'collapseAllStoriesBtn'; collapseAllStoriesBtn.className = 'btn secondary'; collapseAllStoriesBtn.textContent = 'Collapse All Details';
                            exportVisibleStoriesCsvBtn = document.createElement('button'); exportVisibleStoriesCsvBtn.id = 'exportVisibleStoriesCsvBtn'; exportVisibleStoriesCsvBtn.className = 'btn secondary'; exportVisibleStoriesCsvBtn.textContent = 'Export Visible Stories CSV';
                            toolbar.insertBefore(expandAllStoriesBtn, toolbar.firstChild.nextSibling);
                            toolbar.insertBefore(collapseAllStoriesBtn, expandAllStoriesBtn.nextSibling);
                            toolbar.appendChild(exportVisibleStoriesCsvBtn);
                        }
                    })();

                    function applySort() {
                        const mode = functionalSort ? functionalSort.value : 'id';
                        functionalStories.sort((a, b) => {
                            if (mode === 'id') return a.id.localeCompare(b.id);
                            if (mode === 'priority') return a.priority - b.priority || a.id.localeCompare(b.id);
                            if (mode === 'points') return (b.points || 0) - (a.points || 0) || a.id.localeCompare(b.id);
                            if (mode === 'priorityPoints') return a.priority - b.priority || (b.points || 0) - (a.points || 0) || a.id.localeCompare(b.id);
                            if (mode === 'title') return a.title.localeCompare(b.title);
                            return 0;
                        });
                        buildFunctionalRows();
                        if (functionalCardsHost.style.display !== 'none') { buildFunctionalCards(); applyFunctionalFilters(); }
                        applyFunctionalFilters();
                        persistState();
                    }
                    functionalSort?.addEventListener('change', applySort);

                    // JSON export button removed per request

                    exportVisibleStoriesCsvBtn?.addEventListener('click', () => {
                        const activeTags = [...functionalTagFilters.querySelectorAll('.chip.active')].map(b => b.dataset.tag);
                        const q = functionalSearch ? functionalSearch.value.trim().toLowerCase() : '';
                        const filtered = functionalStories.filter(s => {
                            if (activeTags.length && !activeTags.every(t => s.tags.includes(t))) return false;
                            if (q) { const hay = (s.id + s.title + s.description + s.tags.join() + s.acceptance.join()).toLowerCase(); if (!hay.includes(q)) return false; }
                            return true;
                        });
                        const header = ['ID', 'Title', 'Priority', 'Points', 'Tags', 'AcceptanceCount'];
                        const rows = filtered.map(s => [s.id, '"' + s.title.replace(/"/g, '""') + '"', s.priority, s.points, '"' + s.tags.join(';').replace(/"/g, '""') + '"', s.acceptance.length]);
                        const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
                        const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'functional-visible-stories.csv'; a.click(); URL.revokeObjectURL(a.href); toast(`CSV exported (${filtered.length} stories)`);
                        persistState();
                    });

                    function setAllDetails(open) {
                        document.querySelectorAll('#functionalTable details, #functionalCards details').forEach(d => d.open = open);
                    }
                    collapseAllStoriesBtn?.addEventListener('click', () => setAllDetails(false));
                    expandAllStoriesBtn?.addEventListener('click', () => setAllDetails(true));

                    // Table toggle removed

                    function persistState() {
                        try { const state = { sort: functionalSort?.value, search: functionalSearch?.value, tags: [...functionalTagFilters.querySelectorAll('.chip.active')].map(c => c.dataset.tag), cardsVisible: functionalCardsHost.style.display !== 'none', tableVisible: functionalTableWrapper.style.display !== 'none' }; localStorage.setItem('functionalBacklogState', JSON.stringify(state)); } catch (e) { }
                    }
                    function restoreState() {
                        try {
                            const raw = localStorage.getItem('functionalBacklogState'); if (!raw) return; const s = JSON.parse(raw);
                            if (s.sort && functionalSort) { functionalSort.value = s.sort; }
                            if (s.search && functionalSearch) functionalSearch.value = s.search;
                            if (Array.isArray(s.tags)) s.tags.forEach(t => { const chip = [...functionalTagFilters.querySelectorAll('.chip')].find(c => c.dataset.tag === t); chip && chip.classList.add('active'); });
                            if (s.tableVisible) { functionalTableWrapper.style.display = 'block'; }
                            if (!s.cardsVisible) { functionalCardsHost.style.display = 'none'; }
                        } catch (e) { }
                        applySort();
                        applyFunctionalFilters();
                    }
                    restoreState();

                    // Patch excerpt table (section 7)
                    const patchExcerptBody = document.querySelector('#patchExcerptTable tbody');
                    functionalStories.forEach(s => {
                        const excerpt = s.patch.slice(0, 2);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><code>${s.id}</code></td><td><pre style="margin:0;">${escapeHtml(JSON.stringify(excerpt, null, 2))}</pre></td>`;
                        patchExcerptBody.appendChild(tr);
                    });

                    // Stored procedure stories summary (initial metrics) – full details parsed later from embedded markdown
                    const spSummary = { total: 86, epics: { ALLOCATION: 11, RECONCILIATION: 7, GENERATION: 15, RESEND: 14, DISTRIBUTION: 14, CONFIG: 4, COMPRESSION: 5, CHECKSUM: 7, EMAIL: 1 } };
                    const spMetricsHost = document.getElementById('spMetrics');
                    [
                        { label: 'SP Stories', value: spSummary.total, sub: 'Total' },
                        { label: 'Allocation', value: spSummary.epics.ALLOCATION, sub: 'Count' },
                        { label: 'Generation', value: spSummary.epics.GENERATION, sub: 'Count' },
                        { label: 'Resend', value: spSummary.epics.RESEND, sub: 'Count' },
                        { label: 'Distribution', value: spSummary.epics.DISTRIBUTION, sub: 'Count' },
                        { label: 'Checksum', value: spSummary.epics.CHECKSUM, sub: 'Count' },
                        { label: 'Compression', value: spSummary.epics.COMPRESSION, sub: 'Count' }
                    ].forEach(m => { const el = document.createElement('div'); el.className = 'metric-card'; el.innerHTML = `<h4>${m.label}</h4><div class="value">${m.value}</div><div class="sub">${m.sub}</div>`; spMetricsHost.appendChild(el); });

                    const spEpicContainer = document.getElementById('spEpicContainer');
                    Object.entries(spSummary.epics).forEach(([epic, count]) => {
                        const div = document.createElement('div'); div.className = 'panel'; div.style.marginBottom = '1rem';
                        div.innerHTML = `<details><summary style="font-size:.8rem;">${epic} <span class="pill" style="margin-left:.5rem;">${count}</span></summary><p style="font-size:.65rem;opacity:.8;">SP epic <strong>${epic}</strong> comprises ${count} procedures (see unified backlog page for line‑by‑line patch arrays). Each SP is an atomic contract: stable parameter set; returns tabular rowset(s); no application logic.</p></details>`; spEpicContainer.appendChild(div);
                    });

                    // --- Stored Procedure Detailed Story Enrichment (Section 6) ---
                    (function buildStoredProcedureStories() {
                        const container = document.getElementById('spDetailsContainer');
                        // Dynamic SP section removed (6.1) – if container absent, only populate static catalog if present and skip dynamic logic
                        if (!container) {
                            // Still generate spStories so static catalog (if retained) can render via fallback
                            if (!(window.spStories && window.spStories.length)) {
                                const distribution = { ALLOCATION: 11, RECONCILIATION: 7, GENERATION: 15, RESEND: 14, DISTRIBUTION: 14, CONFIG: 4, COMPRESSION: 5, CHECKSUM: 7, EMAIL: 1 };
                                window.spStories = []; let cursor = 1; const gen = (epic, count) => { for (let i = 0; i < count; i++) { const num = cursor++; const id = 'SP-' + String(num).padStart(3, '0'); window.spStories.push({ id, epic, title: `${epic} Procedure ${id}`, purpose: `Focused data operation for ${epic.toLowerCase()} domain.`, inputs: ['@BatchId (INT)', '@CorrelationId (UNIQUEIDENTIFIER)', '@AsOfDate (DATE)'], outputs: [`Result set columns for ${epic.toLowerCase()}`], rules: ['Idempotent re-execution', 'Set-based operations', 'Return only active records'], edgeCases: ['No rows still returns schema', 'Null optional filters wildcard', 'High volume path'], performance: ['<2s median', 'Covering index used', 'No temp table spills'], security: ['Least privilege role', 'No dynamic SQL', 'No PII beyond approved'], dependencies: ['Tables TBD', 'Other SPs: none'], tags: [epic, 'StoredProcedure', 'DataContract'] }); } };
                                Object.entries(distribution).forEach(([e, c]) => gen(e, c));
                            }
                            const staticGrid = document.getElementById('spStaticGrid');
                            if (staticGrid && !staticGrid.dataset.filled) {
                                const frag = document.createDocumentFragment();
                                [...window.spStories].sort((a, b) => a.id.localeCompare(b.id)).forEach(sp => { const wrap = document.createElement('div'); wrap.className = 'panel'; wrap.style.padding = '.6rem .7rem'; wrap.innerHTML = `<strong>${sp.id} ${escapeHtml(sp.title)}</strong><div style='margin:.25rem 0 .4rem;font-size:.58rem;opacity:.85;'>${escapeHtml(sp.purpose)}</div>` + `<div style='display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:.4rem;'>${sp.tags.map(t => `<span class=tag>${t}</span>`).join('')}</div>` + `<div style='font-size:.55rem;line-height:1.35;'><strong>Inputs:</strong> ${sp.inputs.join('; ')}<br/><strong>Outputs:</strong> ${sp.outputs.join('; ')}<br/><strong>Rules:</strong> ${sp.rules.join('; ')}<br/><strong>Edge:</strong> ${sp.edgeCases.join('; ')}<br/><strong>Performance:</strong> ${sp.performance.join('; ')}<br/><strong>Security:</strong> ${sp.security.join('; ')}<br/><strong>Dependencies:</strong> ${sp.dependencies.join('; ')}</div>`; frag.appendChild(wrap); });
                                staticGrid.appendChild(frag); staticGrid.dataset.filled = '1';
                            }
                            return;
                        }
                        // Generate placeholder dataset only if none already attached (idempotent)
                        if (window.spStories && Array.isArray(window.spStories) && window.spStories.length) { render(); return; }
                        const distribution = spSummary.epics; // ensures counts align with displayed metrics
                        const generateItems = (epic, count, startIndex) => {
                            const items = []; for (let i = 0; i < count; i++) {
                                const num = startIndex + i; const id = 'SP-' + String(num).padStart(3, '0');
                                items.push({ id, epic, title: `${epic} Procedure ${id}`, purpose: `Implements a focused data operation for ${epic.toLowerCase()} domain ensuring single responsibility and set-based efficiency.`, inputs: [`@BatchId (INT)`, '@CorrelationId (UNIQUEIDENTIFIER)', '@AsOfDate (DATE)'], outputs: [`Result set with domain columns for ${epic.toLowerCase()}`], rules: [`Return only active records relevant to ${epic.toLowerCase()} context`, `Enforce idempotent re-execution (no duplicates)`, `Use set-based operations (no RBAR)`], edgeCases: ['No rows → still return schema with zero rows', 'Null optional filters → treat as wildcard', 'High volume batch path (>1M rows) performance'], performance: ['Must complete < 2s on median dataset', 'Covering index leveraged for primary filter', 'Avoid temp table spills (monitor writes)'], security: ['Least privilege: execute via dbo wrapper role', 'No dynamic SQL construction', 'No PII beyond approved columns'], dependencies: ['Tables: TBD_' + epic + '_1, TBD_COMMON_REF', 'Other SPs: none'], tags: [epic, 'StoredProcedure', 'DataContract'] });
                            }
                            return items;
                        };
                        let cursor = 1; window.spStories = []; Object.entries(distribution).forEach(([epic, count]) => { const items = generateItems(epic, count, cursor); cursor += count; window.spStories.push(...items); });
                        function cardMarkup(sp) {
                            return `<div class="panel" data-epic="${sp.epic}" data-id="${sp.id}" style="padding:.8rem .9rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.6rem;">
                    <span class="pill" style="background:var(--accent);color:#fff;">${sp.id}</span>
                    <div style="display:flex;gap:.35rem;flex-wrap:wrap;">${sp.tags.map(t => `<span class=tag>${t}</span>`).join('')}</div>
                </div>
                <h4 style="margin:.5rem 0 .4rem;font-size:.75rem;">${sp.title}</h4>
                <p style="margin:.2rem 0 .6rem;font-size:.6rem;opacity:.85;">${sp.purpose}</p>
                ${section('Inputs', list(sp.inputs))}
                ${section('Outputs', list(sp.outputs))}
                ${section('Business Rules', list(sp.rules))}
                ${section('Edge Cases', list(sp.edgeCases))}
                ${section('Performance', list(sp.performance))}
                ${section('Security', list(sp.security))}
                ${section('Dependencies', list(sp.dependencies))}
            </div>`;
                        }
                        function list(arr) { return `<ul class="list-tight" style="margin:.15rem 0 .4rem;">${arr.map(i => `<li>${escapeHtml(i)}</li>`).join('')}</ul>`; }
                        function section(title, body) { return `<details style="margin:.3rem 0;"><summary style="cursor:pointer;font-weight:600;font-size:.6rem;letter-spacing:.5px;">${title}</summary>${body}</details>`; }
                        function render(filter = {}) {
                            const { q = '', epics = [] } = filter; const ql = q.toLowerCase();
                            container.innerHTML = '';
                            const frags = document.createDocumentFragment();
                            window.spStories.forEach(sp => {
                                if (epics.length && !epics.includes(sp.epic)) return;
                                if (ql) { const hay = (sp.id + sp.epic + sp.title + sp.purpose + sp.rules.join() + sp.inputs.join()).toLowerCase(); if (!hay.includes(ql)) return; }
                                const div = document.createElement('div'); div.innerHTML = cardMarkup(sp); frags.appendChild(div.firstChild);
                            });
                            if (!frags.childNodes.length) { const empty = document.createElement('div'); empty.className = 'note'; empty.textContent = 'No stored procedure stories match current filter.'; container.appendChild(empty); }
                            else container.appendChild(frags);
                            // Populate static catalog once (unfiltered) if present
                            const staticGrid = document.getElementById('spStaticGrid');
                            if (staticGrid && !staticGrid.dataset.filled) {
                                const frag = document.createDocumentFragment();
                                [...window.spStories].sort((a, b) => a.id.localeCompare(b.id)).forEach(sp => {
                                    const wrap = document.createElement('div'); wrap.className = 'panel'; wrap.style.padding = '.6rem .7rem'; wrap.innerHTML = `<strong>${sp.id} ${escapeHtml(sp.title)}</strong><div style='margin:.25rem 0 .4rem;font-size:.58rem;opacity:.85;'>${escapeHtml(sp.purpose)}</div>
                        <div style='display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:.4rem;'>${sp.tags.map(t => `<span class=tag>${t}</span>`).join('')}</div>
                        <div style='font-size:.55rem;line-height:1.35;'>
                        <strong>Inputs:</strong> ${sp.inputs.map(i => escapeHtml(i)).join('; ')}<br/>
                        <strong>Outputs:</strong> ${sp.outputs.map(i => escapeHtml(i)).join('; ')}<br/>
                        <strong>Rules:</strong> ${sp.rules.map(i => escapeHtml(i)).join('; ')}<br/>
                        <strong>Edge:</strong> ${sp.edgeCases.map(i => escapeHtml(i)).join('; ')}<br/>
                        <strong>Performance:</strong> ${sp.performance.map(i => escapeHtml(i)).join('; ')}<br/>
                        <strong>Security:</strong> ${sp.security.map(i => escapeHtml(i)).join('; ')}<br/>
                        <strong>Dependencies:</strong> ${sp.dependencies.map(i => escapeHtml(i)).join('; ')}
                        </div>`; frag.appendChild(wrap);
                                });
                                staticGrid.appendChild(frag); staticGrid.dataset.filled = '1';
                            }
                        }
                        // Toolbar actions
                        const spExpandAllBtn = document.getElementById('spExpandAllBtn');
                        const spCollapseAllBtn = document.getElementById('spCollapseAllBtn');
                        const spExportJsonBtn = document.getElementById('spExportJsonBtn');
                        const spExportCsvBtn = document.getElementById('spExportCsvBtn');
                        function currentFilter() { const groupBar = document.getElementById('spGroupFilters'); const epics = [...groupBar.querySelectorAll('.chip.active')].map(c => c.dataset.epic); const q = (document.getElementById('spSearch') || {}).value || ''; return { epics, q }; }
                        function filteredStories() { const { epics, q } = currentFilter(); const ql = q.toLowerCase(); return window.spStories.filter(sp => { if (epics.length && !epics.includes(sp.epic)) return false; if (ql) { const hay = (sp.id + sp.epic + sp.title + sp.purpose + sp.rules.join()).toLowerCase(); if (!hay.includes(ql)) return false; } return true; }); }
                        spExpandAllBtn?.addEventListener('click', () => { document.querySelectorAll('#spDetailsContainer details').forEach(d => d.open = true); toast('All SP sections expanded'); });
                        spCollapseAllBtn?.addEventListener('click', () => { document.querySelectorAll('#spDetailsContainer details').forEach(d => d.open = false); toast('All SP sections collapsed'); });
                        spExportJsonBtn?.addEventListener('click', () => { const data = filteredStories(); const out = { exported: new Date().toISOString(), count: data.length, stories: data }; const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sp-visible-stories.json'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 400); toast(`Exported ${data.length} SP stories (JSON)`); });
                        spExportCsvBtn?.addEventListener('click', () => { const data = filteredStories(); const header = ['ID', 'Epic', 'Title', 'Inputs', 'Outputs', 'Rules', 'EdgeCases']; const rows = data.map(sp => [sp.id, sp.epic, `"${sp.title.replace(/"/g, '""')}"`, `"${sp.inputs.join(';').replace(/"/g, '""')}"`, `"${sp.outputs.join(';').replace(/"/g, '""')}"`, `"${sp.rules.join(';').replace(/"/g, '""')}"`, `"${sp.edgeCases.join(';').replace(/"/g, '""')}"`]); const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sp-visible-stories.csv'; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 400); toast(`Exported ${data.length} SP stories (CSV)`); });
                        // Build group (epic) filter chips
                        const groupBar = document.getElementById('spGroupFilters');
                        if (groupBar) { Object.keys(distribution).forEach(epic => { const btn = document.createElement('button'); btn.className = 'chip'; btn.textContent = epic; btn.dataset.epic = epic; btn.onclick = () => { btn.classList.toggle('active'); applyFilters(); }; groupBar.appendChild(btn); }); }
                        const spSearch = document.getElementById('spSearch');
                        spSearch?.addEventListener('input', debounce(applyFilters, 250));
                        function applyFilters() { const epics = [...groupBar.querySelectorAll('.chip.active')].map(c => c.dataset.epic); const q = spSearch ? spSearch.value.trim() : ''; render({ q, epics }); }
                        render();
                    })();

                    // Tests
                    // Test metrics table (will also be updated after parsing full tests)
                    function renderTestMetrics() {
                        const tbody = document.querySelector('#testMetricsTable tbody');
                        tbody.innerHTML = '';
                        const rows = [
                            { cat: 'Functional', count: 25, focus: 'Service + business logic' },
                            { cat: 'Stored Procedure', count: 86, focus: 'Data contract & reconciliation' },
                            { cat: 'Total', count: 111, focus: 'Traceable coverage' }
                        ];
                        rows.forEach(t => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${t.cat}</td><td>${t.count}</td><td>${t.focus}</td>`; tbody.appendChild(tr); });
                    }
                    renderTestMetrics();

                    // Glossary
                    const glossary = [
                        ['Allocation', 'Process selecting tasks for generator / distributor services'],
                        ['CorrelationId', 'Identifier linking all events of a schedule batch'],
                        ['CausationId', 'Event that directly triggered the current event'],
                        ['Idempotent', 'Operation safe to replay without side effects'],
                        ['Checksum', 'Aggregate metric set validating data integrity'],
                        ['Reconciliation', 'Comparison of expected vs actual transactional totals'],
                        ['Replay', 'Reprocessing events from a persisted log'],
                        ['Variance', 'Mismatch discovered during reconciliation'],
                        ['Patch (ADO)', 'JSON patch array for Azure DevOps work item import'],
                        ['SP Story', 'User story describing a stored procedure contract']
                    ];
                    const glossaryBody = document.getElementById('glossaryBody');
                    glossary.forEach(([t, d]) => { const tr = document.createElement('tr'); tr.innerHTML = `<td style="white-space:nowrap;"><strong>${t}</strong></td><td>${escapeHtml(d)}</td>`; glossaryBody.appendChild(tr); });

                    // Traceability sample (subset mapping)
                    const traceRows = [
                        { story: 'US-016', sps: ['SP-019', 'SP-020', 'SP-023'], tests: ['TC-US-016', 'TC-SP-019'], events: ['FileGenerationCompleted'] },
                        { story: 'US-023', sps: ['SP-062', 'SP-067'], tests: ['TC-US-023', 'TC-SP-062'], events: ['FileDistributionSucceeded'] },
                        { story: 'US-029', sps: ['SP-072', 'SP-073'], tests: ['TC-US-029', 'TC-SP-072'], events: ['ArchiveCreated'] },
                        { story: 'US-031', sps: ['SP-073', 'SP-075'], tests: ['TC-US-031', 'TC-SP-075'], events: ['EmailNotificationSent'] },
                        { story: 'US-012', sps: ['SP-001', 'SP-003', 'SP-004'], tests: ['TC-US-012', 'TC-SP-001'], events: ['GenerationTaskAllocated'] }
                    ];
                    const traceBody = document.querySelector('#traceTable tbody');
                    traceRows.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td><code>${r.story}</code></td><td>${r.sps.map(sp => `<span class=tag>${sp}</span>`).join('')}</td><td>${r.tests.map(tc => `<span class=tag>${tc}</span>`).join('')}</td><td>${r.events.map(ev => `<span class="pill">${ev}</span>`).join('')}</td>`; traceBody.appendChild(tr); });

                    // Filtering / search for event backlog
                    const eventFilterHost = document.getElementById('eventBacklogFilters');
                    const allEventTags = [...new Set(functionalStories.flatMap(s => [...s.produces, ...s.consumes]))].sort();
                    allEventTags.forEach(ev => { const btn = document.createElement('button'); btn.className = 'chip'; btn.textContent = ev; btn.dataset.event = ev; btn.onclick = () => { btn.classList.toggle('active'); applyEventBacklogFilters(); }; eventFilterHost.appendChild(btn); });
                    const eventSearch = document.getElementById('eventBacklogSearch');
                    eventSearch.addEventListener('input', debounce(applyEventBacklogFilters, 180));
                    function applyEventBacklogFilters() {
                        const active = [...eventFilterHost.querySelectorAll('.chip.active')].map(b => b.dataset.event);
                        const q = eventSearch.value.trim().toLowerCase();
                        [...evTableBody.querySelectorAll('tr')].forEach(tr => {
                            const id = tr.children[0].textContent; const story = functionalStories.find(s => s.id === id); let ok = true;
                            if (active.length && !active.every(a => story.produces.includes(a) || story.consumes.includes(a))) ok = false;
                            if (q) { const hay = (story.id + story.title + story.produces.join() + story.consumes.join()).toLowerCase(); if (!hay.includes(q)) ok = false; }
                            tr.style.display = ok ? '' : 'none';
                        });
                    }

                    // Functional backlog filters
                    // Attach JSON export handler (now safe; elements declared earlier)
                    exportVisibleStoriesBtn?.addEventListener('click', () => {
                        try {
                            console.debug('[ExportJSON] starting handler');
                            if (!window.functionalStories || !Array.isArray(functionalStories)) { toast('Stories dataset missing'); return; }
                            if (!functionalTagFilters) console.warn('[ExportJSON] tag filters element missing');
                            const activeTags = [...functionalTagFilters.querySelectorAll('.chip.active')].map(b => b.dataset.tag);
                            const q = functionalSearch?.value.trim().toLowerCase() || '';
                            const filtered = functionalStories.filter(s => {
                                if (activeTags.length && !activeTags.every(t => s.tags.includes(t))) return false;
                                if (q) { const hay = (s.id + s.title + s.description + s.tags.join() + s.acceptance.join()).toLowerCase(); if (!hay.includes(q)) return false; }
                                return true;
                            });
                            console.debug('[ExportJSON] filter', { activeTags, q, count: filtered.length });
                            const out = { exported: new Date().toISOString(), filter: { q, activeTags }, count: filtered.length, stories: filtered };
                            const jsonStr = JSON.stringify(out, null, 2);
                            const blob = new Blob([jsonStr], { type: 'application/json' });
                            // Fallback for old Edge/IE
                            if (window.navigator && window.navigator.msSaveOrOpenBlob) { window.navigator.msSaveOrOpenBlob(blob, 'functional-visible-stories.json'); toast(`Exported ${filtered.length} stories (msSaveBlob)`); return; }
                            let a = document.createElement('a');
                            const url = URL.createObjectURL(blob);
                            a.href = url; a.download = 'functional-visible-stories.json'; a.style.display = 'none'; document.body.appendChild(a);
                            // Some Chrome extensions block direct a.click(); use dispatchEvent fallback
                            const clickEvt = new MouseEvent('click', { view: window, bubbles: true, cancelable: true });
                            const clicked = a.dispatchEvent(clickEvt);
                            if (!clicked) { a.click(); }
                            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1200);
                            toast(`Exported ${filtered.length} visible stories`);
                            // Provide inline fallback if download blocked
                            setTimeout(() => {
                                if (!document.getElementById('exportJsonFallback') && (!clicked || filtered.length === 0)) {
                                    const ta = document.createElement('textarea');
                                    ta.id = 'exportJsonFallback'; ta.style.width = '100%'; ta.style.height = '180px'; ta.style.marginTop = '1rem'; ta.value = jsonStr; ta.readOnly = true;
                                    exportVisibleStoriesBtn.insertAdjacentElement('afterend', ta);
                                    const note = document.createElement('div'); note.style.fontSize = '.6rem'; note.style.margin = '.25rem 0 0'; note.textContent = 'Fallback: copy JSON above manually (auto-download was blocked).';
                                    ta.insertAdjacentElement('afterend', note);
                                }
                            }, 800);
                        } catch (err) { console.error(err); toast('Export failed'); }
                        persistState();
                    });
                    function applyFunctionalFilters() {
                        const active = [...functionalTagFilters.querySelectorAll('.chip.active')].map(b => b.dataset.tag);
                        const q = functionalSearch ? functionalSearch.value.trim().toLowerCase() : '';
                        [...fBody.querySelectorAll('tr')].forEach(tr => {
                            const id = tr.children[0].textContent.replace(/`/g, '');
                            const story = functionalStories.find(s => s.id === id);
                            let ok = true;
                            if (active.length && !active.every(a => story.tags.includes(a))) ok = false;
                            if (q) { const hay = (story.id + story.title + story.description + story.tags.join() + story.acceptance.join()).toLowerCase(); if (!hay.includes(q)) ok = false; }
                            tr.style.display = ok ? '' : 'none';
                        });
                        // If card view open, update card visibility without full rebuild.
                        if (functionalCardsHost && functionalCardsHost.style.display !== 'none') {
                            // build if empty (first open after filter change) else filter existing
                            if (!functionalCardsHost.children.length) buildFunctionalCards();
                            [...functionalCardsHost.children].forEach(card => {
                                const id = card.querySelector('span').textContent; // first badge holds ID
                                const story = functionalStories.find(s => s.id === id);
                                if (!story) return;
                                let ok = true;
                                if (active.length && !active.every(a => story.tags.includes(a))) ok = false;
                                if (q) { const hay = (story.id + story.title + story.description + story.tags.join() + story.acceptance.join()).toLowerCase(); if (!hay.includes(q)) ok = false; }
                                card.style.display = ok ? '' : 'none';
                            });
                        }
                    }

                    // Copy patch buttons global
                    document.body.addEventListener('click', e => {
                        const btn = e.target.closest('button.copy-btn'); if (!btn) return; const storyId = btn.dataset.story; const kind = btn.dataset.kind; const story = functionalStories.find(s => s.id === storyId); if (!story) return;
                        let text = '';
                        if (kind === 'patch') text = JSON.stringify(story.patch, null, 2); else if (kind === 'patch-full') text = JSON.stringify(story.patch, null, 2); else return;
                        navigator.clipboard.writeText(text).then(() => toast(`Copied patch for ${storyId}`));
                    });

                    // Exports
                    document.getElementById('exportEventsBtn').onclick = () => {
                        downloadJSON(eventCatalog, 'emedia-event-catalog.json');
                    };
                    document.getElementById('exportFullPatchesBtn').onclick = () => {
                        downloadJSON(functionalStories.map(s => ({ id: s.id, patch: s.patch })), 'emedia-functional-patches.json');
                    };
                    document.getElementById('exportTraceBtn').onclick = () => {
                        const fullTrace = functionalStories.map(s => ({ id: s.id, produces: s.produces, consumes: s.consumes }));
                        downloadJSON(fullTrace, 'emedia-traceability.json');
                    };
                    function downloadJSON(obj, name) { const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); setTimeout(() => URL.revokeObjectURL(a.href), 500); }

                    // TOC build
                    const tocList = document.getElementById('tocList');
                    const sections = [...document.querySelectorAll('.doc-section')];
                    sections.forEach(sec => { const id = sec.id; const title = sec.querySelector('h2').innerText.replace(/^\d+\s*/, ''); const a = document.createElement('a'); a.href = '#' + id; a.textContent = sec.querySelector('h2').textContent; tocList.appendChild(a); });
                    const observer = new IntersectionObserver(entries => {
                        entries.forEach(en => { if (en.isIntersecting) { const id = en.target.id; tocList.querySelectorAll('a').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + id)); } });
                    }, { root: null, rootMargin: '0px 0px -70% 0px', threshold: 0 });
                    sections.forEach(sec => observer.observe(sec));

                    // Business stories rendering helpers
                    function parseBusinessMarkdown(md) {
                        const groups = []; let current = null; const lines = md.split(/\r?\n/);
                        for (const line of lines) {
                            if (/^##\s+\d+\./.test(line)) { if (current) groups.push(current); current = { title: line.replace(/^##\s+/, '').trim(), body: [] }; continue; }
                            if (current) current.body.push(line);
                        }
                        if (current) groups.push(current);
                        return groups.map(g => ({ title: g.title, html: marked.parse(g.body.join('\n')) }));
                    }
                    function renderBusinessStories() {
                        const rawEl = document.getElementById('business-user-stories-raw'); if (!rawEl) return;
                        const container = document.getElementById('businessStoriesContent'); if (!container) return;
                        const parsed = parseBusinessMarkdown(rawEl.textContent);
                        container.innerHTML = parsed.map(p => `<details><summary>${p.title}</summary><div>${p.html}</div></details>`).join('');
                    }
                    function initBusinessStories() {
                        const exportBtn = document.getElementById('exportBusinessStoriesBtn');
                        if (exportBtn) {
                            exportBtn.addEventListener('click', () => {
                                const raw = document.getElementById('business-user-stories-raw').textContent;
                                const blob = new Blob([JSON.stringify({ source: 'business-user-stories.md', raw }, null, 2)], { type: 'application/json' });
                                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'business-stories.json'; a.click();
                                toast('Exported business stories');
                            });
                        }
                        renderBusinessStories();
                    }

                    initBusinessStories();

                    // Theme toggle
                    const themeBtn = document.getElementById('toggleThemeBtn');
                    function setTheme(t) { document.documentElement.dataset.theme = t; localStorage.setItem('emediaDocTheme', t); themeBtn.textContent = t === 'dark' ? 'Light Mode' : 'Toggle Dark'; }
                    setTheme(localStorage.getItem('emediaDocTheme') || 'light');
                    themeBtn.onclick = () => setTheme(document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark');

                    // Expand / Collapse helpers (details)
                    document.getElementById('expandAllBtn').onclick = () => { document.querySelectorAll('details').forEach(d => d.open = true); toast('Expanded all details'); };
                    document.getElementById('collapseAllBtn').onclick = () => { document.querySelectorAll('details').forEach(d => d.open = false); toast('Collapsed all details'); };

                    // Utilities
                    function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c])); }
                    function renderTags(arr, cls) { if (!arr.length) return '<span class="emptystate">—</span>'; return arr.map(a => `<span class="pill ${cls || ''}" style="margin:2px 4px 2px 0;">${a}</span>`).join(''); }
                    function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

                    // Timestamp
                    document.getElementById('generatedStamp').textContent = new Date().toISOString();

                    // TOC toggle (mobile)
                    const tocToggle = document.getElementById('tocToggle'); const toc = document.getElementById('toc');
                    tocToggle.onclick = () => toc.classList.toggle('open');

                    /* =====================
                       FULL SP & TEST PARSING
                       ===================== */
                    const rawSpMdEl = document.getElementById('raw-sp-markdown');
                    const rawTestMdEl = document.getElementById('raw-test-markdown');
                    // business capability raw markdown loaded from separate hidden script tag
                    // (Removed stray CSS that was incorrectly placed here)
                }
                    // Removed stray '.features-list li:before' CSS
                    // Removed unintended duplicate HTML fragment (container, nav, etc.)

                    // Removed further duplicate sections (database integration, integrations, sql analysis, deployment, analysis documents, analysis templates)

                    // Removed remaining duplicate analysis template cards, process list, footer, and extra closing tags
                    // End of main runtime script logic

                    // Smooth scroll fallback (ensures consistent behavior in browsers ignoring CSS scroll-behavior)
                    (function () {
                        var supportsSmooth = 'scrollBehavior' in document.documentElement.style;
                        if (supportsSmooth) return; // native handles it
                        document.querySelectorAll('a[href^="#"]').forEach(function (a) {
                            a.addEventListener('click', function (e) {
                                var id = this.getAttribute('href');
                                if (id.length > 1) {
                                    var target = document.getElementById(id.substring(1));
                                    if (target) {
                                        e.preventDefault();
                                        // simple JS animation
                                        var start = window.pageYOffset;
                                        var top = target.getBoundingClientRect().top + window.pageYOffset - 70; // account for margin offset
                                        var distance = top - start;
                                        var duration = 450; var t0 = null;
                                        function step(ts) { if (!t0) t0 = ts; var p = Math.min(1, (ts - t0) / duration); var ease = .5 * (1 - Math.cos(Math.PI * p)); window.scrollTo(0, start + distance * ease); if (p < 1) requestAnimationFrame(step); else history.pushState(null, '', id); }
                                        requestAnimationFrame(step);
                                    }
                                }
                            });
                        });
                    })();
            </script>
</body>

</html>